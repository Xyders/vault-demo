

ssh -i ./sample-key-001.pem r-user@172.18.1.103


export VAULT_URL="https://releases.hashicorp.com/vault" VAULT_VERSION="1.3.2"
curl --silent --remote-name "${VAULT_URL}/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip"
curl --silent --remote-name "${VAULT_URL}/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_SHA256SUMS"
curl --silent --remote-name "${VAULT_URL}/${VAULT_VERSION}/${VAULT_VERSION}/vault_${VAULT_VERSION}_SHA256SUMS.sig"


[r-user@v1 ~]$ ll
total 46608
-rw-rw-r-- 1 r-user r-user 47715706 Feb 25 11:10 vault_1.3.2_linux_amd64.zip
-rw-rw-r-- 1 r-user r-user      303 Feb 25 11:10 vault_1.3.2_SHA256SUMS
-rw-rw-r-- 1 r-user r-user      303 Feb 25 11:10 vault_1.3.2_SHA256SUMS.sig
[r-user@v1 ~]$
[r-user@v1 ~]$ unzip vault_1.3.2_linux_amd64.zip
Archive:  vault_1.3.2_linux_amd64.zip
  inflating: vault
[r-user@v1 ~]$ ll
total 175792
-rwxrwxr-x 1 r-user r-user 132281647 Jan 22 10:50 vault
-rw-rw-r-- 1 r-user r-user  47715706 Feb 25 11:10 vault_1.3.2_linux_amd64.zip
-rw-rw-r-- 1 r-user r-user       303 Feb 25 11:10 vault_1.3.2_SHA256SUMS
-rw-rw-r-- 1 r-user r-user       303 Feb 25 11:10 vault_1.3.2_SHA256SUMS.sig
[r-user@v1 ~]$ sudo chown root:root vault
[r-user@v1 ~]$
[r-user@v1 ~]$ ll
total 175792
-rwxrwxr-x 1 root   root   132281647 Jan 22 10:50 vault
-rw-rw-r-- 1 r-user r-user  47715706 Feb 25 11:10 vault_1.3.2_linux_amd64.zip
-rw-rw-r-- 1 r-user r-user       303 Feb 25 11:10 vault_1.3.2_SHA256SUMS
-rw-rw-r-- 1 r-user r-user       303 Feb 25 11:10 vault_1.3.2_SHA256SUMS.sig
[r-user@v1 ~]$
[r-user@v1 ~]$ sudo mv vault /usr/local/bin
[r-user@v1 ~]$
[r-user@v1 ~]$ vault version
Vault v1.3.2
[r-user@v1 ~]$
[r-user@v1 ~]$ vault -autocomplete-install
[r-user@v1 ~]$ complete -C /usr/local/bin/vault vault
[r-user@v1 ~]$
不用root也可以使用mlock syscall。mlock可以防止swap。
[r-user@v1 ~]$ sudo setcap cap_ipc_lock=+ep /usr/local/bin/vault
[r-user@v1 ~]$
创建唯一的，non-privileged用户使用vault
[r-user@v1 ~]$ sudo useradd --system --home /etc/vault.d --shell /bin/false vault
[r-user@v1 ~]$
[r-user@v1 ~]$
非缺省值必须在systemd的配置文件中设定
[r-user@v1 ~]$ sudo touch /etc/systemd/system/vault.service
[r-user@v1 ~]$
[r-user@v1 ~]$ sudo vi /etc/systemd/system/vault.service
[r-user@v1 ~]$
[r-user@v1 ~]$ cat  /etc/systemd/system/vault.service
[Unit]
Description="HashiCorp Vault - A tool for managing secrets"
Documentation=https://www.vaultproject.io/docs/
Requires=network-online.target
After=network-online.target
ConditionFileNotEmpty=/etc/vault.d/vault.hcl
StartLimitIntervalSec=60
StartLimitBurst=3

[Service]
User=vault
Group=vault
ProtectSystem=full
ProtectHome=read-only
PrivateTmp=yes
PrivateDevices=yes
SecureBits=keep-caps
AmbientCapabilities=CAP_IPC_LOCK
Capabilities=CAP_IPC_LOCK+ep
CapabilityBoundingSet=CAP_SYSLOG CAP_IPC_LOCK
NoNewPrivileges=yes
ExecStart=/usr/local/bin/vault server -config=/etc/vault.d/vault.hcl
ExecReload=/bin/kill --signal HUP $MAINPID
KillMode=process
KillSignal=SIGINT
Restart=on-failure
RestartSec=5
TimeoutStopSec=30
StartLimitInterval=60
StartLimitIntervalSec=60
StartLimitBurst=3
LimitNOFILE=65536
LimitMEMLOCK=infinity

[Install]
WantedBy=multi-user.target

■　在Consul上配置好vault token：
758114be-5324-114b-39b1-12051c2abbfe
之后执行下面的内容：

■ 创建configuration文件
注意address部分用的是common name，因为certificate没有加入SAN(Subject Alternative Names)所以会发生如下X509错误所致。
Error querying agent: Get https://172.18.1.102:8501/v1/agent/self: x509: certificate is valid for 127.0.0.1, not 172.18.1.102
这个应该是consul tls ca create命令出了问题。
workaround之一是修改/etc/hosts文件，加入： 172.18.1.102 server.dc1.consul
然后不使用IP而是用上面这个CN来指向IP。
注意要确保/etc/nsswitch.conf文件中hosts访问设定以file在dns前面。

sudo mkdir --parents /etc/vault.d
sudo touch /etc/vault.d/vault.hcl
sudo chown --recursive vault:vault /etc/vault.d
sudo chmod 640 /etc/vault.d/vault.hcl

sudo vi /etc/vault.d/vault.hcl
sudo cat /etc/vault.d/vault.hcl

api_addr = "https://172.18.1.104:8200"
cluster_addr = "https://172.18.1.104:8201"

listener "tcp" {
  address       = "127.0.0.1:8200"
  tls_disable = 1
}

listener "tcp" {
#  address = "172.18.1.102:8501"
  address = "server.dc1.consul:8501"
  tls_cert_file = "/etc/vault.d/dc1-server-consul-3.pem"
  tls_key_file  = "/etc/vault.d/dc1-server-consul-3-key.pem"
  tls_client_ca_file = "/etc/vault.d/consul-agent-ca.pem"
  tls_disable_client_certs = "true"
}

storage "consul" {
  address = "172.18.1.102:8501"
  path = "vault/"
  token = "758114be-5324-114b-39b1-12051c2abbfe"
  tls_ca_file =  "/etc/consul.d/consul-agent-ca.pem"
  tls_cert_file = "/etc/consul.d/dc1-server-consul-2.pem"
  tls_key_file  = "/etc/consul.d/dc1-server-consul-2-key.pem"
}

ui = true
log_level = "Debug"





[r-user@v1 ~]$ sudo /usr/local/bin/vault policy fmt /etc/vault.d/vault.hcl
failed to parse policy: 4 errors occurred:
        * invalid key "listener" on line 0
        * invalid key "listener" on line 0
        * invalid key "storage" on line 0
        * invalid key "ui" on line 20



[r-user@v1 ~]$ sudo systemctl enable vault
Created symlink from /etc/systemd/system/multi-user.target.wants/vault.service to /etc/systemd/system/vault.service.
[r-user@v1 ~]$ sudo systemctl start vault
[r-user@v1 ~]$ sudo systemctl status vault -l
● vault.service - "HashiCorp Vault - A tool for managing secrets"
   Loaded: loaded (/etc/systemd/system/vault.service; enabled; vendor preset: disabled)
   Active: active (running) since Mon 2020-03-02 15:14:57 JST; 5s ago
     Docs: https://www.vaultproject.io/docs/
 Main PID: 4974 (vault)
   CGroup: /system.slice/vault.service
           └─4974 /usr/local/bin/vault server -config=/etc/vault.d/vault.hcl

Mar 02 15:14:57 c-test systemd[1]: Started "HashiCorp Vault - A tool for managing secrets".
Mar 02 15:14:57 c-test vault[4974]: WARNING! Unable to read storage migration status.
Mar 02 15:14:57 c-test vault[4974]: 2020-03-02T15:14:57.640+0900 [INFO]  proxy environment: http_proxy= https_proxy= no_proxy=
Mar 02 15:14:57 c-test vault[4974]: 2020-03-02T15:14:57.641+0900 [WARN]  storage migration check error: error="Get http://172.18.1.102:8500/v1/kv/vault/core/migration: dial tcp 172.18.1.102:8500: connect: connection refused"
Mar 02 15:14:59 c-test vault[4974]: 2020-03-02T15:14:59.642+0900 [WARN]  storage migration check error: error="Get http://172.18.1.102:8500/v1/kv/vault/core/migration: dial tcp 172.18.1.102:8500: connect: connection refused"
Mar 02 15:15:01 c-test vault[4974]: 2020-03-02T15:15:01.644+0900 [WARN]  storage migration check error: error="Get http://172.18.1.102:8500/v1/kv/vault/core/migration: dial tcp 172.18.1.102:8500: connect: connection refused"


此时是有问题的：
[r-user@c-test ~]$ vault status -address="http://127.0.0.1:8200"
Error checking seal status: Get http://127.0.0.1:8200/v1/sys/seal-status: dial tcp 127.0.0.1:8200: connect: connection refused


■ 需要troubleshooting的时候
Assuming your Vault service is named vault：
journalctl -b --no-pager -u vault

和journalctl -xe的效果差不多

将log进行打包
journalctl -b --no-pager -u vault | gzip -9 > /tmp/"$(hostname)-$(date +%Y-%m-%dT%H-%M-%SZ)-vault.log.gz"
生成例如如下的文件：
/tmp/ip-10-42-0-27-2018-10-15T17:06:49Z-vault.log.gz

存放log的地点在systemd中定义，查找/etc/systemd/system/vault.service文件。
在类似于下面的地方：
...
[Service]
...
ExecStart=/bin/sh -c '/home/vagrant/bin/vault server -config=/home/vagrant/vault_nano/config/vault -log-level="trace" > /var/log/vault.log
...
那么log应该会在静态地址/var/log/vault.log里面。



■ 搞定TLS后端连接的问题之后
[r-user@c-test ~]$ sudo systemctl status vault -l
● vault.service - "HashiCorp Vault - A tool for managing secrets"
   Loaded: loaded (/etc/systemd/system/vault.service; enabled; vendor preset: disabled)
   Active: active (running) since Tue 2020-03-03 12:31:15 JST; 27min ago
     Docs: https://www.vaultproject.io/docs/
 Main PID: 8723 (vault)
   CGroup: /system.slice/vault.service
           └─8723 /usr/local/bin/vault server -config=/etc/vault.d/vault.hcl

Mar 03 12:31:15 c-test vault[8723]: 2020-03-03T12:31:15.643+0900 [DEBUG] storage.consul: config service_tags set: service_tags=
Mar 03 12:31:15 c-test vault[8723]: 2020-03-03T12:31:15.643+0900 [DEBUG] storage.consul: config service_address set: service_address=<nil>
Mar 03 12:31:15 c-test vault[8723]: 2020-03-03T12:31:15.643+0900 [DEBUG] storage.consul: config address set: address=server.dc1.consul:8501
Mar 03 12:31:15 c-test vault[8723]: 2020-03-03T12:31:15.643+0900 [DEBUG] storage.consul: config scheme set: scheme=https
Mar 03 12:31:15 c-test vault[8723]: 2020-03-03T12:31:15.643+0900 [DEBUG] storage.consul: config token set
Mar 03 12:31:15 c-test vault[8723]: 2020-03-03T12:31:15.667+0900 [DEBUG] storage.consul: configured TLS
Mar 03 12:31:15 c-test vault[8723]: 2020-03-03T12:31:15.679+0900 [WARN]  no `api_addr` value specified in config or in VAULT_API_ADDR; falling back to detection if possible, but this value should be manually set
Mar 03 12:31:15 c-test vault[8723]: 2020-03-03T12:31:15.686+0900 [DEBUG] storage.cache: creating LRU cache: size=0
Mar 03 12:31:15 c-test vault[8723]: 2020-03-03T12:31:15.779+0900 [DEBUG] cluster listener addresses synthesized: cluster_addresses=[127.0.0.1:8201, 172.18.1.104:8202]
Mar 03 12:58:04 c-test vault[8723]: 2020-03-03T12:58:04.388+0900 [INFO]  core: seal configuration missing, not initialized


修改vault.hcl如下：
listener "tcp" {
  address     = "127.0.0.1:8200"
  tls_disable = 1
}

listener "tcp" {
  address       = "172.18.1.104:8201"
  tls_cert_file = "/etc/vault.d/dc1-server-consul-3.pem"
  tls_key_file  = "/etc/vault.d/dc1-server-consul-3-key.pem"
  tls_client_ca_file = "/etc/vault.d/consul-agent-ca.pem"
  tls_disable_client_certs = "true"
}

storage "consul" {
#  address = "172.18.1.102:8501"
  address = "server.dc1.consul:8501"
  scheme = "https"
  path = "vault/"
  token = "758114be-5324-114b-39b1-12051c2abbfe"
  tls_ca_file =  "/etc/consul.d/consul-agent-ca.pem"
  tls_cert_file = "/etc/vault.d/dc1-client-consul-1.pem"
  tls_key_file  = "/etc/vault.d/dc1-client-consul-1-key.pem"
}
api_addr = "http://172.18.1.104:8200"
cluster_addr = "https://172.18.1.104:8201"

ui = true
log_level = "Debug"


[r-user@c-test ~]$ sudo systemctl status vault -l
● vault.service - "HashiCorp Vault - A tool for managing secrets"
   Loaded: loaded (/etc/systemd/system/vault.service; enabled; vendor preset: disabled)
   Active: active (running) since Tue 2020-03-03 13:37:02 JST; 2s ago
     Docs: https://www.vaultproject.io/docs/
 Main PID: 9169 (vault)
   CGroup: /system.slice/vault.service
           └─9169 /usr/local/bin/vault server -config=/etc/vault.d/vault.hcl

Mar 03 13:37:03 c-test vault[9169]: 2020-03-03T13:37:02.931+0900 [DEBUG] storage.consul: config disable_registration set: disable_registration=false
Mar 03 13:37:03 c-test vault[9169]: 2020-03-03T13:37:02.931+0900 [DEBUG] storage.consul: config service set: service=vault
Mar 03 13:37:03 c-test vault[9169]: 2020-03-03T13:37:02.931+0900 [DEBUG] storage.consul: config service_tags set: service_tags=
Mar 03 13:37:03 c-test vault[9169]: 2020-03-03T13:37:02.931+0900 [DEBUG] storage.consul: config service_address set: service_address=<nil>
Mar 03 13:37:03 c-test vault[9169]: 2020-03-03T13:37:02.931+0900 [DEBUG] storage.consul: config address set: address=server.dc1.consul:8501
Mar 03 13:37:03 c-test vault[9169]: 2020-03-03T13:37:02.931+0900 [DEBUG] storage.consul: config scheme set: scheme=https
Mar 03 13:37:03 c-test vault[9169]: 2020-03-03T13:37:02.931+0900 [DEBUG] storage.consul: config token set
Mar 03 13:37:03 c-test vault[9169]: 2020-03-03T13:37:02.945+0900 [DEBUG] storage.consul: configured TLS
Mar 03 13:37:03 c-test vault[9169]: 2020-03-03T13:37:02.957+0900 [DEBUG] storage.cache: creating LRU cache: size=0
Mar 03 13:37:03 c-test vault[9169]: 2020-03-03T13:37:03.049+0900 [DEBUG] cluster listener addresses synthesized: cluster_addresses=[127.0.0.1:8201, 172.18.1.104:8202]


[r-user@c-test ~]$ vault status -address="http://127.0.0.1:8200"
Key                Value
---                -----
Seal Type          shamir
Initialized        false
Sealed             true
Total Shares       0
Threshold          0
Unseal Progress    0/0
Unseal Nonce       n/a
Version            n/a
HA Enabled         true



[r-user@c-test ~]$ vault operator init
Unseal Key 1: vGYOe+xC3/yvHUkxjaO4u8R2j05fZgxk6dr6lv5AHfbi
Unseal Key 2: OGoqt6IuYucMKcbIr8yBdse8HeUi4VarGD4j8V6qOG5a
Unseal Key 3: dP5vG7d2pCO9ROXaUKk8HNcS/Pgpvpu3F8R2+DdaXcJZ
Unseal Key 4: I94/7ZRNQiKkQI3C3a05MFJxcoM3xOm7UFrPPew+gsUF
Unseal Key 5: hNcR2vcMfsQOq5NY1+uu3f2Tizd5k8EcowQyT3BAGFuf

Initial Root Token: s.VP23Tf5pwQkQArG3YQq3lJqS

输入3次：
[r-user@c-test ~]$ vault operator unseal


■　Auto-sealing using Transit Secrets Engine

Vault1用来保护Vault2的master key.

先操作vault1。

sudo mkdir --parents /var/log/vault
sudo touch /var/log/vault/audit.log
sudo chown --recursive vault:vault /var/log/vault

[r-user@c-test ~]$ vault audit enable file file_path=/var/log/vault/audit.log
Success! Enabled the file audit device at: file/
[r-user@c-test ~]$ vault secrets enable transit
Success! Enabled the transit secrets engine at: transit/

创建一个新的key
[r-user@c-test ~]$ vault write -f transit/keys/autounseal
Success! Data written to: transit/keys/autounseal

创建policy
tee autounseal.hcl <<EOF
path "transit/encrypt/autounseal" {
   capabilities = [ "update" ]
}

path "transit/decrypt/autounseal" {
   capabilities = [ "update" ]
}
EOF

[r-user@c-test ~]$ vault policy write autounseal autounseal.hcl
Success! Uploaded policy: autounseal

创建token：
[r-user@c-test ~]$ vault token create -policy="autounseal" -wrap-ttl=120
Key                              Value
---                              -----
wrapping_token:                  s.nCVMUGDEtH3A9r20Js5bHmqw
wrapping_accessor:               YMuTQlvxUx2gthQsX2SXyt4q
wrapping_token_ttl:              2m
wrapping_token_creation_time:    2020-03-03 16:40:22.182471145 +0900 JST
wrapping_token_creation_path:    auth/token/create
wrapped_accessor:                RQKlPzvWOR9a6NxIg1nZoKCo


需要把得到的wrapping_token传给Vault2


然后操作Vault2，为了简便在同一台主机创建，使用不用的端口（8200和8100）。
[r-user@c-test ~]$ VAULT_TOKEN="s.nCVMUGDEtH3A9r20Js5bHmqw" vault unwrap
Key                  Value
---                  -----
token                s.dD1WmybfBE3wPh0WNIKQA96k
token_accessor       RQKlPzvWOR9a6NxIg1nZoKCo
token_duration       768h
token_renewable      true
token_policies       ["autounseal" "default"]
identity_policies    []
policies             ["autounseal" "default"]

重新定义login的token
[r-user@c-test ~]$ export VAULT_TOKEN="s.dD1WmybfBE3wPh0WNIKQA96k"

创建新的configuration文件config-autounseal.hcl：
disable_mlock = true
ui=true

storage "file" {
  path = "/home/r-user/vault-2/data"
}

listener "tcp" {
  address     = "127.0.0.1:8100"
  tls_disable = 1
}

seal "transit" {
  address = "http://127.0.0.1:8200"
  disable_renewal = "false"
  key_name = "autounseal"
  mount_path = "transit/"
  tls_skip_verify = "true"
}

用这个token和配置文件启动一个新的vault instance
[r-user@c-test ~]$ vault server -config=config-autounseal.hcl
==> Vault server configuration:

               Seal Type: transit
         Transit Address: http://127.0.0.1:8200
        Transit Key Name: autounseal
      Transit Mount Path: transit/
                     Cgo: disabled
              Listener 1: tcp (addr: "127.0.0.1:8100", cluster address: "127.0.0.1:8101", max_request_duration: "1m30s", max_request_size: "33554432", tls: "disabled")
               Log Level: info
                   Mlock: supported: true, enabled: false
           Recovery Mode: false
                 Storage: file
                 Version: Vault v1.3.2

==> Vault server started! Log data will stream in below:

2020-03-03T16:45:30.242+0900 [INFO]  proxy environment: http_proxy= https_proxy= no_proxy=
2020-03-03T16:45:30.261+0900 [WARN]  no `api_addr` value specified in config or in VAULT_API_ADDR; falling back to detection if possible, but this value should be manually set
2020-03-03T16:45:30.262+0900 [INFO]  core: stored unseal keys supported, attempting fetch
2020-03-03T16:45:30.262+0900 [WARN]  failed to unseal core: error="stored unseal keys are supported, but none were found"
2020-03-03T16:45:35.262+0900 [INFO]  core: stored unseal keys supported, attempting fetch
2020-03-03T16:45:35.262+0900 [WARN]  failed to unseal core: error="stored unseal keys are supported, but none were found"

此时vault仍然是unseal。
另外再打开一个terminal：
[r-user@c-test ~]$ VAULT_ADDR=http://127.0.0.1:8100 vault operator init -recovery-shares=1 -recovery-threshold=1 > recovery-key.txt
这里生成的recovery keys只是用来做高级别的操作比如生成root token，或者在手动vault operator seal操作之后重新打开vault操作。
此时看刚才的terminal生成如下输出结果：

2020-03-03T16:45:38.765+0900 [WARN]  core: stored keys supported on init, forcing shares/threshold to 1
2020-03-03T16:45:38.765+0900 [INFO]  core: security barrier not initialized
2020-03-03T16:45:38.766+0900 [INFO]  core: security barrier initialized: stored=1 shares=1 threshold=1
2020-03-03T16:45:38.769+0900 [INFO]  core: post-unseal setup starting
2020-03-03T16:45:38.794+0900 [INFO]  core: loaded wrapping token key
2020-03-03T16:45:38.794+0900 [INFO]  core: successfully setup plugin catalog: plugin-directory=
2020-03-03T16:45:38.794+0900 [INFO]  core: no mounts; adding default mount table
2020-03-03T16:45:38.796+0900 [INFO]  core: successfully mounted backend: type=cubbyhole path=cubbyhole/
2020-03-03T16:45:38.796+0900 [INFO]  core: successfully mounted backend: type=system path=sys/
2020-03-03T16:45:38.797+0900 [INFO]  core: successfully mounted backend: type=identity path=identity/
2020-03-03T16:45:38.803+0900 [INFO]  core: successfully enabled credential backend: type=token path=token/
2020-03-03T16:45:38.803+0900 [INFO]  rollback: starting rollback manager
2020-03-03T16:45:38.803+0900 [INFO]  core: restoring leases
2020-03-03T16:45:38.804+0900 [INFO]  expiration: lease restore complete
2020-03-03T16:45:38.805+0900 [INFO]  identity: entities restored
2020-03-03T16:45:38.805+0900 [INFO]  identity: groups restored
2020-03-03T16:45:38.807+0900 [WARN]  core: post-unseal upgrade seal keys failed: error="no recovery key found"
2020-03-03T16:45:38.807+0900 [INFO]  core: post-unseal setup complete
2020-03-03T16:45:38.810+0900 [INFO]  core: root token generated
2020-03-03T16:45:38.810+0900 [INFO]  core: pre-seal teardown starting
2020-03-03T16:45:38.810+0900 [INFO]  rollback: stopping rollback manager
2020-03-03T16:45:38.810+0900 [INFO]  core: pre-seal teardown complete
2020-03-03T16:45:38.810+0900 [INFO]  core: stored unseal keys supported, attempting fetch
2020-03-03T16:45:38.812+0900 [INFO]  core.cluster-listener: starting listener: listener_address=127.0.0.1:8101
2020-03-03T16:45:38.812+0900 [INFO]  core.cluster-listener: serving cluster requests: cluster_listen_address=127.0.0.1:8101
2020-03-03T16:45:38.812+0900 [INFO]  core: post-unseal setup starting
2020-03-03T16:45:38.812+0900 [INFO]  core: loaded wrapping token key
2020-03-03T16:45:38.812+0900 [INFO]  core: successfully setup plugin catalog: plugin-directory=
2020-03-03T16:45:38.813+0900 [INFO]  core: successfully mounted backend: type=system path=sys/
2020-03-03T16:45:38.813+0900 [INFO]  core: successfully mounted backend: type=identity path=identity/
2020-03-03T16:45:38.813+0900 [INFO]  core: successfully mounted backend: type=cubbyhole path=cubbyhole/
2020-03-03T16:45:38.814+0900 [INFO]  core: successfully enabled credential backend: type=token path=token/
2020-03-03T16:45:38.814+0900 [INFO]  core: restoring leases
2020-03-03T16:45:38.814+0900 [INFO]  rollback: starting rollback manager
2020-03-03T16:45:38.814+0900 [INFO]  identity: entities restored
2020-03-03T16:45:38.814+0900 [INFO]  identity: groups restored
2020-03-03T16:45:38.815+0900 [INFO]  expiration: lease restore complete
2020-03-03T16:45:38.817+0900 [INFO]  core: post-unseal setup complete
2020-03-03T16:45:38.817+0900 [INFO]  core: vault is unsealed
2020-03-03T16:45:38.818+0900 [INFO]  core: unsealed with stored keys: stored_keys_used=1
2020-03-03T16:45:40.263+0900 [WARN]  core: attempted unseal with stored keys, but vault is already unsealed



[r-user@c-test ~]$ VAULT_ADDR=http://127.0.0.1:8100 vault status
Key                      Value
---                      -----
Recovery Seal Type       shamir
Initialized              true
Sealed                   false
Total Recovery Shares    1
Threshold                1
Version                  1.3.2
Cluster Name             vault-cluster-e46960c5
Cluster ID               f93c4ed1-8299-1fe4-143a-c0a552190a6f
HA Enabled               false



为了确认auto-unseal功能现在用ctrl+C将vault2关闭，也就是说vault2现在是seal状态。
然后重新再启动一遍：

[r-user@c-test ~]$ vault server -config=config-autounseal.hcl
==> Vault server configuration:

               Seal Type: transit
         Transit Address: http://127.0.0.1:8200
        Transit Key Name: autounseal
      Transit Mount Path: transit/
                     Cgo: disabled
              Listener 1: tcp (addr: "127.0.0.1:8100", cluster address: "127.0.0.1:8101", max_request_duration: "1m30s", max_request_size: "33554432", tls: "disabled")
               Log Level: info
                   Mlock: supported: true, enabled: false
           Recovery Mode: false
                 Storage: file
                 Version: Vault v1.3.2

==> Vault server started! Log data will stream in below:

2020-03-03T16:47:21.003+0900 [INFO]  proxy environment: http_proxy= https_proxy= no_proxy=
2020-03-03T16:47:21.024+0900 [WARN]  no `api_addr` value specified in config or in VAULT_API_ADDR; falling back to detection if possible, but this value should be manually set
2020-03-03T16:47:21.025+0900 [INFO]  core: stored unseal keys supported, attempting fetch
2020-03-03T16:47:21.029+0900 [INFO]  core.cluster-listener: starting listener: listener_address=127.0.0.1:8101
2020-03-03T16:47:21.029+0900 [INFO]  core.cluster-listener: serving cluster requests: cluster_listen_address=127.0.0.1:8101
2020-03-03T16:47:21.029+0900 [INFO]  core: post-unseal setup starting
2020-03-03T16:47:21.030+0900 [INFO]  core: loaded wrapping token key
2020-03-03T16:47:21.030+0900 [INFO]  core: successfully setup plugin catalog: plugin-directory=
2020-03-03T16:47:21.032+0900 [INFO]  core: successfully mounted backend: type=system path=sys/
2020-03-03T16:47:21.032+0900 [INFO]  core: successfully mounted backend: type=identity path=identity/
2020-03-03T16:47:21.032+0900 [INFO]  core: successfully mounted backend: type=cubbyhole path=cubbyhole/
2020-03-03T16:47:21.036+0900 [INFO]  core: successfully enabled credential backend: type=token path=token/
2020-03-03T16:47:21.036+0900 [INFO]  core: restoring leases
2020-03-03T16:47:21.036+0900 [INFO]  rollback: starting rollback manager
2020-03-03T16:47:21.037+0900 [INFO]  identity: entities restored
2020-03-03T16:47:21.037+0900 [INFO]  expiration: lease restore complete
2020-03-03T16:47:21.037+0900 [INFO]  identity: groups restored
2020-03-03T16:47:21.040+0900 [INFO]  core: post-unseal setup complete
2020-03-03T16:47:21.040+0900 [INFO]  core: vault is unsealed
2020-03-03T16:47:21.040+0900 [INFO]  core: unsealed with stored keys: stored_keys_used=1


看到此时Vault server已经是unseal状态了。Transit Address: 为Vault1的8200端口。
今后只要使用VAULT_TOKEN="s.dD1WmybfBE3wPh0WNIKQA96k"这个token，就可以直接自动unseal Vault2。
然后看看Vault1此时的audit log：
[r-user@c-test ~]$ sudo tail -f /var/log/vault/audit.log | jq
{
  "time": "2020-03-03T07:47:21.0058535Z",
  "type": "request",
  "auth": {
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "display_name": "token",
    "policies": [
      "autounseal",
      "default"
    ],
    "token_policies": [
      "autounseal",
      "default"
    ],
    "token_type": "service"
  },
  "request": {
    "id": "f904af21-7b4d-d8c8-5839-457f0f334503",
    "operation": "update",
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "client_token_accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "namespace": {
      "id": "root"
    },
    "path": "auth/token/renew-self",
    "data": {
      "increment": "hmac-sha256:14c2a85c94845dd7f7dc732bfb8b22a3fc656385a3ec3719b200bed85d1bd620"
    },
    "remote_address": "127.0.0.1"
  }
}
{
  "time": "2020-03-03T07:47:21.020153918Z",
  "type": "response",
  "auth": {
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "display_name": "token",
    "policies": [
      "autounseal",
      "default"
    ],
    "token_policies": [
      "autounseal",
      "default"
    ],
    "token_type": "service"
  },
  "request": {
    "id": "f904af21-7b4d-d8c8-5839-457f0f334503",
    "operation": "update",
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "client_token_accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "namespace": {
      "id": "root"
    },
    "path": "auth/token/renew-self",
    "data": {
      "increment": "hmac-sha256:14c2a85c94845dd7f7dc732bfb8b22a3fc656385a3ec3719b200bed85d1bd620"
    },
    "remote_address": "127.0.0.1"
  },
  "response": {
    "auth": {
      "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
      "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
      "display_name": "token",
      "policies": [
        "autounseal",
        "default"
      ],
      "token_policies": [
        "autounseal",
        "default"
      ],
      "token_type": "service"
    },
    "warnings": [
      "TTL of \"767h54m52s\" exceeded the effective max_ttl of \"767h53m1s\"; TTL value is capped accordingly"
    ]
  }
}
{
  "time": "2020-03-03T07:47:21.023522875Z",
  "type": "request",
  "auth": {
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "display_name": "token",
    "policies": [
      "autounseal",
      "default"
    ],
    "token_policies": [
      "autounseal",
      "default"
    ],
    "token_type": "service"
  },
  "request": {
    "id": "e61292c4-31b9-f1e9-4a72-852b5e60639e",
    "operation": "update",
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "client_token_accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "namespace": {
      "id": "root"
    },
    "path": "transit/encrypt/autounseal",
    "data": {
      "plaintext": "hmac-sha256:cb33af4def19bda7492d268617e03e60f0bb78a47c6aa8280558e26f85db710a"
    },
    "remote_address": "127.0.0.1"
  }
}
{
  "time": "2020-03-03T07:47:21.023695704Z",
  "type": "request",
  "auth": {
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "display_name": "token",
    "policies": [
      "autounseal",
      "default"
    ],
    "token_policies": [
      "autounseal",
      "default"
    ],
    "token_type": "service"
  },
  "request": {
    "id": "2466bf11-348c-5e9e-2e0e-a8a22c12cf6f",
    "operation": "update",
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "client_token_accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "namespace": {
      "id": "root"
    },
    "path": "auth/token/renew-self",
    "data": {
      "increment": "hmac-sha256:14c2a85c94845dd7f7dc732bfb8b22a3fc656385a3ec3719b200bed85d1bd620"
    },
    "remote_address": "127.0.0.1"
  }
}
{
  "time": "2020-03-03T07:47:21.023729267Z",
  "type": "response",
  "auth": {
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "display_name": "token",
    "policies": [
      "autounseal",
      "default"
    ],
    "token_policies": [
      "autounseal",
      "default"
    ],
    "token_type": "service"
  },
  "request": {
    "id": "e61292c4-31b9-f1e9-4a72-852b5e60639e",
    "operation": "update",
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "client_token_accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "namespace": {
      "id": "root"
    },
    "path": "transit/encrypt/autounseal",
    "data": {
      "plaintext": "hmac-sha256:cb33af4def19bda7492d268617e03e60f0bb78a47c6aa8280558e26f85db710a"
    },
    "remote_address": "127.0.0.1"
  },
  "response": {
    "data": {
      "ciphertext": "hmac-sha256:e5e64606b3eac265a12eb4cc274fadb3c2ccf4fd5a501a04778ed9ec6a3de1b7"
    }
  }
}
{
  "time": "2020-03-03T07:47:21.028195563Z",
  "type": "request",
  "auth": {
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "display_name": "token",
    "policies": [
      "autounseal",
      "default"
    ],
    "token_policies": [
      "autounseal",
      "default"
    ],
    "token_type": "service"
  },
  "request": {
    "id": "9caa3385-9760-7c51-d6a4-12a15253c9b4",
    "operation": "update",
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "client_token_accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "namespace": {
      "id": "root"
    },
    "path": "transit/decrypt/autounseal",
    "data": {
      "ciphertext": "hmac-sha256:379718a8098618c5571dc8d69dbb88f3030c237af5fed1b8b16713fde7a97ffe"
    },
    "remote_address": "127.0.0.1"
  }
}
{
  "time": "2020-03-03T07:47:21.028479252Z",
  "type": "response",
  "auth": {
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "display_name": "token",
    "policies": [
      "autounseal",
      "default"
    ],
    "token_policies": [
      "autounseal",
      "default"
    ],
    "token_type": "service"
  },
  "request": {
    "id": "9caa3385-9760-7c51-d6a4-12a15253c9b4",
    "operation": "update",
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "client_token_accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "namespace": {
      "id": "root"
    },
    "path": "transit/decrypt/autounseal",
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    "data": {
      "ciphertext": "hmac-sha256:379718a8098618c5571dc8d69dbb88f3030c237af5fed1b8b16713fde7a97ffe"
    },
    "remote_address": "127.0.0.1"
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  },
  "response": {
    "data": {
      "plaintext": "hmac-sha256:7dec4bdcd22c9852f3d621d7243611fe01723e393e6d6c2398e0fe9582aeda83"
    }
  }
}
{
  "time": "2020-03-03T07:47:21.037663158Z",
  "type": "response",
  "auth": {
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "display_name": "token",
    "policies": [
      "autounseal",
      "default"
    ],
    "token_policies": [
      "autounseal",
      "default"
    ],
    "token_type": "service"
  },
  "request": {
    "id": "2466bf11-348c-5e9e-2e0e-a8a22c12cf6f",
    "operation": "update",
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "client_token_accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "namespace": {
      "id": "root"
    },
    "path": "auth/token/renew-self",
    "data": {
      "increment": "hmac-sha256:14c2a85c94845dd7f7dc732bfb8b22a3fc656385a3ec3719b200bed85d1bd620"
    },
    "remote_address": "127.0.0.1"
  },
  "response": {
    "auth": {
      "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
      "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
      "display_name": "token",
      "policies": [
        "autounseal",
        "default"
      ],
      "token_policies": [
        "autounseal",
        "default"
      ],
      "token_type": "service"
    }
  }
}
{
  "time": "2020-03-03T07:47:21.039578243Z",
  "type": "request",
  "auth": {
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "display_name": "token",
    "policies": [
      "autounseal",
      "default"
    ],
    "token_policies": [
      "autounseal",
      "default"
    ],
    "token_type": "service"
  },
  "request": {
    "id": "47fa2cf3-7755-20a7-dd6b-b370b87e02bc",
    "operation": "update",
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "client_token_accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "namespace": {
      "id": "root"
    },
    "path": "transit/encrypt/autounseal",
    "data": {
      "plaintext": "hmac-sha256:cb33af4def19bda7492d268617e03e60f0bb78a47c6aa8280558e26f85db710a"
    },
    "remote_address": "127.0.0.1"
  }
}
{
  "time": "2020-03-03T07:47:21.039797164Z",
  "type": "response",
  "auth": {
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "display_name": "token",
    "policies": [
      "autounseal",
      "default"
    ],
    "token_policies": [
      "autounseal",
      "default"
    ],
    "token_type": "service"
  },
  "request": {
    "id": "47fa2cf3-7755-20a7-dd6b-b370b87e02bc",
    "operation": "update",
    "client_token": "hmac-sha256:de93e84722c67aca1264ee754491f14597fed6bff2f14a2d802556d7777d3531",
    "client_token_accessor": "hmac-sha256:59f274953a2da954b883cfedf560f0f89ed9d6ebd2ba7231d77c7077a50582b0",
    "namespace": {
      "id": "root"
    },
    "path": "transit/encrypt/autounseal",
    "data": {
      "plaintext": "hmac-sha256:cb33af4def19bda7492d268617e03e60f0bb78a47c6aa8280558e26f85db710a"
    },
    "remote_address": "127.0.0.1"
  },
  "response": {
    "data": {
      "ciphertext": "hmac-sha256:72a8d3bc92b4c28688a5a31b9f145df910ad5ed7c4e08a27d8258561badd3a57"
    }
  }
}



■ transit engine 还有一个功能是可以rotate the encryption key
key可以被手动rotated，或者使用rotation API，通过cron，CI pipeline，或者Nomad batch job，Kubernetes Job等方式自动进行rotate。Vault在加密的时候将会把version of key添加到ciphertext的前面。
[r-user@c-test ~]$ vault list transit/keys
Keys
----
autounseal
[r-user@c-test ~]$ vault list transit-blog/keys
Keys
----
hr

[r-user@c-test ~]$ vault write -f transit/keys/orders
Success! Data written to: transit/keys/orders
[r-user@c-test ~]$ vault write transit/encrypt/orders plaintext=$(base64 <<< "4111 1111 1111 1111")
Key           Value
---           -----
ciphertext    vault:v1:cptKCJf/dysxvE0P7GzgzYXk9dGqO4l11MrhPdwwbSKHpTaMA7Hhok4WtKjyYTOO
[r-user@c-test ~]$ vault write transit/decrypt/orders ciphertext=vault:v1:cptKCJf/dysxvE0P7GzgzYXk9dGqO4l11MrhPdwwbSKHpTaMA7Hhok4WtKjyYTOO
Key          Value
---          -----
plaintext    NDExMSAxMTExIDExMTEgMTExMQo=
[r-user@c-test ~]$ base64 --decode <<< NDExMSAxMTExIDExMTEgMTExMQo=
4111 1111 1111 1111

下面进行key的rotate，从此后的密文都是用新版的key进行加密的：
[r-user@c-test ~]$ vault write -f transit/keys/orders/rotate
Success! Data written to: transit/keys/orders/rotate
[r-user@c-test ~]$ vault write transit/encrypt/orders plaintext=$(base64 <<< "4111 1111 1111 1111")
Key           Value
---           -----
ciphertext    vault:v2:af0bkXqShQl9Xg8CRK9MB2mTWx6AHl0+F8H6FhyvJDiOgp5eEel1u8GXpKaQYQ3W
还可以将之前的密文进行rewrap更新为新版的：
[r-user@c-test ~]$ vault write transit/rewrap/orders ciphertext=vault:v1:cptKCJf/dysxvE0P7GzgzYXk9dGqO4l11MrhPdwwbSKHpTaMA7Hhok4WtKjyYTOO
Key           Value
---           -----
ciphertext    vault:v2:sI5OZk7e1sm3RFeWL6Uq0hUddx4Gvd7zTMasu1LYRzhV8NgJ2one0PXduYldSIHb
这个操作不会泄露明文，但是vault会用keyring中旧的key进行解密后用新key再加密。


如果想要删除一个key的话，因为后果是无法再解密这个key生成的密文，所以需要先明确设置config才能删。
[r-user@c-test ~]$ vault delete transit/keys/orders
Error deleting transit/keys/orders: Error making API request.

URL: DELETE http://172.18.1.104:8200/v1/transit/keys/orders
Code: 400. Errors:

* error deleting policy orders: deletion is not allowed for this key
[r-user@c-test ~]$ vault read transit/keys/orders
Key                       Value
---                       -----
allow_plaintext_backup    false
deletion_allowed          false
derived                   false
exportable                false
keys                      map[1:1584325101 2:1584325517]
latest_version            2
min_available_version     0
min_decryption_version    1
min_encryption_version    0
name                      orders
supports_decryption       true
supports_derivation       true
supports_encryption       true
supports_signing          false
type                      aes256-gcm96

[r-user@c-test ~]$ vault write -f transit/keys/orders/config deletion_allowed="true"
Success! Data written to: transit/keys/orders/config
[r-user@c-test ~]$ vault delete transit/keys/orders
Success! Data deleted (if it existed) at: transit/keys/orders



■ 理解一下token，role，auth，entity等概念


[r-user@c-test ~]$ vault write auth/token/roles/zabbix allowed_policies="default" period="24h"
Success! Data written to: auth/token/roles/zabbix

[r-user@c-test ~]$ vault auth list
Path      Type     Accessor               Description
----      ----     --------               -----------
token/    token    auth_token_bde75e77    token based credentials
[r-user@c-test ~]$


[r-user@c-test ~]$ vault auth list -detailed
Path      Plugin    Accessor               Default TTL    Max TTL    Token Type         Replication    Seal Wrap    External Entropy Access    Options    Description                UUID
----      ------    --------               -----------    -------    ----------         -----------    ---------    -----------------------    -------    -----------                ----
token/    token     auth_token_bde75e77    system         system     default-service    replicated     false        false                      map[]      token based credentials    f34a6bc9-3616-3703-6ebe-2a171487d314
[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$ vault token create -role=zabbix
Key                  Value
---                  -----
token                s.Do5Oufe4HyUdLCuzx7PeHaIO
token_accessor       fP3lFhU5XHY0gxOhRIFtAMj3
token_duration       24h
token_renewable      true
token_policies       ["default"]
identity_policies    []
policies             ["default"]
[r-user@c-test ~]$

[r-user@c-test ~]$ vault read sys/internal/counters/tokens
Key         Value
---         -----
counters    map[service_tokens:map[total:4]]
[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$ vault read sys/internal/counters/entities
Key         Value
---         -----
counters    map[entities:map[total:0]]
[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$ vault token create
Key                  Value
---                  -----
token                s.SQgD4QxIA1qgRaQPrljnthUV
token_accessor       cBjqRBjFQHTY1vz5nTl9SxRo
token_duration       ∞
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]

[r-user@c-test ~]$ vault read sys/internal/counters/tokens
Key         Value
---         -----
counters    map[service_tokens:map[total:5]]
[r-user@c-test ~]$
[r-user@c-test ~]$ vault token lookup s.SQgD4QxIA1qgRaQPrljnthUV
Key                 Value
---                 -----
accessor            cBjqRBjFQHTY1vz5nTl9SxRo
creation_time       1583386783
creation_ttl        0s
display_name        token
entity_id           n/a
expire_time         <nil>
explicit_max_ttl    0s
id                  s.SQgD4QxIA1qgRaQPrljnthUV
issue_time          2020-03-05T14:39:43.244826903+09:00
meta                <nil>
num_uses            0
orphan              false
path                auth/token/create
policies            [root]
renewable           false
ttl                 0s
type                service
[r-user@c-test ~]$
[r-user@c-test ~]$ vault token lookup s.VP23Tf5pwQkQArG3YQq3lJqS
Key                 Value
---                 -----
accessor            Wi1n6GFpEoI8GBqWCJr6mzsS
creation_time       1583211117
creation_ttl        0s
display_name        root
entity_id           n/a
expire_time         <nil>
explicit_max_ttl    0s
id                  s.VP23Tf5pwQkQArG3YQq3lJqS
meta                <nil>
num_uses            0
orphan              true
path                auth/token/root
policies            [root]
ttl                 0s
type                service
[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$ vault token lookup s.Do5Oufe4HyUdLCuzx7PeHaIO
Key                 Value
---                 -----
accessor            fP3lFhU5XHY0gxOhRIFtAMj3
creation_time       1583386635
creation_ttl        24h
display_name        token
entity_id           n/a
expire_time         2020-03-06T14:37:15.639530028+09:00
explicit_max_ttl    0s
id                  s.Do5Oufe4HyUdLCuzx7PeHaIO
issue_time          2020-03-05T14:37:15.639545269+09:00
meta                <nil>
num_uses            0
orphan              false
path                auth/token/create/zabbix
policies            [default]
renewable           true
role                zabbix
ttl                 23h53m28s
type                service
[r-user@c-test ~]$

这个是之前创建的只有2m寿命的token：
[r-user@c-test ~]$ vault token lookup s.nCVMUGDEtH3A9r20Js5bHmqw
Error looking up token: Error making API request.

URL: POST http://127.0.0.1:8200/v1/auth/token/lookup
Code: 403. Errors:

* bad token

这个是之前创建的unwrap之后的给vault2进行autounseal的token：
[r-user@c-test ~]$ vault token lookup s.dD1WmybfBE3wPh0WNIKQA96k
Key                  Value
---                  -----
accessor             RQKlPzvWOR9a6NxIg1nZoKCo
creation_time        1583221222
creation_ttl         768h
display_name         token
entity_id            n/a
expire_time          2020-04-04T16:40:22.027640337+09:00
explicit_max_ttl     0s
id                   s.dD1WmybfBE3wPh0WNIKQA96k
issue_time           2020-03-03T16:40:22.173010985+09:00
last_renewal         2020-03-03T16:47:21.027640714+09:00
last_renewal_time    1583221641
meta                 <nil>
num_uses             0
orphan               false
path                 auth/token/create
policies             [autounseal default]
renewable            true
ttl                  721h54m47s
type                 service




[r-user@c-test ~]$ vault token create -policy=default
Key                  Value
---                  -----
token                s.FWIAMtuh0amWwlMP91zCrdGg
token_accessor       SD51RNfzHWYeq7U8GBWu5nyP
token_duration       768h
token_renewable      true
token_policies       ["default"]
identity_policies    []
policies             ["default"]
[r-user@c-test ~]$
[r-user@c-test ~]$ vault read sys/internal/counters/tokens
Key         Value
---         -----
counters    map[service_tokens:map[total:6]]


■ Auth method - userpass
[r-user@c-test ~]$ vault auth enable userpass
Success! Enabled userpass auth method at: userpass/
[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$ vault write auth/userpass/users/mitchellh \
>     password=foo \
>     policies=admins
Success! Data written to: auth/userpass/users/mitchellh
这个叫做admins的policy实际上没有创建，但是创建auth的命令也走通了。

[r-user@c-test ~]$ vault login -method=userpass \
>     username=mitchellh \
>     password=foo
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                    Value
---                    -----
token                  s.ZV1GkcjD0xq5NKcjpF7XoVGE
token_accessor         WvoA8hbk6Z4Ab92UfbbW3HWx
token_duration         768h
token_renewable        true
token_policies         ["admins" "default"]
identity_policies      []
policies               ["admins" "default"]
token_meta_username    mitchellh


[r-user@c-test ~]$ vault token lookup
Key                 Value
---                 -----
accessor            WvoA8hbk6Z4Ab92UfbbW3HWx
creation_time       1583392126
creation_ttl        768h
display_name        userpass-mitchellh
entity_id           e90a0549-6100-9e2c-9f7b-0b0a792ecb87
expire_time         2020-04-06T16:08:46.364190343+09:00
explicit_max_ttl    0s
id                  s.ZV1GkcjD0xq5NKcjpF7XoVGE
issue_time          2020-03-05T16:08:46.364238323+09:00
meta                map[username:mitchellh]
num_uses            0
orphan              true
path                auth/userpass/login/mitchellh
policies            [admins default]
renewable           true
ttl                 767h57m6s
type                service


[r-user@c-test ~]$ VAULT_TOKEN="s.SQgD4QxIA1qgRaQPrljnthUV" vault read sys/internal/counters/tokens
Key         Value
---         -----
counters    map[service_tokens:map[total:7]]

[r-user@c-test ~]$ VAULT_TOKEN="s.SQgD4QxIA1qgRaQPrljnthUV" vault read sys/internal/counters/entities
Key         Value
---         -----
counters    map[entities:map[total:1]]


{
  "time": "2020-03-05T07:08:46.375700214Z",
  "type": "response",
  "auth": {
    "client_token": "hmac-sha256:703946e6704e69b6fbb6414c4c07e49f2c892e7daed60e3ab1deb0ed20aad6b1",
    "accessor": "hmac-sha256:cc05a8f9ef1f780f5bd6383fa4578c5acecff4e09abe53589d58c5d23754fce6",
    "display_name": "userpass-mitchellh",
    "policies": [
      "admins",
      "default"
    ],
    "token_policies": [
      "admins",
      "default"
    ],
    "metadata": {
      "username": "mitchellh"
    },
    "entity_id": "e90a0549-6100-9e2c-9f7b-0b0a792ecb87",
    "token_type": "service"
  },
  "request": {
　　^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    "id": "b055a065-a4ea-0a20-9c98-7c43716a48f4",
    "operation": "update",
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    "namespace": {
      "id": "root"
　　　　　　　^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    },
    "path": "auth/userpass/login/mitchellh",
　　　　　　　　　　^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    "data": {
      "password": "hmac-sha256:a280ffc7b3d2a4db19ceaf2ae0bc4eaf1b8e01d1060c1d81bee1af8c0fed395c"
    },
    "remote_address": "127.0.0.1"
  },
  "response": {
    "auth": {
      "client_token": "hmac-sha256:703946e6704e69b6fbb6414c4c07e49f2c892e7daed60e3ab1deb0ed20aad6b1",
      "accessor": "hmac-sha256:cc05a8f9ef1f780f5bd6383fa4578c5acecff4e09abe53589d58c5d23754fce6",
      "display_name": "userpass-mitchellh",
      "policies": [
        "admins",
        "default"
      ],
      "token_policies": [
        "admins",
        "default"
      ],
      "metadata": {
        "username": "mitchellh"
      },
      "entity_id": "e90a0549-6100-9e2c-9f7b-0b0a792ecb87",
　　　　　　　　　　　　　　　^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
      "token_type": "service"
    }
  }
}




■ 创建没有identity的token

[r-user@c-test ~]$ vault token create -policy=default
Key                  Value
---                  -----
token                s.tEEXpLYcb6rNjDLYua7dAO7P
token_accessor       DVfZznavAWKeRI0JW464QE94
token_duration       768h
token_renewable      true
token_policies       ["default"]
identity_policies    []
policies             ["default"]
[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$  vault read sys/internal/counters/tokens
Key         Value
---         -----
counters    map[service_tokens:map[total:8]]



{
  "time": "2020-03-05T07:50:55.525290022Z",
  "type": "response",
  "auth": {
    "client_token": "hmac-sha256:5e27eb5a8fc333dc507c38187f12461b0fdc25d3fdb70762ca1449b5b94b454b",
    "accessor": "hmac-sha256:287219af85272b762a56f1330aa694ab0e99fe52b8216a95462720626d4888a1",
    "display_name": "token",
    "policies": [
      "root"
    ],
    "token_policies": [
      "root"
    ],
    "token_type": "service"
  },
  "request": {
   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    "id": "acfb3b31-f9cc-7e48-e6a5-f8d32f194200",
    "operation": "update",
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    "client_token": "hmac-sha256:5e27eb5a8fc333dc507c38187f12461b0fdc25d3fdb70762ca1449b5b94b454b",
    "client_token_accessor": "hmac-sha256:287219af85272b762a56f1330aa694ab0e99fe52b8216a95462720626d4888a1",
    "namespace": {
      "id": "root"
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    },
    "path": "auth/token/create",
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    "data": {
      "display_name": "hmac-sha256:257daf7139036d2ffbe73942ec0df3aa65c4596106ffb8546583786635938fb8",
      "entity_alias": "hmac-sha256:257daf7139036d2ffbe73942ec0df3aa65c4596106ffb8546583786635938fb8",
      "explicit_max_ttl": "hmac-sha256:4b7b2046c3635bce1adb15b6b2e57ff953e19859e09e7fa175c26af947007b13",
      "num_uses": "hmac-sha256:14c2a85c94845dd7f7dc732bfb8b22a3fc656385a3ec3719b200bed85d1bd620",
      "period": "hmac-sha256:4b7b2046c3635bce1adb15b6b2e57ff953e19859e09e7fa175c26af947007b13",
      "policies": [
        "hmac-sha256:16dbf81ef4fedededb08124edf79c8bab333b38cc38c807e7ddce0d87228f483"
      ],
      "renewable": true,
      "ttl": "hmac-sha256:4b7b2046c3635bce1adb15b6b2e57ff953e19859e09e7fa175c26af947007b13",
      "type": "hmac-sha256:475f69479b9dd7b73fb86d9286e521549da6f0ee4595c7b6c41196563f5972d7"
    },
    "remote_address": "127.0.0.1"
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  },
  "response": {
    "auth": {
      "client_token": "hmac-sha256:4dc8dc084c5dfe6e78a03aa4ff6c58b67697442c808e0df9e1c1dbe8a749e7e2",
      "accessor": "hmac-sha256:053dc16c736f2de85dd0b8b89226cf38062afc6e22eb2387689a8a248df34000",
      "display_name": "token",
      "policies": [
        "default"
      ],
      "token_policies": [
        "default"
      ],
      "token_type": "service"
    }
  }
}



★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★

★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★

■　Jake Lundberg' blog
https://medium.com/hashicorp-engineering/essential-patterns-of-vault-part-2-b4d34976f1dc


[r-user@c-test vault_essential_patterns_blog]$ ./4_enable_db.sh

Running: ./4_enable_db.sh: Enable/configure database engine

[r-user@c-test] vault secrets enable -path=db-blog database

Success! Enabled the database secrets engine at: db-blog/

Configure the account that Vault will use to manage credentials in Postgres.
vault write db-blog/config/mother
    plugin_name=postgresql-database-plugin
    allowed_roles=*
    connection_url="postgresql://{{username}}:{{password}}@172.18.1.104:5432/mother?sslmode=disable"
    username="vault_admin"
    password="notsosecure"

[r-user@c-test]

Configure the Vault/Postgres database roles with time bound credential templates

There are 1m and 1h credential endpoints.  1m are great for demo'ing so you can see them expire

Full read can be used by security teams to scan for credentials in any schema
CREATION_STATEMENT=CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';
  GRANT USAGE ON SCHEMA public,it,hr,security,finance,engineering TO "{{name}}";
  GRANT SELECT ON ALL TABLES IN SCHEMA public,it,hr,security,finance,engineering TO "{{name}}";

vault write db-blog/roles/mother-full-read-1m
    db_name=mother
    creation_statements="CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; GRANT USAGE ON SCHEMA public,it,hr,security,finance,engineering TO "{{name}}"; GRANT SELECT ON ALL TABLES IN SCHEMA public,it,hr,security,finance,engineering TO "{{name}}";"
    default_ttl=1m
    max_ttl=24h

[r-user@c-test]

Success! Data written to: db-blog/roles/mother-full-read-1m

CREATION_STATEMENT=CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';
  GRANT USAGE ON SCHEMA public,it,hr,security,finance,engineering TO "{{name}}";
  GRANT SELECT ON ALL TABLES IN SCHEMA public,it,hr,security,finance,engineering TO "{{name}}";

vault write db-blog/roles/mother-full-read-1h
    db_name=mother
    creation_statements="CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; GRANT USAGE ON SCHEMA public,it,hr,security,finance,engineering TO "{{name}}"; GRANT SELECT ON ALL TABLES IN SCHEMA public,it,hr,security,finance,engineering TO "{{name}}";"
    default_ttl=1h
    max_ttl=24h

[r-user@c-test]

Success! Data written to: db-blog/roles/mother-full-read-1h

HR will be granted full access to their schema
CREATION_STATEMENT=CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';
GRANT USAGE ON SCHEMA hr TO "{{name}}";
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA hr TO "{{name}}";

vault write db-blog/roles/mother-hr-full-1m
    db_name=mother
    creation_statements="CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; GRANT USAGE ON SCHEMA hr TO "{{name}}"; GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA hr TO "{{name}}";"
    default_ttl=1m
    max_ttl=24h

[r-user@c-test]

Success! Data written to: db-blog/roles/mother-hr-full-1m

CREATION_STATEMENT=CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';
GRANT USAGE ON SCHEMA hr TO "{{name}}";
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA hr TO "{{name}}";

vault write db-blog/roles/mother-hr-full-1h
    db_name=mother
    creation_statements="CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; GRANT USAGE ON SCHEMA hr TO "{{name}}"; GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA hr TO "{{name}}";"
    default_ttl=1h
    max_ttl=24h

[r-user@c-test]

Success! Data written to: db-blog/roles/mother-hr-full-1h

Engineering will be granted full access to their schema
CREATION_STATEMENT=CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';
GRANT USAGE ON SCHEMA engineering TO "{{name}}";
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA engineering TO "{{name}}";

vault write db-blog/roles/mother-engineering-full-1m
    db_name=mother
    creation_statements="CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; GRANT USAGE ON SCHEMA engineering TO "{{name}}"; GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA engineering TO "{{name}}";"
    default_ttl=1m
    max_ttl=24h

[r-user@c-test]

Success! Data written to: db-blog/roles/mother-engineering-full-1m

CREATION_STATEMENT=CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';
GRANT USAGE ON SCHEMA engineering TO "{{name}}";
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA engineering TO "{{name}}";

vault write db-blog/roles/mother-engineering-full-1h
    db_name=mother
    creation_statements="CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; GRANT USAGE ON SCHEMA engineering TO "{{name}}"; GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA engineering TO "{{name}}";"
    default_ttl=1h
    max_ttl=24h

[r-user@c-test]

Success! Data written to: db-blog/roles/mother-engineering-full-1h






[r-user@c-test vault_essential_patterns_blog]$ ./5_enable_transit.sh

Running: ./5_enable_transit.sh: Enable/configure the Transit Secret Engine (Encryption as a Service)

[r-user@c-test] vault secrets enable -path=transit-blog transit

Success! Enabled the transit secrets engine at: transit-blog/

Create a transit key for the HR team.

[r-user@c-test] vault write -f transit-blog/keys/hr

Success! Data written to: transit-blog/keys/hr

[r-user@c-test vault_essential_patterns_blog]$ vault read transit-blog/keys/hr
Key                       Value
---                       -----
allow_plaintext_backup    false
deletion_allowed          false
derived                   false
exportable                false
keys                      map[1:1583742615]
latest_version            1
min_available_version     0
min_decryption_version    1
min_encryption_version    0
name                      hr
supports_decryption       true
supports_derivation       true
supports_encryption       true
supports_signing          false
type                      aes256-gcm96

[r-user@c-test vault_essential_patterns_blog]$ vault list transit-blog/keys/
Keys
----
hr

[r-user@c-test vault_essential_patterns_blog]$ vault write transit-blog/encrypt/hr plaintext=$(base64 <<< "my secret data")
Key           Value
---           -----
ciphertext    vault:v1:JPzqIYH5dfP490cem/ZzZFjwpwrHBFh53GZCM3WXl1UoqWPFk6xU7JVwBg==








NOTE: The Distinguished Name (DN) is the unique identifier for LDAP/AD records. Try to use this to link up records as much as possible.

“uniqueMember” attributes belong to an LDAP class: “groupOfUniqueNames” which in this LDAP directory are mapped under “ou=um_group,dc=ourcorp,dc=com”. We’ll match the DN of the user who is authenticating with Vault to any groups the user belongs to. In large LDAP/AD directories, these searches can be slower than looking up directly in a user’s attributes like with the memberOf overlay.

“memberOf” is an operational attribute that belongs to the “person” objectClass. The current user will have one memberOf entry for any LDAP attribute whose value is equal to the user’s DN. These lookups are generally much faster.

e.g.

Group attribute/Distinguished Name mapping:

“uniqueMember=cn=alice,ou=people,dc=ourcorp,dc=com” exists in groups

    DN: cn=founders,ou=um_group,dc=ourcorp,dc=com
    DN: cn=finance,ou=um_group,dc=ourcorp,dc=com

So user record:

DN: cn=alice,ou=people,dc=ourcorp,dc=com

Will have the following entries

    memberOf: cn=founders,ou=um_group,dc=ourcorp,dc=com
    memberOf: cn=finance,ou=um_group,dc=ourcorp,dc=com

Enable and configure LDAP for memberOf support.

[r-user@c-test vault_essential_patterns_blog]$ ./6_enable_ldap_auth.sh

Running: ./6_enable_ldap_auth.sh: Enable and Configure the LDAP Auth Method

[r-user@c-test] vault auth enable -path=ldap-um ldap

Success! Enabled ldap auth method at: ldap-um/


[r-user@c-test] vault auth enable -path=ldap-mo ldap

Success! Enabled ldap auth method at: ldap-mo/

Configure Unique Member group lookups
vault write auth/ldap-um/config
    url="ldap://172.18.1.104"
    binddn="cn=read-only,dc=ourcorp,dc=com"
    bindpass="devsecopsFTW"
    userdn="ou=people,dc=ourcorp,dc=com"
    userattr="cn"
    groupdn="ou=um_group,dc=ourcorp,dc=com"
    groupfilter="(&(objectClass=groupOfUniqueNames)(uniqueMember={{.UserDN}}))"
    groupattr="cn"
    insecure_tls=true

[r-user@c-test]

Success! Data written to: auth/ldap-um/config

Configure MemberOf group lookups
vault write auth/ldap-mo/config
    url="ldap://172.18.1.104"
    binddn="cn=read-only,dc=ourcorp,dc=com"
    bindpass="devsecopsFTW"
    userdn="ou=people,dc=ourcorp,dc=com"
    userattr="cn"
    groupdn="ou=people,dc=ourcorp,dc=com"
    groupfilter="(&(objectClass=person)(uid={{.Username}}))"
    groupattr="memberOf"
    insecure_tls=true

[r-user@c-test]

Success! Data written to: auth/ldap-mo/config



[r-user@c-test vault_essential_patterns_blog]$ ./7_generate_dynamic_policy.sh

Running: ./7_generate_dynamic_policy.sh: Generating a dynamic policy
Generating a dynamic policy under policies/kv-user-template-policy.hcl.  This needs to be done because the ACL templates need to know the local LDAP auth method accessors

[r-user@c-test] vault policy write kv-user-template policies/kv-user-template-policy.hcl

Success! Uploaded policy: kv-user-template

[r-user@c-test vault_essential_patterns_blog]$ vault policy read kv-user-template
# Allow full access to the current version of the kv-blog
path "kv-blog/data/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}/*"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}

path "kv-blog/data/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}


# Allow deletion of any kv-blog version
path "kv-blog/delete/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/delete/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}"
{
  capabilities = ["update"]
}

# Allow un-deletion of any kv-blog version
path "kv-blog/undelete/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/undelete/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}"
{
  capabilities = ["update"]
}

# Allow destroy of any kv-blog version
path "kv-blog/destroy/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/destroy/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}"
{
  capabilities = ["update"]
}
# Allow list and view of metadata and to delete all versions and metadata for a key
path "kv-blog/metadata/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}/*"
{
  capabilities = ["list", "read", "delete"]
}

path "kv-blog/metadata/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}"
{
  capabilities = ["list", "read", "delete"]
}

# Allow full access to the current version of the kv-blog
path "kv-blog/data/{{identity.entity.aliases.auth_ldap_67eec4dd.name}}/*"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}

path "kv-blog/data/{{identity.entity.aliases.auth_ldap_67eec4dd.name}}"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}


# Allow deletion of any kv-blog version
path "kv-blog/delete/{{identity.entity.aliases.auth_ldap_67eec4dd.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/delete/{{identity.entity.aliases.auth_ldap_67eec4dd.name}}"
{
  capabilities = ["update"]
}

# Allow un-deletion of any kv-blog version
path "kv-blog/undelete/{{identity.entity.aliases.auth_ldap_67eec4dd.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/undelete/{{identity.entity.aliases.auth_ldap_67eec4dd.name}}"
{
  capabilities = ["update"]
}

# Allow destroy of any kv-blog version
path "kv-blog/destroy/{{identity.entity.aliases.auth_ldap_67eec4dd.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/destroy/{{identity.entity.aliases.auth_ldap_67eec4dd.name}}"
{
  capabilities = ["update"]
}
# Allow list and view of metadata and to delete all versions and metadata for a key
path "kv-blog/metadata/{{identity.entity.aliases.auth_ldap_67eec4dd.name}}/*"
{
  capabilities = ["list", "read", "delete"]
}

path "kv-blog/metadata/{{identity.entity.aliases.auth_ldap_67eec4dd.name}}"
{
  capabilities = ["list", "read", "delete"]
}








[r-user@c-test vault_essential_patterns_blog]$ ./8_create_policies.sh

Running: ./8_create_policies.sh: Creating Policies

[r-user@c-test] vault policy write kv-it policies/kv-it-policy.hcl

Success! Uploaded policy: kv-it


[r-user@c-test] vault policy write db-full-read policies/db-full-read-policy.hcl

Success! Uploaded policy: db-full-read


[r-user@c-test] vault policy write db-engineering policies/db-engineering-policy.hcl

Success! Uploaded policy: db-engineering


[r-user@c-test] vault policy write db-hr policies/db-hr-policy.hcl

Success! Uploaded policy: db-hr


[r-user@c-test] vault policy write transit-hr policies/transit-hr-policy.hcl

Success! Uploaded policy: transit-hr




[r-user@c-test vault_essential_patterns_blog]$ vault policy list
autounseal
db-engineering
db-full-read
db-hr
default
kv-it
kv-user-template
testpolicy
transit-hr
root
[r-user@c-test vault_essential_patterns_blog]$ vault policy read kv-it
# KV V2 Blanket Policies:

# Allow full access to the current version of the kv-blog
path "kv-blog/data/it/*"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}

path "kv-blog/data/it"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}


# Allow deletion of any kv-blog version
path "kv-blog/delete/it/*"
{
  capabilities = ["update"]
}

path "kv-blog/delete/it"
{
  capabilities = ["update"]
}

# Allow un-deletion of any kv-blog version
path "kv-blog/undelete/it/*"
{
  capabilities = ["update"]
}

path "kv-blog/undelete/it"
{
  capabilities = ["update"]
}

# Allow destroy of any kv-blog version
path "kv-blog/destroy/it/*"
{
  capabilities = ["update"]
}

path "kv-blog/destroy/it"
{
  capabilities = ["update"]
}
# Allow list and view of metadata and to delete all versions and metadata for a key
path "kv-blog/metadata/it/*"
{
  capabilities = ["list", "read", "delete"]
}

path "kv-blog/metadata/it"
{
  capabilities = ["list", "read", "delete"]
}

It’s giving full rights to the secrets in the kv-blog/it path in Vault. “Data” and “delete” paths here are operation paths for the KV V2 engine and need to be expressed directly. 




ACL Templated Policies，下面是ACL templating的例子，它允许任何用户都可以管理kv-blog/data/$(LDAP_USERNAME)下的secrets：
[r-user@c-test vault_essential_patterns_blog]$ more ./policies/kv-user-template-policy.hcl
# Allow full access to the current version of the kv-blog
path "kv-blog/data/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}/*"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}

path "kv-blog/data/{{identity.entity.aliases.auth_ldap_8a7d696a.name}}"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}
。。。。。。

Notice the mount accessor identifier in the policy template. This means that when creating ACL templated policies, you have to do so after mounting your Authentication Methods. See 7_generate_dynamic_policy.sh for an example of how to do this.

[r-user@c-test vault_essential_patterns_blog]$ more 7_generate_dynamic_policy.sh
. env.sh

echo
cyan "Running: $0: Generating a dynamic policy"
UM_ACCESS=$(vault auth list -format=json | jq -r '.["ldap-um/"].accessor')
MO_ACCESS=$(vault auth list -format=json | jq -r '.["ldap-mo/"].accessor')

green "Generating a dynamic policy under policies/kv-user-template-policy.hcl.  This needs to be don
e because the ACL templates need to know the local LDAP auth method accessors"

cat > policies/kv-user-template-policy.hcl << EOF
# Allow full access to the current version of the kv-blog
path "kv-blog/data/{{identity.entity.aliases.${UM_ACCESS}.name}}/*"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}

path "kv-blog/data/{{identity.entity.aliases.${UM_ACCESS}.name}}"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}


# Allow deletion of any kv-blog version
path "kv-blog/delete/{{identity.entity.aliases.${UM_ACCESS}.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/delete/{{identity.entity.aliases.${UM_ACCESS}.name}}"
{
  capabilities = ["update"]
}

# Allow un-deletion of any kv-blog version
path "kv-blog/undelete/{{identity.entity.aliases.${UM_ACCESS}.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/undelete/{{identity.entity.aliases.${UM_ACCESS}.name}}"
{
  capabilities = ["update"]
}

# Allow destroy of any kv-blog version
path "kv-blog/destroy/{{identity.entity.aliases.${UM_ACCESS}.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/destroy/{{identity.entity.aliases.${UM_ACCESS}.name}}"
{
  capabilities = ["update"]
}
# Allow list and view of metadata and to delete all versions and metadata for a key
path "kv-blog/metadata/{{identity.entity.aliases.${UM_ACCESS}.name}}/*"
{
  capabilities = ["list", "read", "delete"]
}

path "kv-blog/metadata/{{identity.entity.aliases.${UM_ACCESS}.name}}"
{
  capabilities = ["list", "read", "delete"]
}

# Allow full access to the current version of the kv-blog
path "kv-blog/data/{{identity.entity.aliases.${MO_ACCESS}.name}}/*"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}

path "kv-blog/data/{{identity.entity.aliases.${MO_ACCESS}.name}}"
{
  capabilities = ["create", "read", "update", "delete", "list"]
}


# Allow deletion of any kv-blog version
path "kv-blog/delete/{{identity.entity.aliases.${MO_ACCESS}.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/delete/{{identity.entity.aliases.${MO_ACCESS}.name}}"
{
  capabilities = ["update"]
}

# Allow un-deletion of any kv-blog version
path "kv-blog/undelete/{{identity.entity.aliases.${MO_ACCESS}.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/undelete/{{identity.entity.aliases.${MO_ACCESS}.name}}"
{
  capabilities = ["update"]
}

# Allow destroy of any kv-blog version
path "kv-blog/destroy/{{identity.entity.aliases.${MO_ACCESS}.name}}/*"
{
  capabilities = ["update"]
}

path "kv-blog/destroy/{{identity.entity.aliases.${MO_ACCESS}.name}}"
{
  capabilities = ["update"]
}
# Allow list and view of metadata and to delete all versions and metadata for a key
path "kv-blog/metadata/{{identity.entity.aliases.${MO_ACCESS}.name}}/*"
{
  capabilities = ["list", "read", "delete"]
}

path "kv-blog/metadata/{{identity.entity.aliases.${MO_ACCESS}.name}}"
{
  capabilities = ["list", "read", "delete"]
}
EOF

pe "vault policy write kv-user-template policies/kv-user-template-policy.hcl"
=================
7_generate_dynamic_policy.sh 结束




摘抄一下对ACL Templating的解释：
The only way to specify non-static paths in ACL policies was to use globs (*) at the end of paths. Or, use plus-sign (+) for a single directory wildcard matching.
path "transit/keys/*" {
  capabilities = [ "read" ]
}

path "secret/+/apikey" {
  capabilities = [ "create", "read", "update", "delete", "list" ]
}
This makes many management and delegation tasks challenging. For example, allowing a user to change their own password by invoking the auth/userpass/users/<user_name>/password endpoint can require either a policy for every user or requires the use of Sentinel which is a part of Vault Enterprise.
Solution：
As of Vault 0.11, ACL templating capability is available to allow a subset of user information to be used within ACL policy paths.
This policy allows users to change their own password given that the username and password are defined in the userpass auth method. The mount accessor value (auth_userpass_6671d643 in this example) can be read from the sys/auth endpoint.
path "auth/userpass/users/{{identity.entity.aliases.auth_userpass_6671d643.name}}" {
  capabilities = [ "update" ]
  allowed_parameters = {
    "password" = []
  }
}
参考：
[r-user@c-test ~]$ vault auth list
Path         Type        Accessor                  Description
----         ----        --------                  -----------
approle/     approle     auth_approle_f02e7bec     n/a
ldap-mo/     ldap        auth_ldap_67eec4dd        n/a
ldap-um/     ldap        auth_ldap_8a7d696a        n/a
token/       token       auth_token_bde75e77       token based credentials
userpass/    userpass    auth_userpass_b8272cc7    n/a





[r-user@c-test vault_essential_patterns_blog]$ ./9_associate_policies.sh

Running: ./9_associate_policies.sh: Associating Policies with Authentication Methods
Setup Unique Member group logins for LDAP.   These can use alias names when logging in


[r-user@c-test] vault write auth/ldap-um/groups/it policies=kv-it,kv-user-template

Success! Data written to: auth/ldap-um/groups/it


[r-user@c-test] vault write auth/ldap-um/groups/security policies=db-full-read,kv-user-template

Success! Data written to: auth/ldap-um/groups/security

Setup MemberOf group logins for LDAP.   Need to use the entire DN for the group here as these are in the user's attributes


[r-user@c-test] vault write auth/ldap-mo/groups/hr policies=db-hr,transit-hr,kv-user-template

Success! Data written to: auth/ldap-mo/groups/hr


[r-user@c-test] vault write auth/ldap-mo/groups/engineering policies=db-engineering,kv-user-template

Success! Data written to: auth/ldap-mo/groups/engineering

Notice the difference between the two records? One is a uniqueMember lookup while the other is a memberOf lookup. While memberOf group names are longer, they are also unique because they reference the full DN, not just an alias name.












[r-user@c-test vault_essential_patterns_blog]$ ./test_it.sh
Running: ./test_it.sh: Testing IT requirements
Unset VAULT_TOKEN so we don't accidentally carry over the root token

[r-user@c-test] unset VAULT_TOKEN



[r-user@c-test] vault login -method=ldap -path=ldap-um username=deepak password=thispasswordsucks

Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                    Value
---                    -----
token                  s.DGhLp8g26jeDHF6Ky3xLPB7z
token_accessor         GvZpzVpbRlKpjA0NAgGGnmCR
token_duration         768h
token_renewable        true
token_policies         ["default" "kv-it" "kv-user-template"]
identity_policies      []
policies               ["default" "kv-it" "kv-user-template"]
token_meta_username    deepak

Test KV puts to allowed paths

[r-user@c-test] vault kv put kv-blog/it/servers/hr/root password=rootntootn

Key              Value
---              -----
created_time     2020-03-10T01:11:04.005696802Z
deletion_time    n/a
destroyed        false
version          1


[r-user@c-test] vault kv put kv-blog/it/routers/snmp/read-write password=snortymcsnortyton

Key              Value
---              -----
created_time     2020-03-10T01:11:18.85611283Z
deletion_time    n/a
destroyed        false
version          1

This is allowed via an ACL templated path!

[r-user@c-test] vault kv put kv-blog/deepak/email password=doesntlooklikeanythingtome

Key              Value
---              -----
created_time     2020-03-10T01:11:29.400336446Z
deletion_time    n/a
destroyed        false
version          1

Test KV gets to allowed paths

[r-user@c-test] vault kv get kv-blog/it/servers/hr/root

====== Metadata ======
Key              Value
---              -----
created_time     2020-03-10T01:11:04.005696802Z
deletion_time    n/a
destroyed        false
version          1

====== Data ======
Key         Value
---         -----
password    rootntootn


[r-user@c-test] vault kv get kv-blog/it/routers/snmp/read-write

====== Metadata ======
Key              Value
---              -----
created_time     2020-03-10T01:11:18.85611283Z
deletion_time    n/a
destroyed        false
version          1

====== Data ======
Key         Value
---         -----
password    snortymcsnortyton


[r-user@c-test] vault kv get kv-blog/deepak/email

====== Metadata ======
Key              Value
---              -----
created_time     2020-03-10T01:11:29.400336446Z
deletion_time    n/a
destroyed        false
version          1

====== Data ======
Key         Value
---         -----
password    doesntlooklikeanythingtome

Negative Tests. Expect failures

Test KV gets to disallowed paths

[r-user@c-test] vault kv get kv-blog/hr/servers/hr/root

Error reading kv-blog/data/hr/servers/hr/root: Error making API request.

URL: GET http://172.18.1.104:8200/v1/kv-blog/data/hr/servers/hr/root
Code: 403. Errors:

* 1 error occurred:
        * permission denied




[r-user@c-test] vault kv get kv-blog/hr/routers/snmp/read-write

Error reading kv-blog/data/hr/routers/snmp/read-write: Error making API request.

URL: GET http://172.18.1.104:8200/v1/kv-blog/data/hr/routers/snmp/read-write
Code: 403. Errors:

* 1 error occurred:
        * permission denied



Test KV puts to disallowed paths

[r-user@c-test] vault kv put kv-blog/hr/servers/hr/root password=rootntootn

Error writing data to kv-blog/data/hr/servers/hr/root: Error making API request.

URL: PUT http://172.18.1.104:8200/v1/kv-blog/data/hr/servers/hr/root
Code: 403. Errors:

* 1 error occurred:
        * permission denied




[r-user@c-test] vault kv put kv-blog/hr/routers/snmp/read-write password=snortymcsnortyton

Error writing data to kv-blog/data/hr/routers/snmp/read-write: Error making API request.

URL: PUT http://172.18.1.104:8200/v1/kv-blog/data/hr/routers/snmp/read-write
Code: 403. Errors:

* 1 error occurred:
        * permission denied



Check against another user's path controlled by ACL templating

[r-user@c-test] vault kv put kv-blog/alice/email password=doesntlooklikeanythingtome

Error writing data to kv-blog/data/alice/email: Error making API request.

URL: PUT http://172.18.1.104:8200/v1/kv-blog/data/alice/email
Code: 403. Errors:

* 1 error occurred:
        * permission denied



Test access to database endpoints

[r-user@c-test] vault read db-blog/creds/mother-full-read-1m

Error reading db-blog/creds/mother-full-read-1m: Error making API request.

URL: GET http://172.18.1.104:8200/v1/db-blog/creds/mother-full-read-1m
Code: 403. Errors:

* 1 error occurred:
        * permission denied








使用docker的数据库之前，docker权限需要先进行调整：
[r-user@c-test vault_essential_patterns_blog]$ docker run hello-world
docker: Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Post http://%2Fvar%2Frun%2Fdocker.sock/v1.40/containers/create: dial unix /var/run/docker.sock: connect: permission denied.
See 'docker run --help'.
[r-user@c-test vault_essential_patterns_blog]$ ll /var/run/docker.sock
srw-rw---- 1 root docker 0 Mar  9 12:53 /var/run/docker.sock
[r-user@c-test vault_essential_patterns_blog]$ grep -i docker /etc/group
docker:x:991:
[r-user@c-test vault_essential_patterns_blog]$ sudo gpasswd -a r-user docker
Adding user r-user to group docker
[r-user@c-test vault_essential_patterns_blog]$ grep -i docker /etc/group
docker:x:991:r-user
[r-user@c-test vault_essential_patterns_blog]$ exit
logout
Connection to 172.18.1.104 closed.
[r-user@test-vm ~]$ ssh -i sample-key-001.pem r-user@172.18.1.104
Last login: Tue Mar 10 09:15:24 2020 from 172.18.1.107
-----
CentOS Linux release 7.6.1810 (Core)
Linux 3.10.0-957.12.2.el7.x86_64 x86_64

To run a command as administrator (user root), please use sudo <command>.
-----
[r-user@c-test ~]$ docker run hello-world
Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
1b930d010525: Pull complete
Digest: sha256:fc6a51919cfeb2e6763f62b6d9e8815acbf7cd2e476ea353743570610737b752
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/






[r-user@c-test vault_essential_patterns_blog]$ ./test_engineering.sh

Running: ./test_engineering.sh: Testing Engineering requirements
Logging in with the memberOf overlay, notice the path difference
Ensure the root token isn't being used

[r-user@c-test] unset VAULT_TOKEN



[r-user@c-test] vault login -method=ldap -path=ldap-mo username=chun password=thispasswordsucks

Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                    Value
---                    -----
token                  s.w8Pp9wVoGU28xUiViqtyRus4
token_accessor         zLIlm6ksdir1nQyXKVDJESkU
token_duration         768h
token_renewable        true
token_policies         ["db-engineering" "default" "kv-user-template"]
identity_policies      []
policies               ["db-engineering" "default" "kv-user-template"]
token_meta_username    chun

Read out the dynamic DB credentials and store them as variables

Getting dynamic db credentials from Vault. There are more elegant ways of doing this, but OSX doesn't support process substitution in its version of Bash, so working around (e.g. source <(cmd))


注意这里我们用LDAP的方式登录账号并且获得对应的policy所规定的权限（再上面的it登录也是同样的），同时得到token。那么不适用LDAP这种auth方式，直接用token方式也可以得到权限：
vault token create -policy="xxx"
or
vault write auth/token/create policies=xxx
所以token方式进行auth是很危险的一种操作，这个权限应该对最终客户是禁止的。




[r-user@c-test] vault read -format=json db-blog/creds/mother-engineering-full-1h | jq -r '.data | .["PGUSER"] = .username | .["PGPASSWORD"] = .password | del(.username, .password) | to_entries | .[] | .key + "=" + .value ' > .temp_db_creds
通过这个命令vault会去找数据库生成一个动态的credential，然后把相关参数写入命令最后的那个文件中。
这个操作方式就是所谓的“Secrets as a Service”。


[r-user@c-test] . .temp_db_creds && rm .temp_db_creds


By setting the postgres environment variables to the dynamic creds, we can run PSQL with those dynamic creds

[r-user@c-test] export PGUSER=v-ldap-mo--mother-e-RkVsMgBa00mRa4InWsnh-1583804299 PGPASSWORD=A1a-TLS2HRKaYAVjlcWB


Turn off globbing for the database query in an environment variable

[r-user@c-test] set -o noglob



[r-user@c-test] QUERY='select name,description from engineering.catalog;'



[r-user@c-test] psql

       name        |                description
-------------------+-------------------------------------------
 Thromdibulator    | Complex machine, do not disassemble
 Visi-Sonor        | Musical instrument with visualizations
 Deep Thought      | Super Computer
 Mithril Vest      | Very Good Armor (TM)
 Blaine the Mono   | Psychopathic train, enjoys proper riddles
 Millennium Falcon | Fastest Hunk-of-Junk in the Galaxy
 Sonic Screwdriver | Multi-tool
(7 rows)


Use the dynamic ACL policy to write to a KV location under this user name

[r-user@c-test] vault kv put kv-blog/chun/passwords laptop=legleglegleg cameras=bigbagofnope

Key              Value
---              -----
created_time     2020-03-10T01:38:25.3798821Z
deletion_time    n/a
destroyed        false
version          3


[r-user@c-test] vault kv get kv-blog/chun/passwords

====== Metadata ======
Key              Value
---              -----
created_time     2020-03-10T01:38:25.3798821Z
deletion_time    n/a
destroyed        false
version          3

===== Data =====
Key        Value
---        -----
cameras    bigbagofnope
laptop     legleglegleg

Negative Tests. Expect failures
Can these credentials be used to query the HR schema?

[r-user@c-test] QUERY='select * from hr.people;'



[r-user@c-test] psql

ERROR:  permission denied for schema hr
LINE 1: select * from hr.people;
                      ^

Can the Vault token read from other areas?

[r-user@c-test] vault read db-blog/creds/mother-full-read-1h

Error reading db-blog/creds/mother-full-read-1h: Error making API request.

URL: GET http://172.18.1.104:8200/v1/db-blog/creds/mother-full-read-1h
Code: 403. Errors:

* 1 error occurred:
        * permission denied




[r-user@c-test] vault kv get kv-blog/it/servers/hr/root

Error reading kv-blog/data/it/servers/hr/root: Error making API request.

URL: GET http://172.18.1.104:8200/v1/kv-blog/data/it/servers/hr/root
Code: 403. Errors:

* 1 error occurred:
        * permission denied







HR Dynamic DB and transit tests
[r-user@c-test vault_essential_patterns_blog]$ ./test_hr.sh

Running: ./test_hr.sh: Testing HR requirements
Logging in with the memberOf overlay, notice the path difference
Ensure the root token isn't being used

[r-user@c-test] unset VAULT_TOKEN



[r-user@c-test] vault login -method=ldap -path=ldap-mo username=frank password=thispasswordsucks

Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                    Value
---                    -----
token                  s.xCGsapJ4GeRCM8mZHIWW44qb
token_accessor         vgP0hIwyBU9vrs1PQIFa4kJT
token_duration         768h
token_renewable        true
token_policies         ["db-hr" "default" "kv-user-template" "transit-hr"]
identity_policies      []
policies               ["db-hr" "default" "kv-user-template" "transit-hr"]
token_meta_username    frank

Read out the dynamic DB credentials and store them as variables

Getting dynamic db credentials from Vault. There are more elegant ways of doing this, but this shows the process well

[r-user@c-test] vault read -format=json db-blog/creds/mother-hr-full-1h | jq -r '.data | .["PGUSER"] = .username | .["PGPASSWORD"] = .password | del(.username, .password) | to_entries | .[] | .key + "=" + .value ' > .temp_db_creds



[r-user@c-test] . .temp_db_creds && rm .temp_db_creds


By setting the postgres environment variables to the dynamic creds, we can run PSQL with those dynamic creds

[r-user@c-test] export PGUSER=v-ldap-mo--mother-h-p6ERbOuLzHNjoS3OZyBv-1583804533 PGPASSWORD=A1a-0V2JJW3NAKfwdxYy


Turn off globbing for the database query in an environment variable so it doesn't pick up file names instead

[r-user@c-test] set -o noglob



[r-user@c-test] QUERY='select email,id from hr.people;'



[r-user@c-test] psql

       email        |         id
--------------------+--------------------
 alice@ourcorp.com  | 123-45-6789
 bob@ourcorp.com    | 234-56-7890
 chun@ourcorp.com   | 350322197001015332
 deepak@ourcorp.com | 0123 4567 8901
 eve@ourcorp.com    | AB 12 34 56 Z
 frank@ourcorp.com  | 678-90-1234
(6 rows)


Find an existing user id and encrypt it
WARNING!   When doing this in production, it's best to schedule a maintenance window unless your application logic can consume both encrypted and unencrypted values


[r-user@c-test] QUERY="select id from hr.people where email='alice@ourcorp.com'"



[r-user@c-test] user_id=$(psql)


user_id = 123-45-6789

[r-user@c-test] enc_id=$(vault write -field=ciphertext transit-blog/encrypt/hr plaintext=$( base64 <<< ${user_id} ) )

插播一个批注：
transit secrets engine所支持的key type包括：
As of now, the transit secrets engine supports the following key types (all key types also generate separate HMAC keys):

    aes128-gcm96: AES-GCM with a 128-bit AES key and a 96-bit nonce; supports encryption, decryption, key derivation, and convergent encryption
    aes256-gcm96: AES-GCM with a 256-bit AES key and a 96-bit nonce; supports encryption, decryption, key derivation, and convergent encryption (default)
    chacha20-poly1305: ChaCha20-Poly1305 with a 256-bit key; supports encryption, decryption, key derivation, and convergent encryption
    ed25519: Ed25519; supports signing, signature verification, and key derivation
    ecdsa-p256: ECDSA using curve P-256; supports signing and signature verification
    ecdsa-p384: ECDSA using curve P-384; supports signing and signature verification
    ecdsa-p521: ECDSA using curve P-521; supports signing and signature verification
    rsa-2048: 2048-bit RSA key; supports encryption, decryption, signing, and signature verification
    rsa-4096: 4096-bit RSA key; supports encryption, decryption, signing, and signature verification


[r-user@c-test] QUERY="UPDATE hr.people SET id='${enc_id}' WHERE email='alice@ourcorp.com'"



[r-user@c-test] psql

UPDATE 1


[r-user@c-test] QUERY="select email,id from hr.people"



[r-user@c-test] psql

       email        |                                id
--------------------+-------------------------------------------------------------------
 bob@ourcorp.com    | 234-56-7890
 chun@ourcorp.com   | 350322197001015332
 deepak@ourcorp.com | 0123 4567 8901
 eve@ourcorp.com    | AB 12 34 56 Z
 frank@ourcorp.com  | 678-90-1234
 alice@ourcorp.com  | vault:v1:z9hSiyKIv9ojajKquJTCP2kAUq0uwoTmlHUgA3n7nAOzsb6pVYXyazU=
(6 rows)


This is the process your applications will use when data is encrypted with Vault

[r-user@c-test] QUERY="select id from hr.people where email='alice@ourcorp.com'"



[r-user@c-test] enc_user_id=$(psql)


enc_user_id = vault:v1:z9hSiyKIv9ojajKquJTCP2kAUq0uwoTmlHUgA3n7nAOzsb6pVYXyazU=

[r-user@c-test] user_id=$(vault write -field=plaintext transit-blog/decrypt/hr ciphertext=${enc_user_id} | base64 --decode)



[r-user@c-test] echo ${user_id}

123-45-6789

Notice the value is still encrypted in the database.   It should only decrypted by your applications when needed to be displayed

[r-user@c-test] QUERY="select email,id from hr.people"



[r-user@c-test] psql

       email        |                                id
--------------------+-------------------------------------------------------------------
 bob@ourcorp.com    | 234-56-7890
 chun@ourcorp.com   | 350322197001015332
 deepak@ourcorp.com | 0123 4567 8901
 eve@ourcorp.com    | AB 12 34 56 Z
 frank@ourcorp.com  | 678-90-1234
 alice@ourcorp.com  | vault:v1:z9hSiyKIv9ojajKquJTCP2kAUq0uwoTmlHUgA3n7nAOzsb6pVYXyazU=
(6 rows)



Negative Tests. Expect failures
Try to query the engineering schema from here.

[r-user@c-test] QUERY="select * from engineering.catalog"



[r-user@c-test] psql

ERROR:  permission denied for schema engineering
LINE 1: select * from engineering.catalog
                      ^

Can the Vault token read from other areas?

[r-user@c-test] vault read db-blog/creds/mother-full-read-1h

Error reading db-blog/creds/mother-full-read-1h: Error making API request.

URL: GET http://172.18.1.104:8200/v1/db-blog/creds/mother-full-read-1h
Code: 403. Errors:

* 1 error occurred:
        * permission denied




[r-user@c-test] vault kv get kv-blog/it/servers/hr/root

Error reading kv-blog/data/it/servers/hr/root: Error making API request.

URL: GET http://172.18.1.104:8200/v1/kv-blog/data/it/servers/hr/root
Code: 403. Errors:

* 1 error occurred:
        * permission denied



If you want to re-run this demo, you should restart the database: docker kill postgres && ./1_launch_db.sh







最后进行cleanup：
[r-user@c-test vault_essential_patterns_blog]$ docker kill postgres openldap
postgres
openldap


★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★

★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★






关于Token的一些测试。

Batch token demo:
[r-user@c-test vault_essential_patterns_blog]$ . env.sh
[r-user@c-test vault_essential_patterns_blog]$ vault auth
disable  enable   help     list     tune
[r-user@c-test vault_essential_patterns_blog]$ vault auth list
Path         Type        Accessor                  Description
----         ----        --------                  -----------
ldap-mo/     ldap        auth_ldap_67eec4dd        n/a
ldap-um/     ldap        auth_ldap_8a7d696a        n/a
token/       token       auth_token_bde75e77       token based credentials
userpass/    userpass    auth_userpass_b8272cc7    n/a
[r-user@c-test vault_essential_patterns_blog]$ vault auth enable approle
Success! Enabled approle auth method at: approle/
[r-user@c-test vault_essential_patterns_blog]$ vault write auth/approle/role/billing policies="billing" token_type="batch"
Success! Data written to: auth/approle/role/billing
[r-user@c-test vault_essential_patterns_blog]$ vault read auth/approle/role/billing/role-id
Key        Value
---        -----
role_id    a1feb1f7-a8f4-e4b0-59c1-a8a495b06ffc
[r-user@c-test vault_essential_patterns_blog]$ vault write -f auth/approle/role/billing/secret-id
Key                   Value
---                   -----
secret_id             bd5c79b3-31b1-ee3d-c6ed-a3c533411a8e
secret_id_accessor    0b49afc9-c2f8-a81f-191b-2f6ab6bb87e4
[r-user@c-test vault_essential_patterns_blog]$ vault write auth/approle/login role_id=a1feb1f7-a8f4-e4b0-59c1-a8a495b06ffc secret_id=bd5c79b3-31b1-ee3d-c6ed-a3c533411a8e
Key                     Value
---                     -----
token                   b.AAAAAQJVwxcAujTSrHT9oYOQTReeJzMCBy4ZVlgg6UEBx4WmXlVdtsC2hEMthlLVL4uKEraZhOz08TTbs_JzHvEYnKexrlQWEVbh55IEeEfyVxwVzm4knrdMZoYY8gzP8EWnL569zjfKWp2xqOKu2Hd0qi07dOFic7ZOP3CB6K5RALg988ZJjJYfgxIcQOrAcBJgvh4mqMr1X05w_oQuM35DXyZs
token_accessor          n/a
token_duration          768h
token_renewable         false
token_policies          ["billing" "default"]
identity_policies       []
policies                ["billing" "default"]
token_meta_role_name    billing
[r-user@c-test vault_essential_patterns_blog]$ vault token lookup b.AAAAAQJVwxcAujTSrHT9oYOQTReeJzMCBy4ZVlgg6UEBx4WmXlVdtsC2hEMthlLVL4uKEraZhOz08TTbs_JzHvEYnKexrlQWEVbh55IEeEfyVxwVzm4knrdMZoYY8gzP8EWnL569zjfKWp2xqOKu2Hd0qi07dOFic7ZOP3CB6K5RALg988ZJjJYfgxIcQOrAcBJgvh4mqMr1X05w_oQuM35DXyZs
Key                 Value
---                 -----
accessor            n/a
creation_time       1583806414
creation_ttl        768h
display_name        approle
entity_id           e56ab9dd-7093-c8a7-5c61-3e11621926d3
expire_time         2020-04-11T11:13:34+09:00
explicit_max_ttl    0s
id                  b.AAAAAQJVwxcAujTSrHT9oYOQTReeJzMCBy4ZVlgg6UEBx4WmXlVdtsC2hEMthlLVL4uKEraZhOz08TTbs_JzHvEYnKexrlQWEVbh55IEeEfyVxwVzm4knrdMZoYY8gzP8EWnL569zjfKWp2xqOKu2Hd0qi07dOFic7ZOP3CB6K5RALg988ZJjJYfgxIcQOrAcBJgvh4mqMr1X05w_oQuM35DXyZs
issue_time          2020-03-10T11:13:34+09:00
meta                map[role_name:billing]
num_uses            0
orphan              true
path                auth/approle/login
policies            [billing default]
renewable           false
ttl                 767h59m43s
type                batch


这个login并不会增加vault read /sys/internal/counters/tokens和entities中的计数。
audit中也没有出现token create的记录。



Token被revoke之后则不计算入token数量之中。

[r-user@c-test vault_essential_patterns_blog]$ vault read /sys/internal/counters/tokens
Key         Value
---         -----
counters    map[service_tokens:map[total:12]]
[r-user@c-test vault_essential_patterns_blog]$ vault token create -ttl=60
Key                  Value
---                  -----
token                s.O6SIB1HtPDTfBKQDDyZ9T4ls
token_accessor       dPh5U6Q314iVrnVgnpLxVzv5
token_duration       1m
token_renewable      true
token_policies       ["root"]
identity_policies    []
policies             ["root"]
[r-user@c-test vault_essential_patterns_blog]$ vault read /sys/internal/counters/tokens
Key         Value
---         -----
counters    map[service_tokens:map[total:13]]
[r-user@c-test vault_essential_patterns_blog]$ vault token lookup s.O6SIB1HtPDTfBKQDDyZ9T4ls
Key                 Value
---                 -----
accessor            dPh5U6Q314iVrnVgnpLxVzv5
creation_time       1583808271
creation_ttl        1m
display_name        token
entity_id           n/a
expire_time         2020-03-10T11:45:31.771414+09:00
explicit_max_ttl    0s
id                  s.O6SIB1HtPDTfBKQDDyZ9T4ls
issue_time          2020-03-10T11:44:31.77143003+09:00
meta                <nil>
num_uses            0
orphan              false
path                auth/token/create
policies            [root]
renewable           true
ttl                 44s
type                service
一分钟经过之后：
[r-user@c-test vault_essential_patterns_blog]$ vault token lookup s.O6SIB1HtPDTfBKQDDyZ9T4ls
Error looking up token: Error making API request.

URL: POST http://172.18.1.104:8200/v1/auth/token/lookup
Code: 403. Errors:

* bad token
[r-user@c-test vault_essential_patterns_blog]$ vault read /sys/internal/counters/tokens
Key         Value
---         -----
counters    map[service_tokens:map[total:12]]

token数量自动减一。





Tune the default TTLs
如果不明确指定，token会被赋予缺省的TTL值。系统缺省max TTL为32天，但是你可以修改这些缺省值。
这些值存放在这个endpoint里面： /sys/auth/<METHOD>/tune。举例：
[r-user@c-test vault_essential_patterns_blog]$ vault read sys/auth/approle/tune
Key                  Value
---                  -----
default_lease_ttl    768h
force_no_cache       false
max_lease_ttl        768h
token_type           default-service







★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★

★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★

做个Versioned Key/Value Secrets Engine的测试。

先准备一个指定policy的token
[r-user@c-test ~]$ cat test.hcl
# Write and manage secrets in key-value secrets engine
path "secret/*" {
  capabilities = ["create", "read", "update", "delete", "list"]
}
# To enable secrets engines
path "sys/mounts/*" {
  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}
# 专门用来允许secrets list操作的
path "sys/mounts" {
  capabilities = ["read"]
}

[r-user@c-test ~]$ vault policy fmt test.hcl
Success! Formatted policy: test.hcl

[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$
[r-user@c-test ~]$ vault auth list
Path         Type        Accessor                  Description
----         ----        --------                  -----------
approle/     approle     auth_approle_f02e7bec     n/a
ldap-mo/     ldap        auth_ldap_67eec4dd        n/a
ldap-um/     ldap        auth_ldap_8a7d696a        n/a
token/       token       auth_token_bde75e77       token based credentials
userpass/    userpass    auth_userpass_b8272cc7    n/a
[r-user@c-test ~]$ vault read sys/policy
Key         Value
---         -----
keys        [autounseal db-engineering db-full-read db-hr default kv-it kv-user-template transit-hr root]
policies    [autounseal db-engineering db-full-read db-hr default kv-it kv-user-template transit-hr root]
[r-user@c-test ~]$ vault policy list
autounseal
db-engineering
db-full-read
db-hr
default
kv-it
kv-user-template
transit-hr
root
[r-user@c-test ~]$ vault policy write testpolicy test.hcl
Success! Uploaded policy: testpolicy
[r-user@c-test ~]$ vault policy list
autounseal
db-engineering
db-full-read
db-hr
default
kv-it
kv-user-template
testpolicy
transit-hr
root
[r-user@c-test ~]$ vault policy read testpolicy
# Write and manage secrets in key-value secrets engine
path "secret/*" {
  capabilities = ["create", "read", "update", "delete", "list"]
}

# To enable secrets engines
path "sys/mounts/*" {
  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}

path "sys/mounts" {
  capabilities = ["read"]
}

[r-user@c-test ~]$ vault read sys/policy/testpolicy
Key      Value
---      -----
name     testpolicy
rules    # Write and manage secrets in key-value secrets engine
path "secret/*" {
  capabilities = ["create", "read", "update", "delete", "list"]
}

# To enable secrets engines
path "sys/mounts/*" {
  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}

path "sys/mounts" {
  capabilities = ["read"]
}


[r-user@c-test ~]$ vault token create -policy=testpolicy
Key                  Value
---                  -----
token                s.qn0GS2U0DE3C9HutyLUQNqiQ
token_accessor       1sbhWpGOL1RxOSrKVp7ZUdrd
token_duration       768h
token_renewable      true
token_policies       ["default" "testpolicy"]
identity_policies    []
policies             ["default" "testpolicy"]
[r-user@c-test ~]$
token总数会加1，而entities的数量是不变的。
[r-user@c-test ~]$ vault read /sys/internal/counters/tokens
Key         Value
---         -----
counters    map[service_tokens:map[total:13]]


[r-user@c-test ~]$ unset VAULT_TOKEN
[r-user@c-test ~]$ vault login s.qn0GS2U0DE3C9HutyLUQNqiQ
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                s.qn0GS2U0DE3C9HutyLUQNqiQ
token_accessor       1sbhWpGOL1RxOSrKVp7ZUdrd
token_duration       767h58m33s
token_renewable      true
token_policies       ["default" "testpolicy"]
identity_policies    []
policies             ["default" "testpolicy"]
[r-user@c-test ~]$ vault token lookup
Key                 Value
---                 -----
accessor            1sbhWpGOL1RxOSrKVp7ZUdrd
creation_time       1583816293
creation_ttl        768h
display_name        token
entity_id           n/a
expire_time         2020-04-11T13:58:13.269967053+09:00
explicit_max_ttl    0s
id                  s.qn0GS2U0DE3C9HutyLUQNqiQ
issue_time          2020-03-10T13:58:13.269983863+09:00
meta                <nil>
num_uses            0
orphan              false
path                auth/token/create
policies            [default testpolicy]
renewable           true
ttl                 767h35m
type                service

[r-user@c-test ~]$ vault secrets enable -path=secret kv-v2
Success! Enabled the kv-v2 secrets engine at: secret/

[r-user@c-test ~]$ vault secrets list -detailed
Path             Plugin       Accessor              Default TTL    Max TTL    Force No Cache    Replication    Seal Wrap    External Entropy Access    Options           Description                                                UUID
----             ------       --------              -----------    -------    --------------    -----------    ---------    -----------------------    -------           -----------                                                ----
cubbyhole/       cubbyhole    cubbyhole_f5c3463a    n/a            n/a        false             local          false        false                      map[]             per-token private secret storage                           50fff2c8-2b06-eacd-89f9-7656989b1200
db-blog/         database     database_28bd9ab8     system         system     false             replicated     false        false                      map[]             n/a                                                        1d0c42e8-6d79-2e84-e201-ae554a2f2fa5
identity/        identity     identity_530fa6bb     system         system     false             replicated     false        false                      map[]             identity store                                             92fb0dc3-8832-dc88-ce18-0311f2e17b61
kv-blog/         kv           kv_4a925e4f           system         system     false             replicated     false        false                      map[version:2]    n/a                                                        2fb78806-c809-af3d-e95a-307da5343416
secret/          kv           kv_b8d65ea9           system         system     false             replicated     false        false                      map[version:2]    n/a                                                        078dde66-bdcd-c9e0-4b2a-964138bedecf
sys/             system       system_579f9320       n/a            n/a        false             replicated     false        false                      map[]             system endpoints used for control, policy and debugging    8a24c4ec-5bca-dad8-cc0d-7576feec212b
transit-blog/    transit      transit_1b6543f5      system         system     false             replicated     false        false                      map[]             n/a                                                        ae48f00b-91f9-3855-590e-2c6335e7186f
transit/         transit      transit_aa73f134      system         system     false             replicated     false        false                      map[]             n/a                                                        a4024000-5f60-3408-d5e2-4cea8bc14e36

[r-user@c-test ~]$ vault kv put secret/customer/acme name="ACME Inc." contact_email="jsmith@acme.com"
Key              Value
---              -----
created_time     2020-03-10T08:08:06.873567318Z
deletion_time    n/a
destroyed        false
version          1
进行数据的update
[r-user@c-test ~]$ vault kv put secret/customer/acme name="ACME Inc." contact_email="john.smith@acme.com"
Key              Value
---              -----
created_time     2020-03-10T08:18:09.021503526Z
deletion_time    n/a
destroyed        false
version          2
[r-user@c-test ~]$ vault kv get secret/customer/acme
====== Metadata ======
Key              Value
---              -----
created_time     2020-03-10T08:18:09.021503526Z
deletion_time    n/a
destroyed        false
version          2

======== Data ========
Key              Value
---              -----
contact_email    john.smith@acme.com
name             ACME Inc.

只update一个值而不改变其他值使用patch命令：
[r-user@c-test ~]$ vault kv patch secret/customer/acme contact_email="admin@acme.com"
Key              Value
---              -----
created_time     2020-03-10T08:22:31.677859492Z
deletion_time    n/a
destroyed        false
version          3
[r-user@c-test ~]$ vault kv get secret/customer/acme
====== Metadata ======
Key              Value
---              -----
created_time     2020-03-10T08:22:31.677859492Z
deletion_time    n/a
destroyed        false
version          3

======== Data ========
Key              Value
---              -----
contact_email    admin@acme.com
name             ACME Inc.
如果使用put的话会意外的丢数据：
[r-user@c-test ~]$ vault kv put secret/customer/acme contact_email="admin@acme.com"
Key              Value
---              -----
created_time     2020-03-10T08:23:39.501480617Z
deletion_time    n/a
destroyed        false
version          4
[r-user@c-test ~]$
[r-user@c-test ~]$ vault kv get secret/customer/acme
====== Metadata ======
Key              Value
---              -----
created_time     2020-03-10T08:23:39.501480617Z
deletion_time    n/a
destroyed        false
version          4

======== Data ========
Key              Value
---              -----
contact_email    admin@acme.com

读取第一个版本：
[r-user@c-test ~]$ vault kv get -version=1 secret/customer/acme
====== Metadata ======
Key              Value
---              -----
created_time     2020-03-10T08:08:06.873567318Z
deletion_time    n/a
destroyed        false
version          1

======== Data ========
Key              Value
---              -----
contact_email    jsmith@acme.com
name             ACME Inc.

读取metadata：
[r-user@c-test ~]$ vault kv metadata get secret/customer/acme
========== Metadata ==========
Key                     Value
---                     -----
cas_required            false
created_time            2020-03-10T08:08:06.873567318Z
current_version         4
delete_version_after    0s
max_versions            0
oldest_version          0
updated_time            2020-03-10T08:23:39.501480617Z

====== Version 1 ======
Key              Value
---              -----
created_time     2020-03-10T08:08:06.873567318Z
deletion_time    n/a
destroyed        false

====== Version 2 ======
Key              Value
---              -----
created_time     2020-03-10T08:18:09.021503526Z
deletion_time    n/a
destroyed        false

====== Version 3 ======
Key              Value
---              -----
created_time     2020-03-10T08:22:31.677859492Z
deletion_time    n/a
destroyed        false

====== Version 4 ======
Key              Value
---              -----
created_time     2020-03-10T08:23:39.501480617Z
deletion_time    n/a
destroyed        false



By default, the kv-v2 secrets engine keeps up to 10 versions. Let's limit the maximum number of versions to keep to be 4.
[r-user@c-test ~]$ vault write secret/config max_versions=4
Success! Data written to: secret/config
[r-user@c-test ~]$ vault read secret/config
Key             Value
---             -----
cas_required    false
max_versions    4

Or, to limit the number of versions only on the secret/customer/acme path rather than the entire secret/ engine:
[r-user@c-test ~]$ vault kv metadata put -max-versions=4 secret/customer/acme
Success! Data written to: secret/metadata/customer/acme
[r-user@c-test ~]$ vault read secret/metadata/customer/acme
Key                     Value
---                     -----
cas_required            false
created_time            2020-03-10T08:08:06.873567318Z
current_version         4
delete_version_after    0s
max_versions            4
oldest_version          0
updated_time            2020-03-10T08:23:39.501480617Z
versions                map[1:map[created_time:2020-03-10T08:08:06.873567318Z deletion_time: destroyed:false] 2:map[created_time:2020-03-10T08:18:09.021503526Z deletion_time: destroyed:false] 3:map[created_time:2020-03-10T08:22:31.677859492Z deletion_time: destroyed:false] 4:map[created_time:2020-03-10T08:23:39.501480617Z deletion_time: destroyed:false]]

再update几次，发现4次以前的版本已经永久删除，再也不可能恢复了：
[r-user@c-test ~]$ vault kv patch secret/customer/acme contact_email="admin1@acme.com"
Key              Value
---              -----
created_time     2020-03-10T08:36:11.09780446Z
deletion_time    n/a
destroyed        false
version          5
[r-user@c-test ~]$ vault kv patch secret/customer/acme contact_email="admin2@acme.com"
Key              Value
---              -----
created_time     2020-03-10T08:36:15.562135464Z
deletion_time    n/a
destroyed        false
version          6
[r-user@c-test ~]$ vault kv patch secret/customer/acme contact_email="admin3@acme.com"
Key              Value
---              -----
created_time     2020-03-10T08:36:18.863385918Z
deletion_time    n/a
destroyed        false
version          7
[r-user@c-test ~]$ vault kv metadata get secret/customer/acme
========== Metadata ==========
Key                     Value
---                     -----
cas_required            false
created_time            2020-03-10T08:08:06.873567318Z
current_version         7
delete_version_after    0s
max_versions            4
oldest_version          4
updated_time            2020-03-10T08:36:18.863385918Z

====== Version 4 ======
Key              Value
---              -----
created_time     2020-03-10T08:23:39.501480617Z
deletion_time    n/a
destroyed        false

====== Version 5 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:11.09780446Z
deletion_time    n/a
destroyed        false

====== Version 6 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:15.562135464Z
deletion_time    n/a
destroyed        false

====== Version 7 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:18.863385918Z
deletion_time    n/a
destroyed        false

删除
[r-user@c-test ~]$ vault kv delete -versions="4,5" secret/customer/acme
Success! Data deleted (if it existed) at: secret/customer/acme
[r-user@c-test ~]$ vault kv metadata get secret/customer/acme
========== Metadata ==========
Key                     Value
---                     -----
cas_required            false
created_time            2020-03-10T08:08:06.873567318Z
current_version         7
delete_version_after    0s
max_versions            4
oldest_version          4
updated_time            2020-03-10T08:36:18.863385918Z

====== Version 4 ======
Key              Value
---              -----
created_time     2020-03-10T08:23:39.501480617Z
deletion_time    2020-03-10T08:39:31.282248874Z
destroyed        false

====== Version 5 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:11.09780446Z
deletion_time    2020-03-10T08:39:31.282249337Z
destroyed        false

====== Version 6 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:15.562135464Z
deletion_time    n/a
destroyed        false

====== Version 7 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:18.863385918Z
deletion_time    n/a
destroyed        false
此时并没有destroy，还可以反悔：
[r-user@c-test ~]$ vault kv undelete -versions=5 secret/customer/acme
Success! Data written to: secret/undelete/customer/acme
[r-user@c-test ~]$ vault kv metadata get secret/customer/acme
========== Metadata ==========
Key                     Value
---                     -----
cas_required            false
created_time            2020-03-10T08:08:06.873567318Z
current_version         7
delete_version_after    0s
max_versions            4
oldest_version          4
updated_time            2020-03-10T08:36:18.863385918Z

====== Version 4 ======
Key              Value
---              -----
created_time     2020-03-10T08:23:39.501480617Z
deletion_time    2020-03-10T08:39:31.282248874Z
destroyed        false

====== Version 5 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:11.09780446Z
deletion_time    n/a
destroyed        false

====== Version 6 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:15.562135464Z
deletion_time    n/a
destroyed        false

====== Version 7 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:18.863385918Z
deletion_time    n/a
destroyed        false

永久删除：
[r-user@c-test ~]$ vault kv destroy -versions=4 secret/customer/acme
Success! Data written to: secret/destroy/customer/acme
[r-user@c-test ~]$ vault kv metadata get secret/customer/acme
========== Metadata ==========
Key                     Value
---                     -----
cas_required            false
created_time            2020-03-10T08:08:06.873567318Z
current_version         7
delete_version_after    0s
max_versions            4
oldest_version          4
updated_time            2020-03-10T08:36:18.863385918Z

====== Version 4 ======
Key              Value
---              -----
created_time     2020-03-10T08:23:39.501480617Z
deletion_time    2020-03-10T08:39:31.282248874Z
destroyed        true

====== Version 5 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:11.09780446Z
deletion_time    n/a
destroyed        false

====== Version 6 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:15.562135464Z
deletion_time    n/a
destroyed        false

====== Version 7 ======
Key              Value
---              -----
created_time     2020-03-10T08:36:18.863385918Z
deletion_time    n/a
destroyed        false
全部永久删除：
[r-user@c-test ~]$ vault kv metadata delete secret/customer/acme
Success! Data deleted (if it existed) at: secret/metadata/customer/acme
[r-user@c-test ~]$ vault kv metadata get secret/customer/acme
No value found at secret/metadata/customer/acme


定时删除数据，注意不是destroy：
[r-user@c-test ~]$ vault kv metadata put -delete-version-after=40s secret/test
Success! Data written to: secret/metadata/test
[r-user@c-test ~]$ vault kv put secret/test message="data1"
Key              Value
---              -----
created_time     2020-03-10T08:44:47.660241702Z
deletion_time    2020-03-10T08:45:27.660241702Z
destroyed        false
version          1
[r-user@c-test ~]$ vault kv put secret/test message="data2"
Key              Value
---              -----
created_time     2020-03-10T08:44:55.583633443Z
deletion_time    2020-03-10T08:45:35.583633443Z
destroyed        false
version          2
[r-user@c-test ~]$ vault kv put secret/test message="data3"
Key              Value
---              -----
created_time     2020-03-10T08:45:01.589336195Z
deletion_time    2020-03-10T08:45:41.589336195Z
destroyed        false
version          3
[r-user@c-test ~]$ vault kv metadata get secret/test
========== Metadata ==========
Key                     Value
---                     -----
cas_required            false
created_time            2020-03-10T08:44:40.769869883Z
current_version         3
delete_version_after    40s
max_versions            0
oldest_version          0
updated_time            2020-03-10T08:45:01.589336195Z

====== Version 1 ======
Key              Value
---              -----
created_time     2020-03-10T08:44:47.660241702Z
deletion_time    2020-03-10T08:45:27.660241702Z
destroyed        false

====== Version 2 ======
Key              Value
---              -----
created_time     2020-03-10T08:44:55.583633443Z
deletion_time    2020-03-10T08:45:35.583633443Z
destroyed        false

====== Version 3 ======
Key              Value
---              -----
created_time     2020-03-10T08:45:01.589336195Z
deletion_time    2020-03-10T08:45:41.589336195Z
destroyed        false

The v2 of KV secrets engine supports a Check-And-Set operation to prevent unintentional secret overwrite. 
By default, Check-And-Set operation is not enabled on the KV secrets engine; therefore write is always allowed (no checking is performed).
[r-user@c-test ~]$ vault read secret/config
Key             Value
---             -----
cas_required    false
max_versions    4
[r-user@c-test ~]$ vault write secret/config cas-required=true
Success! Data written to: secret/config
[r-user@c-test ~]$ vault read secret/config
Key             Value
---             -----
cas_required    false
max_versions    4
???

[r-user@c-test ~]$ vault kv metadata put -cas-required=true secret/partner
Success! Data written to: secret/metadata/partner
[r-user@c-test ~]$ vault read secret/metadata/partner
Key                     Value
---                     -----
cas_required            true
created_time            2020-03-10T08:51:43.883265756Z
current_version         0
delete_version_after    0s
max_versions            0
oldest_version          0
updated_time            2020-03-10T08:51:43.883265756Z
versions                map[]

If you are sure that you want to overwrite the existing key-value, set cas to match the current version. Set cas to 0 if you want to write the secret only if the key does not exists.
之后每次put数据都必须要指定cas值。
[r-user@c-test ~]$ vault kv put -cas=0 secret/partner name="Example Co." partner_id="123456789"
Key              Value
---              -----
created_time     2020-03-10T08:54:11.131891358Z
deletion_time    n/a
destroyed        false
version          1
[r-user@c-test ~]$ vault kv put -cas=1 secret/partner name="Example Co." partner_id="ABCDEFGHIJKLMN"
Key              Value
---              -----
created_time     2020-03-10T08:54:38.531643253Z
deletion_time    n/a
destroyed        false
version          2




★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★

★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★


Performance Benchmark
https://medium.com/hashicorp-engineering/hashicorp-vault-performance-benchmark-13d0ea7b703f


安装LUA
[r-user@c-test ~]$ sudo yum install gcc
cd /opt
wget http://luajit.org/download/LuaJIT-2.0.5.tar.gz
tar -zxvf LuaJIT-2.0.5.tar.gz
cd LuaJIT-2.0.5
make && make install
# or sudo make install if you are not 'root'

安装wrk
yum install https://extras.getpagespeed.com/release-el7-latest.rpm
yum install wrk
握草，竟然要花USD9.99进行subscribe后才能安装？！

sudo yum groupinstall 'Development Tools'
sudo yum install -y openssl-devel git 
git clone https://github.com/wg/wrk.git wrk
cd wrk
make
sudo cp wrk /usr/local/bin
安装wrk完毕。

git clone https://github.com/hashicorp/vault-guides.git
cd vault-guides/operations/benchmarking/wrk-core-vault-operations

[r-user@c-test wrk-core-vault-operations]$ vault list auth/userpass/users
Keys
----
mitchellh
[r-user@c-test wrk-core-vault-operations]$ vault read auth/userpass/users/mitchellh
Key                        Value
---                        -----
policies                   [admins]
token_bound_cidrs          []
token_explicit_max_ttl     0s
token_max_ttl              0s
token_no_default_policy    false
token_num_uses             0
token_period               0s
token_policies             [admins]
token_ttl                  0s
token_type                 default

[r-user@c-test wrk-core-vault-operations]$ vault write auth/userpass/users/loadtester password=benchmark policies=default
Success! Data written to: auth/userpass/users/loadtester

# Concurrent write of random secrets, with:
# 6 concurrent threads
# 16 connections per thread
# 20 seconds to run the test
# 1000 secrets to write
# Write benchmark results to file prod-test-write-1000-random-secrets-t6-c16-20sec.log

[r-user@c-test wrk-core-vault-operations]$ nohup wrk -t6 -c16 -d20s -H "X-Vault-Token: $VAULT_TOKEN" -s write-random-secrets.lua $VAULT_ADDR -- 10000 > prod-test-write-1000-random-secrets-t6-c16-20sec.log
nohup: ignoring input and redirecting stderr to stdout
[r-user@c-test wrk-core-vault-operations]$ ll
total 96
-rw-rw-r-- 1 r-user r-user  1703 Mar 16 12:48 authenticate-and-revoke.lua
-rw-rw-r-- 1 r-user r-user  1478 Mar 16 12:48 authenticate.lua
-rwxrwxr-x 1 r-user r-user  1525 Mar 16 12:48 delete-secrets.lua
-rw-rw-r-- 1 r-user r-user   533 Mar 16 12:53 env.sh
-rw-rw-r-- 1 r-user r-user 10014 Mar 16 12:48 json.lua
-rw-rw-r-- 1 r-user r-user 16725 Mar 16 12:48 LICENSE
-rw-rw-r-- 1 r-user r-user  1862 Mar 16 12:48 list-secrets.lua
-rw-rw-r-- 1 r-user r-user  1080 Mar 16 13:38 prod-test-write-1000-random-secrets-t6-c16-20sec.log
-rw-rw-r-- 1 r-user r-user 12692 Mar 16 12:48 README.md
-rw-rw-r-- 1 r-user r-user  2004 Mar 16 12:48 read-secrets.lua
-rwxrwxr-x 1 r-user r-user  3153 Mar 16 12:48 run_tests.sh
-rw-rw-r-- 1 r-user r-user  2828 Mar 16 12:48 write-delete-secrets.lua
-rw-rw-r-- 1 r-user r-user  1595 Mar 16 12:48 write-list.lua
-rw-rw-r-- 1 r-user r-user  1731 Mar 16 12:48 write-random-secrets.lua
-rw-rw-r-- 1 r-user r-user  1917 Mar 16 12:48 write-secrets.lua
[r-user@c-test wrk-core-vault-operations]$ cat prod-test-write-1000-random-secrets-t6-c16-20sec.log
Number of secrets is: 10000
thread 1 created
Number of secrets is: 10000
thread 2 created
Number of secrets is: 10000
thread 3 created
Number of secrets is: 10000
thread 4 created
Number of secrets is: 10000
thread 5 created
Number of secrets is: 10000
thread 6 created
Running 20s test @ http://172.18.1.104:8200
  6 threads and 16 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.62ms    2.70ms  35.55ms   81.63%
    Req/Sec   580.42     89.53     1.20k    68.15%
  69479 requests in 20.09s, 31.27MB read
  Non-2xx or 3xx responses: 69479
                            ^^^^^^
Requests/sec:   3458.74
Transfer/sec:      1.56MB
thread 1 made 11467 requests including 11467 writes and got 11465 responses
thread 2 made 11569 requests including 11569 writes and got 11569 responses
thread 3 made 11568 requests including 11568 writes and got 11568 responses
thread 4 made 11414 requests including 11414 writes and got 11414 responses
thread 5 made 11729 requests including 11729 writes and got 11727 responses
thread 6 made 11737 requests including 11737 writes and got 11736 responses

As you can see in bold, there were 69,479 responses, which matches the number of unsuccessful responses.
这也就是下面6个thread的responses之和。
这是因为我们已经有一个叫做secret的KV2类型的secret engine了。我们来解决这个问题。

# Update write-random-secrets.lua to the path "secret2"

sed -i -e 's+/v1/secret/+/v1/secret2/+g' write-random-secrets.lua
vault secrets enable -path secret2 -version 1 kv

[r-user@c-test wrk-core-vault-operations]$ nohup wrk -t1 -c1 -d20s -H "X-Vault-Token: $VAULT_TOKEN" -s write-random-secrets.lua $VAULT_ADDR -- 10000 > prod-test-write-1000-random-secrets-t6-c16-20sec.log &
[1] 16112
[r-user@c-test wrk-core-vault-operations]$ nohup: ignoring input and redirecting stderr to stdout
[1]+  Done                    nohup wrk -t1 -c1 -d20s -H "X-Vault-Token: $VAULT_TOKEN" -s write-random-secrets.lua $VAULT_ADDR -- 10000 > prod-test-write-1000-random-secrets-t6-c16-20sec.log

[r-user@c-test wrk-core-vault-operations]$ cat prod-test-write-1000-random-secrets-t6-c16-20sec.log
Number of secrets is: 10000
thread 1 created
Running 20s test @ http://172.18.1.104:8200
  1 threads and 1 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    12.38ms    1.59ms  24.49ms   86.82%
    Req/Sec    80.43      6.13    90.00     62.50%
  1609 requests in 20.04s, 190.13KB read
Requests/sec:     80.31
Transfer/sec:      9.49KB
thread 1 made 1611 requests including 1611 writes and got 1609 responses
这次貌似所有的请求都成功了。。。
[r-user@c-test wrk-core-vault-operations]$ vault kv list secret2
Keys
----
write-random-test-1
write-random-test-1002
write-random-test-1007
write-random-test-1009
write-random-test-1010
。。。。。。




★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★

★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★

https://github.com/hashicorp/terraform-azurerm-consul

■ 制作image

[r-user@test-vm ~]$ curl -o packer.zip https://releases.hashicorp.com/packer/1.5.4/packer_1.5.4_linux_amd64.zip
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 45.8M  100 45.8M    0     0  70.2M      0 --:--:-- --:--:-- --:--:-- 70.2M
[r-user@test-vm ~]$ git clone https://github.com/hashicorp/guides-configuration
Cloning into 'guides-configuration'...
remote: Enumerating objects: 1905, done.
remote: Total 1905 (delta 0), reused 0 (delta 0), pack-reused 1905
Receiving objects: 100% (1905/1905), 297.83 KiB | 452.00 KiB/s, done.
Resolving deltas: 100% (1185/1185), done.

# Set environment variables 
#If you need help getting or creating AWS API keys, you can find more information in https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/
export AWS_ACCESS_KEY_ID=[YOUR ACCESS KEY HERE]
export AWS_SECRET_ACCESS_KEY=[YOUR KEY HERE]
export AWS_DEFAULT_REGION=[DESIRED REGION HERE]export CONSUL_VERSION="1.7.1"
export VAULT_VERSION="1.3.2"

# You can use the enterprise URLs here if you prefer (will need to add license manually once deployed)export VAULT_ENT_URL="https://releases.hashicorp.com/vault/1.3.2/vault_1.3.2_linux_amd64.zip"
export CONSUL_ENT_URL="https://releases.hashicorp.com/consul/1.7.1/consul_1.7.1_linux_amd64.zip"

# Release version of this image, just for referenceexport RELEASE_VERSION="0.0.1"packer build -only=amazon-ebs-ubuntu-16.04-systemd vault-aws.json
cd ../consul
packer build -only=amazon-ebs-ubuntu-16.04-systemd vault-aws.json# This will run Packer twice, building two Ubuntu-based images, for Vault and Consul.


■ Azure相关设置
Subscription ID
3eb94088-7a15-434d-8c0a-7ac4d3568e81

Directory
Rakuten, Inc. (OFFICERAKUTEN.onmicrosoft.com)

My role
Contributor

Offer
Enterprise Agreement

Offer ID
MS-AZR-0017P

Subscription name
RakutenCom-Vault

Current billing period
3/1/2020-3/31/2020
Currency
JPY

Status
Active

还有一个试用版：
Subscription ID： 6906f1b4-5e2d-4acf-bde6-db6d729ea826
Directory: Rakuten, Inc. (OFFICERAKUTEN.onmicrosoft.com)
Offer ID: MS-AZR-0044P


安装Azure client
[r-user@test-vm ~]$ sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
[r-user@test-vm ~]$ sudo sh -c 'echo -e "[azure-cli]
> name=Azure CLI
> baseurl=https://packages.microsoft.com/yumrepos/azure-cli
> enabled=1
> gpgcheck=1
> gpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/azure-cli.repo'
[r-user@test-vm ~]$ 
[r-user@test-vm ~]$
[r-user@test-vm ~]$
[r-user@test-vm ~]$ sudo yum install azure-cli
Loaded plugins: fastestmirror, langpacks
Loading mirror speeds from cached hostfile
epel/x86_64/metalink                                                                                                                | 3.6 kB  00:00:00     
 * base: ty1.mirror.newmediaexpress.com
 * epel: nrt.edge.kernel.org
 * extras: ty1.mirror.newmediaexpress.com
 * updates: ty1.mirror.newmediaexpress.com
azure-cli                                                                                                                           | 2.9 kB  00:00:00     
base                                                                                                                                | 3.6 kB  00:00:00     
docker-ce-stable                                                                                                                    | 3.5 kB  00:00:00     
epel                                                                                                                                | 5.3 kB  00:00:00     
extras                                                                                                                              | 2.9 kB  00:00:00     
mysql-connectors-community                                                                                                          | 2.5 kB  00:00:00     
mysql-tools-community                                                                                                               | 2.5 kB  00:00:00     
mysql80-community                                                                                                                   | 2.5 kB  00:00:00     
updates                                                                                                                             | 2.9 kB  00:00:00     
azure-cli/primary_db                                                                                                                |  51 kB  00:00:00     
Resolving Dependencies
--> Running transaction check
---> Package azure-cli.x86_64 0:2.2.0-1.el7 will be installed
--> Processing Dependency: python3 for package: azure-cli-2.2.0-1.el7.x86_64
--> Processing Dependency: libpython3.6m.so.1.0()(64bit) for package: azure-cli-2.2.0-1.el7.x86_64
--> Running transaction check
---> Package python3.x86_64 0:3.6.8-10.el7 will be installed
--> Processing Dependency: python3-setuptools for package: python3-3.6.8-10.el7.x86_64
--> Processing Dependency: python3-pip for package: python3-3.6.8-10.el7.x86_64
---> Package python3-libs.x86_64 0:3.6.8-10.el7 will be installed
--> Running transaction check
---> Package python3-pip.noarch 0:9.0.3-5.el7 will be installed
---> Package python3-setuptools.noarch 0:39.2.0-10.el7 will be installed
--> Finished Dependency Resolution

Dependencies Resolved

=========================================================================================================================================================== Package                                    Arch                           Version                                 Repository                         Size 
===========================================================================================================================================================Installing:
 azure-cli                                  x86_64                         2.2.0-1.el7                             azure-cli                          41 M 
Installing for dependencies:
 python3                                    x86_64                         3.6.8-10.el7                            base                               69 k 
 python3-libs                               x86_64                         3.6.8-10.el7                            base                              7.0 M 
 python3-pip                                noarch                         9.0.3-5.el7                             base                              1.8 M 
 python3-setuptools                         noarch                         39.2.0-10.el7                           base                              629 k 

Transaction Summary
===========================================================================================================================================================(4/5): python3-libs-3.6.8-10.el7.x86_64.rpm
                                            | 7.0 MB  00:00:00
(5/5): azure-cli-2.2.0-1.el7.x86_64.rpm                                                                                             |  41 MB  00:00:02
-----------------------------------------------------------------------------------------------------------------------------------------------------------Total
                                                                          23 MB/s |  50 MB  00:00:02
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : python3-setuptools-39.2.0-10.el7.noarch                                                                                                 1/5
  Installing : python3-pip-9.0.3-5.el7.noarch                                                                                                          2/5
  Installing : python3-3.6.8-10.el7.x86_64                                                                                                             3/5
  Installing : python3-libs-3.6.8-10.el7.x86_64                                                                                                        4/5
  Installing : azure-cli-2.2.0-1.el7.x86_64 [###########################################  Installing : azure-cli-2.2.0-1.el7.x86_64 [###########################################  Installing : azure-cli-2.2.  Installing : azure-cli-2.2.0-1.el7.x86_64                                                                                                                                                              5/5 
  Verifying  : python3-libs-3.6.8-10.el7.x86_64                                                                                                                                                          1/5 
  Verifying  : python3-setuptools-39.2.0-10.el7.noarch                                                                                                                                                   2/5 
  Verifying  : azure-cli-2.2.0-1.el7.x86_64                                                                                                                                                              3/5 
  Verifying  : python3-3.6.8-10.el7.x86_64                                                                                                                                                               4/5 
  Verifying  : python3-pip-9.0.3-5.el7.noarch                                                                                                                                                            5/5 

Installed:
  azure-cli.x86_64 0:2.2.0-1.el7

Dependency Installed:
  python3.x86_64 0:3.6.8-10.el7                 python3-libs.x86_64 0:3.6.8-10.el7                 python3-pip.noarch 0:9.0.3-5.el7                 python3-setuptools.noarch 0:39.2.0-10.el7

Complete!

[r-user@test-vm ~]$ az --version
azure-cli                          2.2.0

command-modules-nspkg              2.0.3
core                               2.2.0
nspkg                              3.0.4
telemetry                          1.0.4

Python location '/usr/bin/python3'
Extensions directory '/home/r-user/.azure/cliextensions'

Python (Linux) 3.6.8 (default, Aug  7 2019, 17:28:10)   
[GCC 4.8.5 20150623 (Red Hat 4.8.5-39)]

Legal docs and information: aka.ms/AzureCliLegal        



Your CLI is up-to-date.

Please let us know how we are doing: https://aka.ms/clihats


下面命令会需要在浏览器中输入认证口令，确认自己的登录账号后自动返回方括号内的信息。
[r-user@test-vm ~]$ az login
To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code HSMKX4GA2 to authenticate.
[
  {
    "cloudName": "AzureCloud",
    "homeTenantId": "53a8b0d9-d900-48cc-9d7e-5935dc8d5b17",
    "id": "6906f1b4-5e2d-4acf-bde6-db6d729ea826",
    "isDefault": true,
    "managedByTenants": [],
    "name": "無料試用版",
    "state": "Enabled",
    "tenantId": "53a8b0d9-d900-48cc-9d7e-5935dc8d5b17",
    "user": {
      "name": "song.liu@rakuten.com",
      "type": "user"
    }
  },
  {
    "cloudName": "AzureCloud",
    "homeTenantId": "53a8b0d9-d900-48cc-9d7e-5935dc8d5b17",
    "id": "3eb94088-7a15-434d-8c0a-7ac4d3568e81",
    "isDefault": false,
    "managedByTenants": [],
    "name": "RakutenCom-Vault",
    "state": "Enabled",
    "tenantId": "53a8b0d9-d900-48cc-9d7e-5935dc8d5b17",
    "user": {
      "name": "song.liu@rakuten.com",
      "type": "user"
    }
  }
]


[r-user@test-vm ~]$ sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc
[r-user@test-vm ~]$ sudo sh -c 'echo -e "[azure-cli]
> name=Azure CLI
> baseurl=https://packages.microsoft.com/yumrepos/azure-cli
> enabled=1
> gpgcheck=1
> gpgkey=https://packages.microsoft.com/keys/microsoft.asc" > /etc/yum.repos.d/azure-cli.repo'
[r-user@test-vm ~]$ 
[r-user@test-vm ~]$
[r-user@test-vm ~]$
[r-user@test-vm ~]$ sudo yum install azure-cli
Loaded plugins: fastestmirror, langpacks
Loading mirror speeds from cached hostfile
epel/x86_64/metalink                                                                                                                | 3.6 kB  00:00:00     
 * base: ty1.mirror.newmediaexpress.com
 * epel: nrt.edge.kernel.org
 * extras: ty1.mirror.newmediaexpress.com
 * updates: ty1.mirror.newmediaexpress.com
azure-cli                                                                                                                           | 2.9 kB  00:00:00     
base                                                                                                                                | 3.6 kB  00:00:00     
docker-ce-stable                                                                                                                    | 3.5 kB  00:00:00     
epel                                                                                                                                | 5.3 kB  00:00:00     
extras                                                                                                                              | 2.9 kB  00:00:00     
mysql-connectors-community                                                                                                          | 2.5 kB  00:00:00     
mysql-tools-community                                                                                                               | 2.5 kB  00:00:00     
mysql80-community                                                                                                                   | 2.5 kB  00:00:00     
updates                                                                                                                             | 2.9 kB  00:00:00     
azure-cli/primary_db                                                                                                                |  51 kB  00:00:00     
Resolving Dependencies
--> Running transaction check
---> Package azure-cli.x86_64 0:2.2.0-1.el7 will be installed
--> Processing Dependency: python3 for package: azure-cli-2.2.0-1.el7.x86_64
--> Processing Dependency: libpython3.6m.so.1.0()(64bit) for package: azure-cli-2.2.0-1.el7.x86_64
--> Running transaction check
---> Package python3.x86_64 0:3.6.8-10.el7 will be installed
--> Processing Dependency: python3-setuptools for package: python3-3.6.8-10.el7.x86_64
--> Processing Dependency: python3-pip for package: python3-3.6.8-10.el7.x86_64
---> Package python3-libs.x86_64 0:3.6.8-10.el7 will be installed
--> Running transaction check
---> Package python3-pip.noarch 0:9.0.3-5.el7 will be installed
---> Package python3-setuptools.noarch 0:39.2.0-10.el7 will be installed
--> Finished Dependency Resolution

Dependencies Resolved

=========================================================================================================================================================== Package                                    Arch                           Version                                 Repository                         Size 
===========================================================================================================================================================Installing:
 azure-cli                                  x86_64                         2.2.0-1.el7                             azure-cli                          41 M 
Installing for dependencies:
 python3                                    x86_64                         3.6.8-10.el7                            base                               69 k 
 python3-libs                               x86_64                         3.6.8-10.el7                            base                              7.0 M 
 python3-pip                                noarch                         9.0.3-5.el7                             base                              1.8 M 
 python3-setuptools                         noarch                         39.2.0-10.el7                           base                              629 k 

Transaction Summary
===========================================================================================================================================================(4/5): python3-libs-3.6.8-10.el7.x86_64.rpm
                                            | 7.0 MB  00:00:00
(5/5): azure-cli-2.2.0-1.el7.x86_64.rpm                                                                                             |  41 MB  00:00:02
-----------------------------------------------------------------------------------------------------------------------------------------------------------Total
                                                                          23 MB/s |  50 MB  00:00:02
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : python3-setuptools-39.2.0-10.el7.noarch                                                                                                 1/5
  Installing : python3-pip-9.0.3-5.el7.noarch                                                                                                          2/5
  Installing : python3-3.6.8-10.el7.x86_64                                                                                                             3/5
  Installing : python3-libs-3.6.8-10.el7.x86_64                                                                                                        4/5
  Installing : azure-cli-2.2.0-1.el7.x86_64 [###########################################  Installing : azure-cli-2.2.0-1.el7.x86_64 [###########################################  Installing : azure-cli-2.2.  Installing : azure-cli-2.2.0-1.el7.x86_64                                                                                                                                                              5/5 
  Verifying  : python3-libs-3.6.8-10.el7.x86_64                                                                                                                                                          1/5 
  Verifying  : python3-setuptools-39.2.0-10.el7.noarch                                                                                                                                                   2/5 
  Verifying  : azure-cli-2.2.0-1.el7.x86_64                                                                                                                                                              3/5 
  Verifying  : python3-3.6.8-10.el7.x86_64                                                                                                                                                               4/5 
  Verifying  : python3-pip-9.0.3-5.el7.noarch                                                                                                                                                            5/5 

Installed:
  azure-cli.x86_64 0:2.2.0-1.el7

Dependency Installed:
  python3.x86_64 0:3.6.8-10.el7                 python3-libs.x86_64 0:3.6.8-10.el7                 python3-pip.noarch 0:9.0.3-5.el7                 python3-setuptools.noarch 0:39.2.0-10.el7

Complete!
[r-user@test-vm ~]$ az login
To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code HSMKX4GA2 to authenticate.
[
  {
    "cloudName": "AzureCloud",
    "homeTenantId": "53a8b0d9-d900-48cc-9d7e-5935dc8d5b17",
    "id": "6906f1b4-5e2d-4acf-bde6-db6d729ea826",
    "isDefault": true,
    "managedByTenants": [],
    "name": "無料試用版",
    "state": "Enabled",
    "tenantId": "53a8b0d9-d900-48cc-9d7e-5935dc8d5b17",
    "user": {
      "name": "song.liu@rakuten.com",
      "type": "user"
    }
  },
  {
    "cloudName": "AzureCloud",
    "homeTenantId": "53a8b0d9-d900-48cc-9d7e-5935dc8d5b17",
    "id": "3eb94088-7a15-434d-8c0a-7ac4d3568e81",
    "isDefault": false,
    "managedByTenants": [],
    "name": "RakutenCom-Vault",
    "state": "Enabled",
    "tenantId": "53a8b0d9-d900-48cc-9d7e-5935dc8d5b17",
    "user": {
      "name": "song.liu@rakuten.com",
      "type": "user"
    }
  }
]

如果有多个subscription的话用下面的命令指定某个subscription
[r-user@test-vm ~]$ az account set --subscription="有管理资源权限的那个subscription-id"
这里使用的为：Subscription ID： 6906f1b4-5e2d-4acf-bde6-db6d729ea826


下面的命令也可以：az ad sp create-for-rbac --role="Contributor" --scopes="/subscriptions/SUBSCRIPTION_ID"
[r-user@test-vm ~]$ az ad sp create-for-rbac --role="Contributor"
Creating a role assignment under the scope of "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826"
  Retrying role assignment creation: 1/36
  Retrying role assignment creation: 2/36
  Retrying role assignment creation: 3/36
  Retrying role assignment creation: 4/36
{
  "appId": "c7b6d162-f109-4ec9-863c-34141332f98d",
  "displayName": "azure-cli-2020-03-18-05-12-48",
  "name": "http://azure-cli-2020-03-18-05-12-48",
  "password": "1a2f9dce-f637-4699-a1ed-5653a0bf0e2c",
  "tenant": "53a8b0d9-d900-48cc-9d7e-5935dc8d5b17"
}

These values map to the Terraform variables like so:

    appId is the client_id defined above.
    password is the client_secret defined above.
    tenant is the tenant_id defined above.

export ARM_SUBSCRIPTION_ID=6906f1b4-5e2d-4acf-bde6-db6d729ea826
export ARM_CLIENT_ID=c7b6d162-f109-4ec9-863c-34141332f98d
export ARM_CLIENT_SECRET=1a2f9dce-f637-4699-a1ed-5653a0bf0e2c
export ARM_TENANT_ID=53a8b0d9-d900-48cc-9d7e-5935dc8d5b17


然后做个测试：
[r-user@test-vm ~]$ az login --service-principal -u $ARM_CLIENT_ID -p $ARM_CLIENT_SECRET --tenant $ARM_TENANT_ID
[
  {
    "cloudName": "AzureCloud",
    "homeTenantId": "53a8b0d9-d900-48cc-9d7e-5935dc8d5b17",
    "id": "6906f1b4-5e2d-4acf-bde6-db6d729ea826",
    "isDefault": true,
    "managedByTenants": [],
    "name": "無料試用版",
    "state": "Enabled",
    "tenantId": "53a8b0d9-d900-48cc-9d7e-5935dc8d5b17",
    "user": {
      "name": "c7b6d162-f109-4ec9-863c-34141332f98d",
      "type": "servicePrincipal"
    }
  }
]

[r-user@test-vm ~]$ az account show --query id
"6906f1b4-5e2d-4acf-bde6-db6d729ea826"

登录之后就可以查看比如West US region的虚机大小之类的操作了。
[r-user@test-vm ~]$ az vm list-sizes --location westus | more
[
  {
    "maxDataDiskCount": 2,
    "memoryInMb": 512,
    "name": "Standard_B1ls",
    "numberOfCores": 1,
    "osDiskSizeInMb": 1047552,
    "resourceDiskSizeInMb": 4096
  },
  {
    "maxDataDiskCount": 2,
    "memoryInMb": 2048,
    "name": "Standard_B1ms",
    "numberOfCores": 1,
    "osDiskSizeInMb": 1047552,
    "resourceDiskSizeInMb": 4096
  },
  {
    "maxDataDiskCount": 2,
。。。。。。

[r-user@test-vm ~]$ az account list-locations
[
  {
    "displayName": "East Asia",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/eastasia",
    "latitude": "22.267",
    "longitude": "114.188",
    "name": "eastasia",
    "subscriptionId": null
  },
  {
    "displayName": "Southeast Asia",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/southeastasia",
    "latitude": "1.283",
    "longitude": "103.833",
    "name": "southeastasia",
    "subscriptionId": null
  },
  {
    "displayName": "Central US",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/centralus",
    "latitude": "41.5908",
    "longitude": "-93.6208",
    "name": "centralus",
    "subscriptionId": null
  },
  {
    "displayName": "East US",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/eastus",
    "latitude": "37.3719",
    "longitude": "-79.8164",
    "name": "eastus",
    "subscriptionId": null
  },
  {
    "displayName": "East US 2",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/eastus2",
    "latitude": "36.6681",
    "longitude": "-78.3889",
    "name": "eastus2",
    "subscriptionId": null
  },
  {
    "displayName": "West US",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/westus",
    "latitude": "37.783",
    "longitude": "-122.417",
    "name": "westus",
    "subscriptionId": null
  },
  {
    "displayName": "North Central US",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/northcentralus",
    "latitude": "41.8819",
    "longitude": "-87.6278",
    "name": "northcentralus",
    "subscriptionId": null
  },
  {
    "displayName": "South Central US",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/southcentralus",
    "latitude": "29.4167",
    "longitude": "-98.5",
    "name": "southcentralus",
    "subscriptionId": null
  },
  {
    "displayName": "North Europe",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/northeurope",
    "latitude": "53.3478",
    "longitude": "-6.2597",
    "name": "northeurope",
    "subscriptionId": null
  },
  {
    "displayName": "West Europe",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/westeurope",
    "latitude": "52.3667",
    "longitude": "4.9",
    "name": "westeurope",
    "subscriptionId": null
  },
  {
    "displayName": "Japan West",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/japanwest",
    "latitude": "34.6939",
    "longitude": "135.5022",
    "name": "japanwest",
    "subscriptionId": null
  },
  {
    "displayName": "Japan East",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/japaneast",
    "latitude": "35.68",
    "longitude": "139.77",
    "name": "japaneast",
    "subscriptionId": null
  },
  {
    "displayName": "Brazil South",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/brazilsouth",
    "latitude": "-23.55",
    "longitude": "-46.633",
    "name": "brazilsouth",
    "subscriptionId": null
  },
  {
    "displayName": "Australia East",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/australiaeast",
    "latitude": "-33.86",
    "longitude": "151.2094",
    "name": "australiaeast",
    "subscriptionId": null
  },
  {
    "displayName": "Australia Southeast",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/australiasoutheast",
    "latitude": "-37.8136",
    "longitude": "144.9631",
    "name": "australiasoutheast",
    "subscriptionId": null
  },
  {
    "displayName": "South India",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/southindia",
    "latitude": "12.9822",
    "longitude": "80.1636",
    "name": "southindia",
    "subscriptionId": null
  },
  {
    "displayName": "Central India",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/centralindia",
    "latitude": "18.5822",
    "longitude": "73.9197",
    "name": "centralindia",
    "subscriptionId": null
  },
  {
    "displayName": "West India",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/westindia",
    "latitude": "19.088",
    "longitude": "72.868",
    "name": "westindia",
    "subscriptionId": null
  },
  {
    "displayName": "Canada Central",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/canadacentral",
    "latitude": "43.653",
    "longitude": "-79.383",
    "name": "canadacentral",
    "subscriptionId": null
  },
  {
    "displayName": "Canada East",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/canadaeast",
    "latitude": "46.817",
    "longitude": "-71.217",
    "name": "canadaeast",
    "subscriptionId": null
  },
  {
    "displayName": "UK South",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/uksouth",
    "latitude": "50.941",
    "longitude": "-0.799",
    "name": "uksouth",
    "subscriptionId": null
  },
  {
    "displayName": "UK West",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/ukwest",
    "latitude": "53.427",
    "longitude": "-3.084",
    "name": "ukwest",
    "subscriptionId": null
  },
  {
    "displayName": "West Central US",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/westcentralus",
    "latitude": "40.890",
    "longitude": "-110.234",
    "name": "westcentralus",
    "subscriptionId": null
  },
  {
    "displayName": "West US 2",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/westus2",
    "latitude": "47.233",
    "longitude": "-119.852",
    "name": "westus2",
    "subscriptionId": null
  },
  {
    "displayName": "Korea Central",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/koreacentral",
    "latitude": "37.5665",
    "longitude": "126.9780",
    "name": "koreacentral",
    "subscriptionId": null
  },
  {
    "displayName": "Korea South",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/koreasouth",
    "latitude": "35.1796",
    "longitude": "129.0756",
    "name": "koreasouth",
    "subscriptionId": null
  },
  {
    "displayName": "France Central",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/francecentral",
    "latitude": "46.3772",
    "longitude": "2.3730",
    "name": "francecentral",
    "subscriptionId": null
  },
  {
    "displayName": "France South",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/francesouth",
    "latitude": "43.8345",
    "longitude": "2.1972",
    "name": "francesouth",
    "subscriptionId": null
  },
  {
    "displayName": "Australia Central",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/australiacentral",
    "latitude": "-35.3075",
    "longitude": "149.1244",
    "name": "australiacentral",
    "subscriptionId": null
  },
  {
    "displayName": "Australia Central 2",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/australiacentral2",
    "latitude": "-35.3075",
    "longitude": "149.1244",
    "name": "australiacentral2",
    "subscriptionId": null
  },
  {
    "displayName": "UAE Central",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/uaecentral",
    "latitude": "24.466667",
    "longitude": "54.366669",
    "name": "uaecentral",
    "subscriptionId": null
  },
  {
    "displayName": "UAE North",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/uaenorth",
    "latitude": "25.266666",
    "longitude": "55.316666",
    "name": "uaenorth",
    "subscriptionId": null
  },
  {
    "displayName": "South Africa North",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/southafricanorth",
    "latitude": "-25.731340",
    "longitude": "28.218370",
    "name": "southafricanorth",
    "subscriptionId": null
  },
  {
    "displayName": "South Africa West",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/southafricawest",
    "latitude": "-34.075691",
    "longitude": "18.843266",
    "name": "southafricawest",
    "subscriptionId": null
  },
  {
    "displayName": "Switzerland North",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/switzerlandnorth",
    "latitude": "47.451542",
    "longitude": "8.564572",
    "name": "switzerlandnorth",
    "subscriptionId": null
  },
  {
    "displayName": "Switzerland West",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/switzerlandwest",
    "latitude": "46.204391",
    "longitude": "6.143158",
    "name": "switzerlandwest",
    "subscriptionId": null
  },
  {
    "displayName": "Germany North",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/germanynorth",
    "latitude": "53.073635",
    "longitude": "8.806422",
    "name": "germanynorth",
    "subscriptionId": null
  },
  {
    "displayName": "Germany West Central",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/germanywestcentral",
    "latitude": "50.110924",
    "longitude": "8.682127",
    "name": "germanywestcentral",
    "subscriptionId": null
  },
  {
    "displayName": "Norway West",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/norwaywest",
    "latitude": "58.969975",
    "longitude": "5.733107",
    "name": "norwaywest",
    "subscriptionId": null
  },
  {
    "displayName": "Norway East",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/locations/norwayeast",
    "latitude": "59.913868",
    "longitude": "10.752245",
    "name": "norwayeast",
    "subscriptionId": null
  }
]

一会会创建“Standard_DS2_v2”虚机，先查看一下：
[r-user@test-vm ~]$ az vm list-sizes --location japaneast | grep -B3 -A3 Standard_DS2_v2
  {
    "maxDataDiskCount": 8,
    "memoryInMb": 7168,
    "name": "Standard_DS2_v2",
    "numberOfCores": 2,
    "osDiskSizeInMb": 1047552,
    "resourceDiskSizeInMb": 14336
--
  {
    "maxDataDiskCount": 8,
    "memoryInMb": 7168,
    "name": "Standard_DS2_v2_Promo",
    "numberOfCores": 2,
    "osDiskSizeInMb": 1047552,
    "resourceDiskSizeInMb": 14336

 
[r-user@test-vm ~]$ az vm list-sizes -l japaneast | jq -r '.[]  | [.name, .numberOfCores, .memoryInMb, .osDiskSizeInMb, .resourceDiskSizeInMb] | @tsv' | sort | column -t -s $'t'
Basic_A0        1       768     1047552 20480
Basic_A1        1       1792    1047552 40960
Basic_A2        2       3584    1047552 61440
Basic_A3        4       7168    1047552 122880
Basic_A4        8       14336   1047552 245760
S  andard_A0    1       768     1047552 20480
S  andard_A1    1       1792    1047552 71680
S  andard_A1_v2 1       2048    1047552 10240
S  andard_A2    2       3584    1047552 138240
S  andard_A2m_v2        2       16384   1047552 20480
S  andard_A2_v2 2       4096    1047552 20480
S  andard_A3    4       7168    1047552 291840
S  andard_A4    8       14336   1047552 619520
S  andard_A4m_v2        4       32768   1047552 40960
S  andard_A4_v2 4       8192    1047552 40960
S  andard_A5    2       14336   1047552 138240
S  andard_A6    4       28672   1047552 291840
S  andard_A7    8       57344   1047552 619520
S  andard_A8m_v2        8       65536   1047552 81920
S  andard_A8_v2 8       16384   1047552 81920
S  andard_B12ms 12      49152   1047552 98304
S  andard_B16ms 16      65536   1047552 131072
S  andard_B1ls  1       512     1047552 4096
S  andard_B1ms  1       2048    1047552 4096
S  andard_B1s   1       1024    1047552 4096
S  andard_B20ms 20      81920   1047552 163840
S  andard_B2ms  2       8192    1047552 16384
S  andard_B2s   2       4096    1047552 8192
S  andard_B4ms  4       16384   1047552 32768
S  andard_B8ms  8       32768   1047552 65536
S  andard_D11   2       14336   1047552 102400
S  andard_D1    1       3584    1047552 51200
S  andard_D11_v2        2       14336   1047552 102400
S  andard_D11_v2_Promo  2       14336   1047552 102400
S  andard_D12   4       28672   1047552 204800
S  andard_D12_v2        4       28672   1047552 204800
S  andard_D12_v2_Promo  4       28672   1047552 204800
S  andard_D13   8       57344   1047552 409600
S  andard_D13_v2        8       57344   1047552 409600
S  andard_D13_v2_Promo  8       57344   1047552 409600
S  andard_D14   16      114688  1047552 819200
S  andard_D14_v2        16      114688  1047552 819200
S  andard_D14_v2_Promo  16      114688  1047552 819200
S  andard_D15_v2        20      143360  1047552 1024000
S  andard_D16s_v3       16      65536   1047552 131072
S  andard_D16_v3        16      65536   1047552 409600
S  andard_D1_v2 1       3584    1047552 51200
S  andard_D2    2       7168    1047552 102400
S  andard_D2s_v3        2       8192    1047552 16384
S  andard_D2_v2 2       7168    1047552 102400
S  andard_D2_v2_Promo   2       7168    1047552 102400
S  andard_D2_v3 2       8192    1047552 51200
S  andard_D32s_v3       32      131072  1047552 262144
S  andard_D32_v3        32      131072  1047552 819200
S  andard_D3    4       14336   1047552 204800
S  andard_D3_v2 4       14336   1047552 204800
S  andard_D3_v2_Promo   4       14336   1047552 204800
S  andard_D4    8       28672   1047552 409600
S  andard_D48s_v3       48      196608  1047552 393216
S  andard_D48_v3        48      196608  1047552 1228800
S  andard_D4s_v3        4       16384   1047552 32768
S  andard_D4_v2 8       28672   1047552 409600
S  andard_D4_v2_Promo   8       28672   1047552 409600
S  andard_D4_v3 4       16384   1047552 102400
S  andard_D5_v2 16      57344   1047552 819200
S  andard_D5_v2_Promo   16      57344   1047552 819200
S  andard_D64s_v3       64      262144  1047552 524288
S  andard_D64_v3        64      262144  1047552 1638400
S  andard_D8s_v3        8       32768   1047552 65536
S  andard_D8_v3 8       32768   1047552 204800
S  andard_DS11-1_v2     2       14336   1047552 28672
S  andard_DS11  2       14336   1047552 28672
S  andard_DS1   1       3584    1047552 7168
S  andard_DS11_v2       2       14336   1047552 28672
S  andard_DS11_v2_Promo 2       14336   1047552 28672
S  andard_DS12-1_v2     4       28672   1047552 57344
S  andard_DS12-2_v2     4       28672   1047552 57344
S  andard_DS12  4       28672   1047552 57344
S  andard_DS12_v2       4       28672   1047552 57344
S  andard_DS12_v2_Promo 4       28672   1047552 57344
S  andard_DS13-2_v2     8       57344   1047552 114688
S  andard_DS13-4_v2     8       57344   1047552 114688
S  andard_DS13  8       57344   1047552 114688
S  andard_DS13_v2       8       57344   1047552 114688
S  andard_DS13_v2_Promo 8       57344   1047552 114688
S  andard_DS14  16      114688  1047552 229376
S  andard_DS14-4_v2     16      114688  1047552 229376
S  andard_DS14-8_v2     16      114688  1047552 229376
S  andard_DS14_v2       16      114688  1047552 229376
S  andard_DS14_v2_Promo 16      114688  1047552 229376
S  andard_DS15_v2       20      143360  1047552 286720
S  andard_DS1_v2        1       3584    1047552 7168
S  andard_DS2   2       7168    1047552 14336
S  andard_DS2_v2        2       7168    1047552 14336
S  andard_DS2_v2_Promo  2       7168    1047552 14336
S  andard_DS3   4       14336   1047552 28672
S  andard_DS3_v2        4       14336   1047552 28672
S  andard_DS3_v2_Promo  4       14336   1047552 28672
S  andard_DS4   8       28672   1047552 57344
S  andard_DS4_v2        8       28672   1047552 57344
S  andard_DS4_v2_Promo  8       28672   1047552 57344
S  andard_DS5_v2        16      57344   1047552 114688
S  andard_DS5_v2_Promo  16      57344   1047552 114688
S  andard_E16-4s_v3     16      131072  1047552 262144
S  andard_E16-8s_v3     16      131072  1047552 262144
S  andard_E16s_v3       16      131072  1047552 262144
S  andard_E16_v3        16      131072  1047552 409600
S  andard_E20s_v3       20      163840  1047552 327680
S  andard_E20_v3        20      163840  1047552 512000
S  andard_E2s_v3        2       16384   1047552 32768
S  andard_E2_v3 2       16384   1047552 51200
S  andard_E32-16s_v3    32      262144  1047552 524288
S  andard_E32-8s_v3     32      262144  1047552 524288
S  andard_E32s_v3       32      262144  1047552 524288
S  andard_E32_v3        32      262144  1047552 819200
S  andard_E4-2s_v3      4       32768   1047552 65536
S  andard_E48s_v3       48      393216  1047552 786432
S  andard_E48_v3        48      393216  1047552 1228800
S  andard_E4s_v3        4       32768   1047552 65536
S  andard_E4_v3 4       32768   1047552 102400
S  andard_E64-16s_v3    64      442368  1047552 884736
S  andard_E64-32s_v3    64      442368  1047552 884736
S  andard_E64is_v3      64      442368  1047552 884736
S  andard_E64i_v3       64      442368  1047552 1638400
S  andard_E64s_v3       64      442368  1047552 884736
S  andard_E64_v3        64      442368  1047552 1638400
S  andard_E8-2s_v3      8       65536   1047552 131072
S  andard_E8-4s_v3      8       65536   1047552 131072
S  andard_E8s_v3        8       65536   1047552 131072
S  andard_E8_v3 8       65536   1047552 204800
S  andard_F1    1       2048    1047552 16384
S  andard_F16   16      32768   1047552 262144
S  andard_F16s  16      32768   1047552 65536
S  andard_F16s_v2       16      32768   1047552 131072
S  andard_F1s   1       2048    1047552 4096
S  andard_F2    2       4096    1047552 32768
S  andard_F2s   2       4096    1047552 8192
S  andard_F2s_v2        2       4096    1047552 16384
S  andard_F32s_v2       32      65536   1047552 262144
S  andard_F4    4       8192    1047552 65536
S  andard_F48s_v2       48      98304   1047552 393216
S  andard_F4s   4       8192    1047552 16384
S  andard_F4s_v2        4       8192    1047552 32768
S  andard_F64s_v2       64      131072  1047552 524288
S  andard_F72s_v2       72      147456  1047552 589824
S  andard_F8    8       16384   1047552 131072
S  andard_F8s   8       16384   1047552 32768
S  andard_F8s_v2        8       16384   1047552 65536
S  andard_G1    2       28672   1047552 393216
S  andard_G2    4       57344   1047552 786432
S  andard_G3    8       114688  1047552 1572864
S  andard_G4    16      229376  1047552 3145728
S  andard_G5    32      458752  1047552 6291456
S  andard_GS1   2       28672   1047552 57344
S  andard_GS2   4       57344   1047552 114688
S  andard_GS3   8       114688  1047552 229376
S  andard_GS4   16      229376  1047552 458752
S  andard_GS4-4 16      229376  1047552 458752
S  andard_GS4-8 16      229376  1047552 458752
S  andard_GS5-16        32      458752  1047552 917504
S  andard_GS5   32      458752  1047552 917504
S  andard_GS5-8 32      458752  1047552 917504
S  andard_H16   16      114688  1047552 2048000
S  andard_H16m  16      229376  1047552 2048000
S  andard_H16m_Promo    16      229376  1047552 2048000
S  andard_H16mr 16      229376  1047552 2048000
S  andard_H16mr_Promo   16      229376  1047552 2048000
S  andard_H16_Promo     16      114688  1047552 2048000
S  andard_H16r  16      114688  1047552 2048000
S  andard_H16r_Promo    16      114688  1047552 2048000
S  andard_H8    8       57344   1047552 1024000
S  andard_H8m   8       114688  1047552 1024000
S  andard_H8m_Promo     8       114688  1047552 1024000
S  andard_H8_Promo      8       57344   1047552 1024000
S  andard_HC44rs        44      335693  1047552 716800
S  andard_L16s  16      131072  1047552 2874368
S  andard_L32s  32      262144  1047552 5765120
S  andard_L4s   4       32768   1047552 694272
S  andard_L8s   8       65536   1047552 1421312
S  andard_M128  128     2048000 1047552 16384000
S  andard_M128-32ms     128     3891200 1047552 4096000
S  andard_M128-64ms     128     3891200 1047552 4096000
S  andard_M128m 128     3891200 1047552 16384000
S  andard_M128ms        128     3891200 1047552 4096000
S  andard_M128s 128     2048000 1047552 4096000
S  andard_M16-4ms       16      448000  1047552 512000
S  andard_M16-8ms       16      448000  1047552 512000
S  andard_M16ms 16      448000  1047552 512000
S  andard_M32-16ms      32      896000  1047552 1024000
S  andard_M32-8ms       32      896000  1047552 1024000
S  andard_M32ls 32      262144  1047552 1024000
S  andard_M32ms 32      896000  1047552 1024000
S  andard_M32  s        32      196608  1047552 1024000
S  andard_M64-16ms      64      1792000 1047552 2048000
S  andard_M64-32ms      64      1792000 1047552 2048000
S  andard_M64   64      1024000 1047552 8192000
S  andard_M64ls 64      524288  1047552 2048000
S  andard_M64m  64      1792000 1047552 8192000
S  andard_M64ms 64      1792000 1047552 2048000
S  andard_M64s  64      1024000 1047552 2048000
S  andard_M8-2ms        8       224000  1047552 256000
S  andard_M8-4ms        8       224000  1047552 256000
S  andard_M8ms  8       224000  1047552 256000
S  andard_NC12s_v3      12      229376  1047552 688128
S  andard_NC24rs_v3     24      458752  1047552 1376256
S  andard_NC24s_v3      24      458752  1047552 1376256
S  andard_NC6s_v3       6       114688  1047552 344064
S  andard_NV12  12      114688  1047552 696320
S  andard_NV12_Promo    12      114688  1047552 696320
S  andard_NV12s_v2      12      229376  1047552 688128
S  andard_NV12s_v3      12      114688  1047552 344064
S  andard_NV24  24      229376  1047552 1474560
S  andard_NV24_Promo    24      229376  1047552 1474560
S  andard_NV24s_v2      24      458752  1047552 1376256
S  andard_NV24s_v3      24      229376  1047552 688128
S  andard_NV48s_v3      48      458752  1047552 1376256
S  andard_NV6   6       57344   1047552 389120
S  andard_NV6_Promo     6       57344   1047552 389120
S  andard_NV6s_v2       6       114688  1047552 344064



实际上上面的这个命令看到的很多sku是没有的？？有点奇怪。。。
用下面的命令看region所支持的sku。比如Standard_F的虚机sku列表。
[r-user@test-vm vault-demo]$ az vm list-skus --location japaneast --size Standard_F --output table
ResourceType     Locations    Name              Zones    Capabilities

                                                                                                                                                                                                                  Restrictions
---------------  -----------  ----------------  -------  ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  --------------
virtualMachines  japaneast    Standard_F2s_v2   1,2,3    ['MaxResourceVolumeMB=16384', 'OSVhdSizeMB=1047552', 'vCPUs=2', 'HyperVGenerations=V1,V2', 'MemoryGB=4', 'MaxDataDiskCount=4', 'LowPriorityCapable=True', 'PremiumIO=True', 'VMDeploymentTypes=IaaS', 'vCPUsAvailable=2', 'ACUs=195', 'vCPUsPerCore=2', 'CombinedTempDiskAndCachedIOPS=4000', 'CombinedTempDiskAndCachedReadBytesPerSecond=32505856', 'CombinedTempDiskAndCachedWriteBytesPerSecond=32505856', 'CachedDiskBytes=34359738368', 'UncachedDiskIOPS=3200', 'UncachedDiskBytesPerSecond=49283072', 'EphemeralOSDiskSupported=True', 'AcceleratedNetworkingEnabled=False', 'RdmaEnabled=False', 'MaxNetworkInterfaces=2']                  None
virtualMachines  japaneast    Standard_F4s_v2   1,2,3    ['MaxResourceVolumeMB=32768', 'OSVhdSizeMB=1047552', 'vCPUs=4', 'HyperVGenerations=V1,V2', 'MemoryGB=8', 'MaxDataDiskCount=8', 'LowPriorityCapable=True', 'PremiumIO=True', 'VMDeploymentTypes=IaaS', 'vCPUsAvailable=4', 'ACUs=195', 'vCPUsPerCore=2', 'CombinedTempDiskAndCachedIOPS=8000', 'CombinedTempDiskAndCachedReadBytesPerSecond=66060288', 'CombinedTempDiskAndCachedWriteBytesPerSecond=66060288', 'CachedDiskBytes=68719476736', 'UncachedDiskIOPS=6400', 'UncachedDiskBytesPerSecond=49283072', 'EphemeralOSDiskSupported=True', 'AcceleratedNetworkingEnabled=True', 'RdmaEnabled=False', 'MaxNetworkInterfaces=2']                   None
virtualMachines  japaneast    Standard_F8s_v2   1,2,3    ['MaxResourceVolumeMB=65536', 'OSVhdSizeMB=1047552', 'vCPUs=8', 'HyperVGenerations=V1,V2', 'MemoryGB=16', 'MaxDataDiskCount=16', 'LowPriorityCapable=True', 'PremiumIO=True', 'VMDeploymentTypes=IaaS', 'vCPUsAvailable=8', 'ACUs=195', 'vCPUsPerCore=2', 'CombinedTempDiskAndCachedIOPS=16000', 'CombinedTempDiskAndCachedReadBytesPerSecond=133169152', 'CombinedTempDiskAndCachedWriteBytesPerSecond=133169152', 'CachedDiskBytes=137438953472', 'UncachedDiskIOPS=12800', 'UncachedDiskBytesPerSecond=199229440', 'EphemeralOSDiskSupported=True', 'AcceleratedNetworkingEnabled=True', 'RdmaEnabled=False', 'MaxNetworkInterfaces=4']           None
virtualMachines  japaneast    Standard_F16s_v2  1,2,3    ['MaxResourceVolumeMB=131072', 'OSVhdSizeMB=1047552', 'vCPUs=16', 'HyperVGenerations=V1,V2', 'MemoryGB=32', 'MaxDataDiskCount=32', 'LowPriorityCapable=True', 'PremiumIO=True', 'VMDeploymentTypes=IaaS', 'vCPUsAvailable=16', 'ACUs=195', 'vCPUsPerCore=2', 'CombinedTempDiskAndCachedIOPS=32000', 'CombinedTempDiskAndCachedReadBytesPerSecond=267386880', 'CombinedTempDiskAndCachedWriteBytesPerSecond=267386880', 'CachedDiskBytes=274877906944', 'UncachedDiskIOPS=25600', 'UncachedDiskBytesPerSecond=398458880', 'EphemeralOSDiskSupported=True', 'AcceleratedNetworkingEnabled=True', 'RdmaEnabled=False', 'MaxNetworkInterfaces=4']        None
virtualMachines  japaneast    Standard_F32s_v2  1,2,3    ['MaxResourceVolumeMB=262144', 'OSVhdSizeMB=1047552', 'vCPUs=32', 'HyperVGenerations=V1,V2', 'MemoryGB=64', 'MaxDataDiskCount=32', 'LowPriorityCapable=True', 'PremiumIO=True', 'VMDeploymentTypes=IaaS', 'vCPUsAvailable=32', 'ACUs=195', 'vCPUsPerCore=2', 'CombinedTempDiskAndCachedIOPS=64000', 'CombinedTempDiskAndCachedReadBytesPerSecond=536870912', 'CombinedTempDiskAndCachedWriteBytesPerSecond=536870912', 'CachedDiskBytes=549755813888', 'UncachedDiskIOPS=51200', 'UncachedDiskBytesPerSecond=786432000', 'EphemeralOSDiskSupported=True', 'AcceleratedNetworkingEnabled=True', 'RdmaEnabled=False', 'MaxNetworkInterfaces=8']        None
virtualMachines  japaneast    Standard_F48s_v2  1,2,3    ['MaxResourceVolumeMB=393216', 'OSVhdSizeMB=1047552', 'vCPUs=48', 'HyperVGenerations=V1,V2', 'MemoryGB=96', 'MaxDataDiskCount=32', 'LowPriorityCapable=True', 'PremiumIO=True', 'VMDeploymentTypes=IaaS', 'vCPUsAvailable=48', 'ACUs=195', 'vCPUsPerCore=2', 'CombinedTempDiskAndCachedIOPS=96000', 'CombinedTempDiskAndCachedReadBytesPerSecond=805306368', 'CombinedTempDiskAndCachedWriteBytesPerSecond=805306368', 'CachedDiskBytes=824633720832', 'UncachedDiskIOPS=76800', 'UncachedDiskBytesPerSecond=1153433600', 'EphemeralOSDiskSupported=True', 'AcceleratedNetworkingEnabled=True', 'RdmaEnabled=False', 'MaxNetworkInterfaces=8']       None
virtualMachines  japaneast    Standard_F64s_v2  1,2,3    ['MaxResourceVolumeMB=524288', 'OSVhdSizeMB=1047552', 'vCPUs=64', 'HyperVGenerations=V1,V2', 'MemoryGB=128', 'MaxDataDiskCount=32', 'LowPriorityCapable=True', 'PremiumIO=True', 'VMDeploymentTypes=IaaS', 'vCPUsAvailable=64', 'ACUs=195', 'vCPUsPerCore=2', 'CombinedTempDiskAndCachedIOPS=128000', 'CombinedTempDiskAndCachedReadBytesPerSecond=1073741824', 'CombinedTempDiskAndCachedWriteBytesPerSecond=1073741824', 'CachedDiskBytes=1099511627776', 'UncachedDiskIOPS=80000', 'UncachedDiskBytesPerSecond=1153433600', 'EphemeralOSDiskSupported=True', 'AcceleratedNetworkingEnabled=True', 'RdmaEnabled=False', 'MaxNetworkInterfaces=8']  None
virtualMachines  japaneast    Standard_F72s_v2  1,2,3    ['MaxResourceVolumeMB=589824', 'OSVhdSizeMB=1047552', 'vCPUs=72', 'HyperVGenerations=V1,V2', 'MemoryGB=144', 'MaxDataDiskCount=32', 'LowPriorityCapable=True', 'PremiumIO=True', 'VMDeploymentTypes=IaaS', 'vCPUsAvailable=72', 'ACUs=195', 'vCPUsPerCore=2', 'CombinedTempDiskAndCachedIOPS=144000', 'CombinedTempDiskAndCachedReadBytesPerSecond=1207959552', 'CombinedTempDiskAndCachedWriteBytesPerSecond=1207959552', 'CachedDiskBytes=1632087572480', 'UncachedDiskIOPS=80000', 'UncachedDiskBytesPerSecond=1153433600', 'EphemeralOSDiskSupported=True', 'AcceleratedNetworkingEnabled=True', 'RdmaEnabled=False', 'MaxNetworkInterfaces=8']  None



为了创建image，必须预先创建resource group，名字叫做consul。
[r-user@test-vm vault-demo]$ az group create -n consul -l japaneast
{
  "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul",
  "location": "japaneast",
  "managedBy": null,
  "name": "consul",
  "properties": {
    "provisioningState": "Succeeded"
  },
  "tags": null,
  "type": "Microsoft.Resources/resourceGroups"
}

然后创建storage account，名字为：myconsulstoacc
az storage account create \
    --name myconsulstoacc \
    --resource-group consul \
    --location japaneast \
    --sku Standard_ZRS \
    --encryption-service blob

[r-user@test-vm ~]$ az storage account create \
>     --name myconsulstoacc \
>     --resource-group consul \
>     --location japaneast \
>     --sku Standard_ZRS \
>     --encryption-service blob
{
  "accessTier": "Hot",
  "azureFilesIdentityBasedAuthentication": null,
  "blobRestoreStatus": null,
  "creationTime": "2020-03-26T04:55:46.013062+00:00",
  "customDomain": null,
  "enableHttpsTrafficOnly": true,
  "encryption": {
    "keySource": "Microsoft.Storage",
    "keyVaultProperties": null,
    "services": {
      "blob": {
        "enabled": true,
        "keyType": "Account",
        "lastEnabledTime": "2020-03-26T04:55:46.059993+00:00"
      },
      "file": {
        "enabled": true,
        "keyType": "Account",
        "lastEnabledTime": "2020-03-26T04:55:46.059993+00:00"
      },
      "queue": null,
      "table": null
    }
  },
  "failoverInProgress": null,
  "geoReplicationStats": null,
  "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Storage/storageAccounts/myconsulstoacc",
  "identity": null,
  "isHnsEnabled": null,
  "kind": "StorageV2",
  "largeFileSharesState": null,
  "lastGeoFailoverTime": null,
  "location": "japaneast",
  "name": "myconsulstoacc",
  "networkRuleSet": {
    "bypass": "AzureServices",
    "defaultAction": "Allow",
    "ipRules": [],
    "virtualNetworkRules": []
  },
  "primaryEndpoints": {
    "blob": "https://myconsulstoacc.blob.core.windows.net/",
    "dfs": "https://myconsulstoacc.dfs.core.windows.net/",
    "file": "https://myconsulstoacc.file.core.windows.net/",
    "internetEndpoints": null,
    "microsoftEndpoints": null,
    "queue": "https://myconsulstoacc.queue.core.windows.net/",
    "table": "https://myconsulstoacc.table.core.windows.net/",
    "web": "https://myconsulstoacc.z11.web.core.windows.net/"
  },
  "primaryLocation": "japaneast",
  "privateEndpointConnections": [],
  "provisioningState": "Succeeded",
  "resourceGroup": "consul",
  "routingPreference": null,
  "secondaryEndpoints": null,
  "secondaryLocation": null,
  "sku": {
    "name": "Standard_ZRS",
    "tier": "Standard"
  },
  "statusOfPrimary": "available",
  "statusOfSecondary": null,
  "tags": {},
  "type": "Microsoft.Storage/storageAccounts"
}


最后别忘了：
[r-user@test-vm ~]$ az logout
[r-user@test-vm ~]$ az vm list-sizes --location japaneast
No subscription found. Run 'az account set' to select a subscription.

查看常用的image，不用login，因为只是在本地cache查找。
[r-user@test-vm vault-demo]$ az vm image list --output table
You are viewing an offline list of images, use --all to retrieve an up-to-date list
Offer          Publisher               Sku                 Urn                                                             UrnAlias             Version
-------------  ----------------------  ------------------  --------------------------------------------------------------  -------------------  ---------
CentOS         OpenLogic               7.5                 OpenLogic:CentOS:7.5:latest                                     CentOS               latest
CoreOS         CoreOS                  Stable              CoreOS:CoreOS:Stable:latest                                     CoreOS               latest
debian-10      Debian                  10                  Debian:debian-10:10:latest                                      Debian               latest
openSUSE-Leap  SUSE                    42.3                SUSE:openSUSE-Leap:42.3:latest                                  openSUSE-Leap        latest
RHEL           RedHat                  7-LVM               RedHat:RHEL:7-LVM:latest                                        RHEL                 latest
SLES           SUSE                    15                  SUSE:SLES:15:latest                                             SLES                 latest
UbuntuServer   Canonical               18.04-LTS           Canonical:UbuntuServer:18.04-LTS:latest                         UbuntuLTS            latest
WindowsServer  MicrosoftWindowsServer  2019-Datacenter     MicrosoftWindowsServer:WindowsServer:2019-Datacenter:latest     Win2019Datacenter    latest
WindowsServer  MicrosoftWindowsServer  2016-Datacenter     MicrosoftWindowsServer:WindowsServer:2016-Datacenter:latest     Win2016Datacenter    latest
WindowsServer  MicrosoftWindowsServer  2012-R2-Datacenter  MicrosoftWindowsServer:WindowsServer:2012-R2-Datacenter:latest  Win2012R2Datacenter  latest
WindowsServer  MicrosoftWindowsServer  2012-Datacenter     MicrosoftWindowsServer:WindowsServer:2012-Datacenter:latest     Win2012Datacenter    latest
WindowsServer  MicrosoftWindowsServer  2008-R2-SP1         MicrosoftWindowsServer:WindowsServer:2008-R2-SP1:latest         Win2008R2SP1         latest


也可以指定特定的image进行查找，但是有--all的这类命令需要login
az vm image list --offer Debian --all --output table


进行第一次的packer build，shell脚本文件基本没有修改，只是修改了Azure的配置部分。
[r-user@test-vm vault-demo]$ ~/packer build consul.json
azure-arm: output will be in this color.

==> azure-arm: Running builder ...
==> azure-arm: Getting tokens using client secret
==> azure-arm: Getting tokens using client secret
    azure-arm: Creating Azure Resource Manager (ARM) client ...
==> azure-arm: WARNING: Zone resiliency may not be supported in japaneast, checkout the docs at https://docs.microsoft.com/en-us/azure/availability-zones/
==> azure-arm: Creating resource group ...
==> azure-arm:  -> ResourceGroupName : 'packer-Resource-Group-fmtsv4uco2'
==> azure-arm:  -> Location          : 'japaneast'
==> azure-arm:  -> Tags              :
==> azure-arm:  ->> dept : Engineering
==> azure-arm:  ->> task : Image deployment
==> azure-arm: Validating deployment template ...
==> azure-arm:  -> ResourceGroupName : 'packer-Resource-Group-fmtsv4uco2'
==> azure-arm:  -> DeploymentName    : 'pkrdpfmtsv4uco2'
==> azure-arm: Deploying deployment template ...
==> azure-arm:  -> ResourceGroupName : 'packer-Resource-Group-fmtsv4uco2'
==> azure-arm:  -> DeploymentName    : 'pkrdpfmtsv4uco2'
==> azure-arm: Getting the VM's IP address ...
==> azure-arm:  -> ResourceGroupName   : 'packer-Resource-Group-fmtsv4uco2'
==> azure-arm:  -> PublicIPAddressName : 'pkripfmtsv4uco2'
==> azure-arm:  -> NicName             : 'pkrnifmtsv4uco2'
==> azure-arm:  -> Network Connection  : 'PublicEndpoint'
==> azure-arm:  -> IP Address          : '20.37.97.30'
==> azure-arm: Waiting for SSH to become available...
==> azure-arm: Connected to SSH!
==> azure-arm: Uploading /home/r-user/vault-demo/../terraform-azurerm-consul => /tmp
==> azure-arm: Pausing 30s before the next provisioner...
==> azure-arm: Provisioning with shell script: /tmp/packer-shell486930728
    azure-arm: deb https://packages.microsoft.com/repos/azure-cli/ wheezy main
    azure-arm: Executing: /tmp/tmp.PJZAmqu3yv/gpg.1.sh --keyserver
    azure-arm: packages.microsoft.com
==> azure-arm: gpg: requesting key BE1229CF from hkp server packages.microsoft.com
    azure-arm: --recv-keys
    azure-arm: EB3E94ADBE1229CF
==> azure-arm: gpg: key BE1229CF: public key "Microsoft (Release signing) <gpgsecurity@microsoft.com>" imported
==> azure-arm: gpg: Total number processed: 1
==> azure-arm: gpg:               imported: 1  (RSA: 1)
    azure-arm: Hit:1 http://azure.archive.ubuntu.com/ubuntu xenial InRelease
    azure-arm: Get:2 http://azure.archive.ubuntu.com/ubuntu xenial-updates InRelease [109 kB]
    azure-arm: Get:3 http://azure.archive.ubuntu.com/ubuntu xenial-backports InRelease [107 kB]
    azure-arm: Get:4 http://azure.archive.ubuntu.com/ubuntu xenial/universe amd64 Packages [7,532 kB]
    azure-arm: Get:5 http://security.ubuntu.com/ubuntu xenial-security InRelease [109 kB]
    azure-arm: Get:6 https://packages.microsoft.com/repos/azure-cli wheezy InRelease [3,187 B]
    azure-arm: Get:7 http://azure.archive.ubuntu.com/ubuntu xenial/universe Translation-en [4,354 kB]
    azure-arm: Get:8 http://azure.archive.ubuntu.com/ubuntu xenial/multiverse amd64 Packages [144 kB]
    azure-arm: Get:9 http://azure.archive.ubuntu.com/ubuntu xenial/multiverse Translation-en [106 kB]
    azure-arm: Get:10 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 Packages [1,120 kB]
    azure-arm: Get:11 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main Translation-en [427 kB]
    azure-arm: Get:12 http://azure.archive.ubuntu.com/ubuntu xenial-updates/universe amd64 Packages [793 kB]
    azure-arm: Get:13 https://packages.microsoft.com/repos/azure-cli wheezy/main amd64 Packages [12.0 kB]
    azure-arm: Get:14 http://azure.archive.ubuntu.com/ubuntu xenial-updates/universe Translation-en [331 kB]
    azure-arm: Get:15 http://azure.archive.ubuntu.com/ubuntu xenial-updates/multiverse amd64 Packages [16.8 kB]
    azure-arm: Get:16 http://azure.archive.ubuntu.com/ubuntu xenial-updates/multiverse Translation-en [8,468 B]
    azure-arm: Get:17 http://azure.archive.ubuntu.com/ubuntu xenial-backports/main amd64 Packages [7,280 B]
    azure-arm: Get:18 http://azure.archive.ubuntu.com/ubuntu xenial-backports/main Translation-en [4,456 B]
    azure-arm: Get:19 http://azure.archive.ubuntu.com/ubuntu xenial-backports/universe amd64 Packages [8,064 B]
    azure-arm: Get:20 http://azure.archive.ubuntu.com/ubuntu xenial-backports/universe Translation-en [4,328 B]
    azure-arm: Get:21 http://security.ubuntu.com/ubuntu xenial-security/main amd64 Packages [840 kB]
    azure-arm: Get:22 http://security.ubuntu.com/ubuntu xenial-security/main Translation-en [319 kB]
    azure-arm: Get:23 http://security.ubuntu.com/ubuntu xenial-security/universe amd64 Packages [487 kB]
    azure-arm: Get:24 http://security.ubuntu.com/ubuntu xenial-security/universe Translation-en [199 kB]
    azure-arm: Get:25 http://security.ubuntu.com/ubuntu xenial-security/multiverse amd64 Packages [5,728 B]
    azure-arm: Get:26 http://security.ubuntu.com/ubuntu xenial-security/multiverse Translation-en [2,708 B]
    azure-arm: Fetched 17.1 MB in 2s (5,952 kB/s)
    azure-arm: Reading package lists...
    azure-arm: Reading package lists...
    azure-arm: Building dependency tree...
    azure-arm: Reading state information...
    azure-arm: apt-transport-https is already the newest version (1.2.32).
    azure-arm: The following package was automatically installed and is no longer required:
    azure-arm:   grub-pc-bin
    azure-arm: Use 'sudo apt autoremove' to remove it.
    azure-arm: The following additional packages will be installed:
    azure-arm:   cpp cpp-5 dpkg-dev fakeroot g++ g++-5 gcc gcc-5 libalgorithm-diff-perl
    azure-arm:   libalgorithm-diff-xs-perl libalgorithm-merge-perl libasan2 libatomic1
    azure-arm:   libc-dev-bin libc6-dev libcc1-0 libcilkrts5 libdpkg-perl libexpat1-dev
    azure-arm:   libfakeroot libfile-fcntllock-perl libgcc-5-dev libgomp1 libisl15 libitm1
    azure-arm:   liblsan0 libmpc3 libmpx0 libpython-dev libpython2.7-dev libquadmath0
    azure-arm:   libssl-doc libstdc++-5-dev libtsan0 libubsan0 linux-libc-dev make
    azure-arm:   manpages-dev python2.7-dev zlib1g-dev
    azure-arm: Suggested packages:
    azure-arm:   cpp-doc gcc-5-locales debian-keyring g++-multilib g++-5-multilib gcc-5-doc
    azure-arm:   libstdc++6-5-dbg gcc-multilib autoconf automake libtool flex bison gdb
    azure-arm:   gcc-doc gcc-5-multilib libgcc1-dbg libgomp1-dbg libitm1-dbg libatomic1-dbg
    azure-arm:   libasan2-dbg liblsan0-dbg libtsan0-dbg libubsan0-dbg libcilkrts5-dbg
    azure-arm:   libmpx0-dbg libquadmath0-dbg glibc-doc libstdc++-5-doc make-doc
    azure-arm: The following NEW packages will be installed:
    azure-arm:   azure-cli build-essential cpp cpp-5 dpkg-dev fakeroot g++ g++-5 gcc gcc-5
    azure-arm:   libalgorithm-diff-perl libalgorithm-diff-xs-perl libalgorithm-merge-perl
    azure-arm:   libasan2 libatomic1 libc-dev-bin libc6-dev libcc1-0 libcilkrts5 libdpkg-perl
    azure-arm:   libexpat1-dev libfakeroot libffi-dev libfile-fcntllock-perl libgcc-5-dev
    azure-arm:   libgomp1 libisl15 libitm1 liblsan0 libmpc3 libmpx0 libpython-dev
    azure-arm:   libpython2.7-dev libquadmath0 libssl-dev libssl-doc libstdc++-5-dev libtsan0
    azure-arm:   libubsan0 linux-libc-dev make manpages-dev python-dev python2.7-dev
    azure-arm:   zlib1g-dev
    azure-arm: 0 upgraded, 45 newly installed, 0 to remove and 17 not upgraded.
    azure-arm: Need to get 156 MB of archives.
    azure-arm: After this operation, 569 MB of additional disk space will be used.
    azure-arm: Get:1 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 libmpc3 amd64 1.0.3-1 [39.7 kB]
    azure-arm: Get:2 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libc-dev-bin amd64 2.23-0ubuntu11 [68.5 kB]
    azure-arm: Get:3 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 linux-libc-dev amd64 4.4.0-176.206 [849 kB]
    azure-arm: Get:4 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libc6-dev amd64 2.23-0ubuntu11 [2,086 kB]
    azure-arm: Get:5 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 libisl15 amd64 0.16.1-1 [524 kB]
    azure-arm: Get:6 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 cpp-5 amd64 5.4.0-6ubuntu1~16.04.12 [7,783 kB]
    azure-arm: Get:7 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 cpp amd64 4:5.3.1-1ubuntu1 [27.7 kB]
    azure-arm: Get:8 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libcc1-0 amd64 5.4.0-6ubuntu1~16.04.12 [38.8 kB]
    azure-arm: Get:9 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libgomp1 amd64 5.4.0-6ubuntu1~16.04.12 [55.2 kB]
    azure-arm: Get:10 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libitm1 amd64 5.4.0-6ubuntu1~16.04.12 [27.4 kB]
    azure-arm: Get:11 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libatomic1 amd64 5.4.0-6ubuntu1~16.04.12 [8,892 B]
    azure-arm: Get:12 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libasan2 amd64 5.4.0-6ubuntu1~16.04.12 [265 kB]
    azure-arm: Get:13 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 liblsan0 amd64 5.4.0-6ubuntu1~16.04.12 [105 kB]
    azure-arm: Get:14 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libtsan0 amd64 5.4.0-6ubuntu1~16.04.12 [244 kB]
    azure-arm: Get:15 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libubsan0 amd64 5.4.0-6ubuntu1~16.04.12 [95.3 kB]
    azure-arm: Get:16 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libcilkrts5 amd64 5.4.0-6ubuntu1~16.04.12 [40.0 kB]
    azure-arm: Get:17 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libmpx0 amd64 5.4.0-6ubuntu1~16.04.12 [9,762 B]
    azure-arm: Get:18 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libquadmath0 amd64 5.4.0-6ubuntu1~16.04.12 [131 kB]
    azure-arm: Get:19 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libgcc-5-dev amd64 5.4.0-6ubuntu1~16.04.12 [2,239 kB]
    azure-arm: Get:20 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 gcc-5 amd64 5.4.0-6ubuntu1~16.04.12 [8,612 kB]
    azure-arm: Get:21 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 gcc amd64 4:5.3.1-1ubuntu1 [5,244 B]
    azure-arm: Get:22 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libstdc++-5-dev amd64 5.4.0-6ubuntu1~16.04.12 [1,428 kB]
    azure-arm: Get:23 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 g++-5 amd64 5.4.0-6ubuntu1~16.04.12 [8,430 kB]
    azure-arm: Get:24 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 g++ amd64 4:5.3.1-1ubuntu1 [1,504 B]
    azure-arm: Get:25 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 make amd64 4.1-6 [151 kB]
    azure-arm: Get:26 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libdpkg-perl all 1.18.4ubuntu1.6 [195 kB]
    azure-arm: Get:27 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 dpkg-dev all 1.18.4ubuntu1.6 [584 kB]
    azure-arm: Get:28 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 build-essential amd64 12.1ubuntu2 [4,758 B]
    azure-arm: Get:29 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 libfakeroot amd64 1.20.2-1ubuntu1 [25.5 kB]
    azure-arm: Get:30 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 fakeroot amd64 1.20.2-1ubuntu1 [61.8 kB]
    azure-arm: Get:31 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 libalgorithm-diff-perl all 1.19.03-1 [47.6 kB]
    azure-arm: Get:32 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 libalgorithm-diff-xs-perl amd64 0.04-4build1 [11.0 kB]
    azure-arm: Get:33 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 libalgorithm-merge-perl all 0.08-3 [12.0 kB]
    azure-arm: Get:34 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libexpat1-dev amd64 2.1.0-7ubuntu0.16.04.5 [115 kB]
    azure-arm: Get:35 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 libfile-fcntllock-perl amd64 0.22-3 [32.0 kB]
    azure-arm: Get:36 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libpython2.7-dev amd64 2.7.12-1ubuntu0~16.04.9 [27.8 MB]
    azure-arm: Get:37 https://packages.microsoft.com/repos/azure-cli wheezy/main amd64 azure-cli all 2.0.60-1~wheezy [88.9 MB]
    azure-arm: Get:38 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libpython-dev amd64 2.7.12-1~16.04 [7,840 B]
    azure-arm: Get:39 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 zlib1g-dev amd64 1:1.2.8.dfsg-2ubuntu4.3 [167 kB]
    azure-arm: Get:40 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libssl-dev amd64 1.0.2g-1ubuntu4.15 [1,344 kB]
    azure-arm: Get:41 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libssl-doc all 1.0.2g-1ubuntu4.15 [1,077 kB]
    azure-arm: Get:42 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 manpages-dev all 4.04-2 [2,048 kB]
    azure-arm: Get:43 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 python2.7-dev amd64 2.7.12-1ubuntu0~16.04.9 [276 kB]
    azure-arm: Get:44 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 python-dev amd64 2.7.12-1~16.04 [1,186 B]
    azure-arm: Get:45 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 libffi-dev amd64 3.2.1-4 [161 kB]
==> azure-arm: debconf: unable to initialize frontend: Dialog
==> azure-arm: debconf: (Dialog frontend will not work on a dumb terminal, an emacs shell buffer, or without a controlling terminal.)
==> azure-arm: debconf: falling back to frontend: Readline
==> azure-arm: debconf: unable to initialize frontend: Readline
==> azure-arm: debconf: (This frontend requires a controlling tty.)
==> azure-arm: debconf: falling back to frontend: Teletype
==> azure-arm: dpkg-preconfigure: unable to re-open stdin:
    azure-arm: Fetched 156 MB in 5s (30.3 MB/s)
    azure-arm: Selecting previously unselected package libmpc3:amd64.
    azure-arm: (Reading database ... 53917 files and directories currently installed.)
    azure-arm: Preparing to unpack .../libmpc3_1.0.3-1_amd64.deb ...
    azure-arm: Unpacking libmpc3:amd64 (1.0.3-1) ...
    azure-arm: Selecting previously unselected package libc-dev-bin.
    azure-arm: Preparing to unpack .../libc-dev-bin_2.23-0ubuntu11_amd64.deb ...
    azure-arm: Unpacking libc-dev-bin (2.23-0ubuntu11) ...
    azure-arm: Selecting previously unselected package linux-libc-dev:amd64.
    azure-arm: Preparing to unpack .../linux-libc-dev_4.4.0-176.206_amd64.deb ...
    azure-arm: Unpacking linux-libc-dev:amd64 (4.4.0-176.206) ...
    azure-arm: Selecting previously unselected package libc6-dev:amd64.
    azure-arm: Preparing to unpack .../libc6-dev_2.23-0ubuntu11_amd64.deb ...
    azure-arm: Unpacking libc6-dev:amd64 (2.23-0ubuntu11) ...
    azure-arm: Selecting previously unselected package libisl15:amd64.
    azure-arm: Preparing to unpack .../libisl15_0.16.1-1_amd64.deb ...
    azure-arm: Unpacking libisl15:amd64 (0.16.1-1) ...
    azure-arm: Selecting previously unselected package cpp-5.
    azure-arm: Preparing to unpack .../cpp-5_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking cpp-5 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package cpp.
    azure-arm: Preparing to unpack .../cpp_4%3a5.3.1-1ubuntu1_amd64.deb ...
    azure-arm: Unpacking cpp (4:5.3.1-1ubuntu1) ...
    azure-arm: Selecting previously unselected package libcc1-0:amd64.
    azure-arm: Preparing to unpack .../libcc1-0_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libcc1-0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package libgomp1:amd64.
    azure-arm: Preparing to unpack .../libgomp1_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libgomp1:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package libitm1:amd64.
    azure-arm: Preparing to unpack .../libitm1_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libitm1:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package libatomic1:amd64.
    azure-arm: Preparing to unpack .../libatomic1_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libatomic1:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package libasan2:amd64.
    azure-arm: Preparing to unpack .../libasan2_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libasan2:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package liblsan0:amd64.
    azure-arm: Preparing to unpack .../liblsan0_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking liblsan0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package libtsan0:amd64.
    azure-arm: Preparing to unpack .../libtsan0_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libtsan0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package libubsan0:amd64.
    azure-arm: Preparing to unpack .../libubsan0_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libubsan0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package libcilkrts5:amd64.
    azure-arm: Preparing to unpack .../libcilkrts5_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libcilkrts5:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package libmpx0:amd64.
    azure-arm: Preparing to unpack .../libmpx0_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libmpx0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package libquadmath0:amd64.
    azure-arm: Preparing to unpack .../libquadmath0_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libquadmath0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package libgcc-5-dev:amd64.
    azure-arm: Preparing to unpack .../libgcc-5-dev_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libgcc-5-dev:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package gcc-5.
    azure-arm: Preparing to unpack .../gcc-5_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking gcc-5 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package gcc.
    azure-arm: Preparing to unpack .../gcc_4%3a5.3.1-1ubuntu1_amd64.deb ...
    azure-arm: Unpacking gcc (4:5.3.1-1ubuntu1) ...
    azure-arm: Selecting previously unselected package libstdc++-5-dev:amd64.
    azure-arm: Preparing to unpack .../libstdc++-5-dev_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking libstdc++-5-dev:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package g++-5.
    azure-arm: Preparing to unpack .../g++-5_5.4.0-6ubuntu1~16.04.12_amd64.deb ...
    azure-arm: Unpacking g++-5 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Selecting previously unselected package g++.
    azure-arm: Preparing to unpack .../g++_4%3a5.3.1-1ubuntu1_amd64.deb ...
    azure-arm: Unpacking g++ (4:5.3.1-1ubuntu1) ...
    azure-arm: Selecting previously unselected package make.
    azure-arm: Preparing to unpack .../archives/make_4.1-6_amd64.deb ...
    azure-arm: Unpacking make (4.1-6) ...
    azure-arm: Selecting previously unselected package libdpkg-perl.
    azure-arm: Preparing to unpack .../libdpkg-perl_1.18.4ubuntu1.6_all.deb ...
    azure-arm: Unpacking libdpkg-perl (1.18.4ubuntu1.6) ...
    azure-arm: Selecting previously unselected package dpkg-dev.
    azure-arm: Preparing to unpack .../dpkg-dev_1.18.4ubuntu1.6_all.deb ...
    azure-arm: Unpacking dpkg-dev (1.18.4ubuntu1.6) ...
    azure-arm: Selecting previously unselected package build-essential.
    azure-arm: Preparing to unpack .../build-essential_12.1ubuntu2_amd64.deb ...
    azure-arm: Unpacking build-essential (12.1ubuntu2) ...
    azure-arm: Selecting previously unselected package libfakeroot:amd64.
    azure-arm: Preparing to unpack .../libfakeroot_1.20.2-1ubuntu1_amd64.deb ...
    azure-arm: Unpacking libfakeroot:amd64 (1.20.2-1ubuntu1) ...
    azure-arm: Selecting previously unselected package fakeroot.
    azure-arm: Preparing to unpack .../fakeroot_1.20.2-1ubuntu1_amd64.deb ...
    azure-arm: Unpacking fakeroot (1.20.2-1ubuntu1) ...
    azure-arm: Selecting previously unselected package libalgorithm-diff-perl.
    azure-arm: Preparing to unpack .../libalgorithm-diff-perl_1.19.03-1_all.deb ...
    azure-arm: Unpacking libalgorithm-diff-perl (1.19.03-1) ...
    azure-arm: Selecting previously unselected package libalgorithm-diff-xs-perl.
    azure-arm: Preparing to unpack .../libalgorithm-diff-xs-perl_0.04-4build1_amd64.deb ...
    azure-arm: Unpacking libalgorithm-diff-xs-perl (0.04-4build1) ...
    azure-arm: Selecting previously unselected package libalgorithm-merge-perl.
    azure-arm: Preparing to unpack .../libalgorithm-merge-perl_0.08-3_all.deb ...
    azure-arm: Unpacking libalgorithm-merge-perl (0.08-3) ...
    azure-arm: Selecting previously unselected package libexpat1-dev:amd64.
    azure-arm: Preparing to unpack .../libexpat1-dev_2.1.0-7ubuntu0.16.04.5_amd64.deb ...
    azure-arm: Unpacking libexpat1-dev:amd64 (2.1.0-7ubuntu0.16.04.5) ...
    azure-arm: Selecting previously unselected package libfile-fcntllock-perl.
    azure-arm: Preparing to unpack .../libfile-fcntllock-perl_0.22-3_amd64.deb ...
    azure-arm: Unpacking libfile-fcntllock-perl (0.22-3) ...
    azure-arm: Selecting previously unselected package libpython2.7-dev:amd64.
    azure-arm: Preparing to unpack .../libpython2.7-dev_2.7.12-1ubuntu0~16.04.9_amd64.deb ...
    azure-arm: Unpacking libpython2.7-dev:amd64 (2.7.12-1ubuntu0~16.04.9) ...
    azure-arm: Selecting previously unselected package libpython-dev:amd64.
    azure-arm: Preparing to unpack .../libpython-dev_2.7.12-1~16.04_amd64.deb ...
    azure-arm: Unpacking libpython-dev:amd64 (2.7.12-1~16.04) ...
    azure-arm: Selecting previously unselected package zlib1g-dev:amd64.
    azure-arm: Preparing to unpack .../zlib1g-dev_1%3a1.2.8.dfsg-2ubuntu4.3_amd64.deb ...
    azure-arm: Unpacking zlib1g-dev:amd64 (1:1.2.8.dfsg-2ubuntu4.3) ...
    azure-arm: Selecting previously unselected package libssl-dev:amd64.
    azure-arm: Preparing to unpack .../libssl-dev_1.0.2g-1ubuntu4.15_amd64.deb ...
    azure-arm: Unpacking libssl-dev:amd64 (1.0.2g-1ubuntu4.15) ...
    azure-arm: Selecting previously unselected package libssl-doc.
    azure-arm: Preparing to unpack .../libssl-doc_1.0.2g-1ubuntu4.15_all.deb ...
    azure-arm: Unpacking libssl-doc (1.0.2g-1ubuntu4.15) ...
    azure-arm: Selecting previously unselected package manpages-dev.
    azure-arm: Preparing to unpack .../manpages-dev_4.04-2_all.deb ...
    azure-arm: Unpacking manpages-dev (4.04-2) ...
    azure-arm: Selecting previously unselected package python2.7-dev.
    azure-arm: Preparing to unpack .../python2.7-dev_2.7.12-1ubuntu0~16.04.9_amd64.deb ...
    azure-arm: Unpacking python2.7-dev (2.7.12-1ubuntu0~16.04.9) ...
    azure-arm: Selecting previously unselected package python-dev.
    azure-arm: Preparing to unpack .../python-dev_2.7.12-1~16.04_amd64.deb ...
    azure-arm: Unpacking python-dev (2.7.12-1~16.04) ...
    azure-arm: Selecting previously unselected package azure-cli.
    azure-arm: Preparing to unpack .../azure-cli_2.0.60-1~wheezy_all.deb ...
    azure-arm: Unpacking azure-cli (2.0.60-1~wheezy) ...
    azure-arm: Selecting previously unselected package libffi-dev:amd64.
    azure-arm: Preparing to unpack .../libffi-dev_3.2.1-4_amd64.deb ...
    azure-arm: Unpacking libffi-dev:amd64 (3.2.1-4) ...
    azure-arm: Processing triggers for man-db (2.7.5-1) ...
    azure-arm: Processing triggers for libc-bin (2.23-0ubuntu11) ...
    azure-arm: Processing triggers for install-info (6.1.0.dfsg.1-5) ...
    azure-arm: Setting up libmpc3:amd64 (1.0.3-1) ...
    azure-arm: Setting up libc-dev-bin (2.23-0ubuntu11) ...
    azure-arm: Setting up linux-libc-dev:amd64 (4.4.0-176.206) ...
    azure-arm: Setting up libc6-dev:amd64 (2.23-0ubuntu11) ...
    azure-arm: Setting up libisl15:amd64 (0.16.1-1) ...
    azure-arm: Setting up cpp-5 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up cpp (4:5.3.1-1ubuntu1) ...
    azure-arm: Setting up libcc1-0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up libgomp1:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up libitm1:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up libatomic1:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up libasan2:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up liblsan0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up libtsan0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up libubsan0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up libcilkrts5:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up libmpx0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up libquadmath0:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up libgcc-5-dev:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up gcc-5 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up gcc (4:5.3.1-1ubuntu1) ...
    azure-arm: Setting up libstdc++-5-dev:amd64 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up g++-5 (5.4.0-6ubuntu1~16.04.12) ...
    azure-arm: Setting up g++ (4:5.3.1-1ubuntu1) ...
    azure-arm: update-alternatives: using /usr/bin/g++ to provide /usr/bin/c++ (c++) in auto mode
    azure-arm: Setting up make (4.1-6) ...
    azure-arm: Setting up libdpkg-perl (1.18.4ubuntu1.6) ...
    azure-arm: Setting up dpkg-dev (1.18.4ubuntu1.6) ...
    azure-arm: Setting up build-essential (12.1ubuntu2) ...
    azure-arm: Setting up libfakeroot:amd64 (1.20.2-1ubuntu1) ...
    azure-arm: Setting up fakeroot (1.20.2-1ubuntu1) ...
    azure-arm: update-alternatives: using /usr/bin/fakeroot-sysv to provide /usr/bin/fakeroot (fakeroot) in auto mode
    azure-arm: Setting up libalgorithm-diff-perl (1.19.03-1) ...
    azure-arm: Setting up libalgorithm-diff-xs-perl (0.04-4build1) ...
    azure-arm: Setting up libalgorithm-merge-perl (0.08-3) ...
    azure-arm: Setting up libexpat1-dev:amd64 (2.1.0-7ubuntu0.16.04.5) ...
    azure-arm: Setting up libfile-fcntllock-perl (0.22-3) ...
    azure-arm: Setting up libpython2.7-dev:amd64 (2.7.12-1ubuntu0~16.04.9) ...
    azure-arm: Setting up libpython-dev:amd64 (2.7.12-1~16.04) ...
    azure-arm: Setting up zlib1g-dev:amd64 (1:1.2.8.dfsg-2ubuntu4.3) ...
    azure-arm: Setting up libssl-dev:amd64 (1.0.2g-1ubuntu4.15) ...
    azure-arm: Setting up libssl-doc (1.0.2g-1ubuntu4.15) ...
    azure-arm: Setting up manpages-dev (4.04-2) ...
    azure-arm: Setting up python2.7-dev (2.7.12-1ubuntu0~16.04.9) ...
    azure-arm: Setting up python-dev (2.7.12-1~16.04) ...
    azure-arm: Setting up azure-cli (2.0.60-1~wheezy) ...
    azure-arm: Setting up libffi-dev:amd64 (3.2.1-4) ...
    azure-arm: Processing triggers for libc-bin (2.23-0ubuntu11) ...
    azure-arm: Reading package lists...
    azure-arm: Building dependency tree...
    azure-arm: Reading state information...
    azure-arm: Calculating upgrade...
    azure-arm: The following package was automatically installed and is no longer required:
    azure-arm:   grub-pc-bin
    azure-arm: Use 'sudo apt autoremove' to remove it.
    azure-arm: The following packages have been kept back:
    azure-arm:   linux-azure linux-cloud-tools-azure linux-headers-azure linux-image-azure
    azure-arm:   linux-tools-azure
    azure-arm: The following packages will be upgraded:
    azure-arm:   apport libglib2.0-0 libglib2.0-data libicu55 linux-base python3-apport
    azure-arm:   python3-problem-report sosreport vim vim-common vim-runtime vim-tiny
    azure-arm: 12 upgraded, 0 newly installed, 0 to remove and 5 not upgraded.
    azure-arm: Need to get 16.1 MB of archives.
    azure-arm: After this operation, 219 kB of additional disk space will be used.
    azure-arm: Get:1 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libglib2.0-0 amd64 2.48.2-0ubuntu4.6 [1,120 kB]
    azure-arm: Get:2 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 linux-base all 4.5ubuntu1.1~16.04.1 [18.1 kB]
    azure-arm: Get:3 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 vim amd64 2:7.4.1689-3ubuntu1.4 [1,036 kB]
    azure-arm: Get:4 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 vim-tiny amd64 2:7.4.1689-3ubuntu1.4 [446 kB]
    azure-arm: Get:5 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 vim-runtime all 2:7.4.1689-3ubuntu1.4 [5,169 kB]
    azure-arm: Get:6 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 vim-common amd64 2:7.4.1689-3ubuntu1.4 [103 kB]
    azure-arm: Get:7 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libglib2.0-data all 2.48.2-0ubuntu4.6 [131 kB]
    azure-arm: Get:8 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 libicu55 amd64 55.1-7ubuntu0.5 [7,650 kB]
    azure-arm: Get:9 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 python3-problem-report all 2.20.1-0ubuntu2.22 [10.5 kB]
    azure-arm: Get:10 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 python3-apport all 2.20.1-0ubuntu2.22 [80.0 kB]
    azure-arm: Get:11 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 apport all 2.20.1-0ubuntu2.22 [121 kB]
    azure-arm: Get:12 http://azure.archive.ubuntu.com/ubuntu xenial-updates/main amd64 sosreport amd64 3.9-1ubuntu0.16.04.1 [168 kB]
    azure-arm: Preconfiguring packages ...
    azure-arm: Fetched 16.1 MB in 0s (79.8 MB/s)
    azure-arm: (Reading database ... 118448 files and directories currently installed.)
    azure-arm: Preparing to unpack .../libglib2.0-0_2.48.2-0ubuntu4.6_amd64.deb ...
    azure-arm: Unpacking libglib2.0-0:amd64 (2.48.2-0ubuntu4.6) over (2.48.2-0ubuntu4.4) ...
    azure-arm: Preparing to unpack .../linux-base_4.5ubuntu1.1~16.04.1_all.deb ...
    azure-arm: Unpacking linux-base (4.5ubuntu1.1~16.04.1) over (4.5ubuntu1~16.04.1) ...
    azure-arm: Preparing to unpack .../vim_2%3a7.4.1689-3ubuntu1.4_amd64.deb ...
    azure-arm: Unpacking vim (2:7.4.1689-3ubuntu1.4) over (2:7.4.1689-3ubuntu1.3) ...
    azure-arm: Preparing to unpack .../vim-tiny_2%3a7.4.1689-3ubuntu1.4_amd64.deb ...
    azure-arm: Unpacking vim-tiny (2:7.4.1689-3ubuntu1.4) over (2:7.4.1689-3ubuntu1.3) ...
    azure-arm: Preparing to unpack .../vim-runtime_2%3a7.4.1689-3ubuntu1.4_all.deb ...
    azure-arm: Unpacking vim-runtime (2:7.4.1689-3ubuntu1.4) over (2:7.4.1689-3ubuntu1.3) ...
    azure-arm: Preparing to unpack .../vim-common_2%3a7.4.1689-3ubuntu1.4_amd64.deb ...
    azure-arm: Unpacking vim-common (2:7.4.1689-3ubuntu1.4) over (2:7.4.1689-3ubuntu1.3) ...
    azure-arm: Preparing to unpack .../libglib2.0-data_2.48.2-0ubuntu4.6_all.deb ...
    azure-arm: Unpacking libglib2.0-data (2.48.2-0ubuntu4.6) over (2.48.2-0ubuntu4.4) ...
    azure-arm: Preparing to unpack .../libicu55_55.1-7ubuntu0.5_amd64.deb ...
    azure-arm: Unpacking libicu55:amd64 (55.1-7ubuntu0.5) over (55.1-7ubuntu0.4) ...
    azure-arm: Preparing to unpack .../python3-problem-report_2.20.1-0ubuntu2.22_all.deb ...
    azure-arm: Unpacking python3-problem-report (2.20.1-0ubuntu2.22) over (2.20.1-0ubuntu2.21) ...
    azure-arm: Preparing to unpack .../python3-apport_2.20.1-0ubuntu2.22_all.deb ...
    azure-arm: Unpacking python3-apport (2.20.1-0ubuntu2.22) over (2.20.1-0ubuntu2.21) ...
    azure-arm: Preparing to unpack .../apport_2.20.1-0ubuntu2.22_all.deb ...
    azure-arm: Unpacking apport (2.20.1-0ubuntu2.22) over (2.20.1-0ubuntu2.21) ...
    azure-arm: Preparing to unpack .../sosreport_3.9-1ubuntu0.16.04.1_amd64.deb ...
    azure-arm: Unpacking sosreport (3.9-1ubuntu0.16.04.1) over (3.6-1ubuntu0.16.04.4) ...
    azure-arm: Processing triggers for libc-bin (2.23-0ubuntu11) ...
    azure-arm: Processing triggers for man-db (2.7.5-1) ...
    azure-arm: Processing triggers for mime-support (3.59ubuntu1) ...
    azure-arm: Processing triggers for ureadahead (0.100.0-19.1) ...
    azure-arm: Processing triggers for systemd (229-4ubuntu21.27) ...
    azure-arm: Setting up libglib2.0-0:amd64 (2.48.2-0ubuntu4.6) ...
    azure-arm: No schema files found: doing nothing.
    azure-arm: Setting up linux-base (4.5ubuntu1.1~16.04.1) ...
    azure-arm: Setting up vim-common (2:7.4.1689-3ubuntu1.4) ...
    azure-arm: Setting up vim-runtime (2:7.4.1689-3ubuntu1.4) ...
    azure-arm: Setting up vim (2:7.4.1689-3ubuntu1.4) ...
    azure-arm: Setting up vim-tiny (2:7.4.1689-3ubuntu1.4) ...
    azure-arm: Setting up libglib2.0-data (2.48.2-0ubuntu4.6) ...
    azure-arm: Setting up libicu55:amd64 (55.1-7ubuntu0.5) ...
    azure-arm: Setting up python3-problem-report (2.20.1-0ubuntu2.22) ...
    azure-arm: Setting up python3-apport (2.20.1-0ubuntu2.22) ...
    azure-arm: Setting up apport (2.20.1-0ubuntu2.22) ...
    azure-arm: Installing new version of config file /etc/init.d/apport ...
    azure-arm: Setting up sosreport (3.9-1ubuntu0.16.04.1) ...
    azure-arm: Installing new version of config file /etc/sos.conf ...
    azure-arm: Processing triggers for libc-bin (2.23-0ubuntu11) ...
    azure-arm: Processing triggers for ureadahead (0.100.0-19.1) ...
    azure-arm: Processing triggers for systemd (229-4ubuntu21.27) ...
==> azure-arm: 2020-03-25 04:15:00 [INFO] [install-consul] Starting Consul install
==> azure-arm: 2020-03-25 04:15:00 [INFO] [install-consul] Installing dependencies
    azure-arm: Hit:1 http://azure.archive.ubuntu.com/ubuntu xenial InRelease
    azure-arm: Hit:2 http://azure.archive.ubuntu.com/ubuntu xenial-updates InRelease
    azure-arm: Hit:3 http://azure.archive.ubuntu.com/ubuntu xenial-backports InRelease
    azure-arm: Hit:4 https://packages.microsoft.com/repos/azure-cli wheezy InRelease
    azure-arm: Hit:5 http://security.ubuntu.com/ubuntu xenial-security InRelease
    azure-arm: Reading package lists...
    azure-arm: Reading package lists...
    azure-arm: Building dependency tree...
    azure-arm: Reading state information...
    azure-arm: curl is already the newest version (7.47.0-1ubuntu2.14).
    azure-arm: azure-cli is already the newest version (2.0.60-1~wheezy).
    azure-arm: The following package was automatically installed and is no longer required:
    azure-arm:   grub-pc-bin
    azure-arm: Use 'sudo apt autoremove' to remove it.
    azure-arm: The following additional packages will be installed:
    azure-arm:   libonig2
    azure-arm: Suggested packages:
    azure-arm:   zip
    azure-arm: The following NEW packages will be installed:
    azure-arm:   jq libonig2 unzip
    azure-arm: 0 upgraded, 3 newly installed, 0 to remove and 5 not upgraded.
    azure-arm: Need to get 389 kB of archives.
    azure-arm: After this operation, 1,327 kB of additional disk space will be used.
    azure-arm: Get:1 http://azure.archive.ubuntu.com/ubuntu xenial-updates/universe amd64 libonig2 amd64 5.9.6-1ubuntu0.1 [86.7 kB]
    azure-arm: Get:2 http://azure.archive.ubuntu.com/ubuntu xenial-updates/universe amd64 jq amd64 1.5+dfsg-1ubuntu0.1 [144 kB]
    azure-arm: Get:3 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 unzip amd64 6.0-20ubuntu1 [158 kB]
==> azure-arm: debconf: unable to initialize frontend: Dialog
==> azure-arm: debconf: (Dialog frontend will not work on a dumb terminal, an emacs shell buffer, or without a controlling terminal.)
==> azure-arm: debconf: falling back to frontend: Readline
==> azure-arm: debconf: unable to initialize frontend: Readline
==> azure-arm: debconf: (This frontend requires a controlling tty.)
==> azure-arm: debconf: falling back to frontend: Teletype
==> azure-arm: dpkg-preconfigure: unable to re-open stdin:
    azure-arm: Fetched 389 kB in 0s (17.2 MB/s)
    azure-arm: Selecting previously unselected package libonig2:amd64.
    azure-arm: (Reading database ... 118476 files and directories currently installed.)
    azure-arm: Preparing to unpack .../libonig2_5.9.6-1ubuntu0.1_amd64.deb ...
    azure-arm: Unpacking libonig2:amd64 (5.9.6-1ubuntu0.1) ...
    azure-arm: Selecting previously unselected package jq.
    azure-arm: Preparing to unpack .../jq_1.5+dfsg-1ubuntu0.1_amd64.deb ...
    azure-arm: Unpacking jq (1.5+dfsg-1ubuntu0.1) ...
    azure-arm: Selecting previously unselected package unzip.
    azure-arm: Preparing to unpack .../unzip_6.0-20ubuntu1_amd64.deb ...
    azure-arm: Unpacking unzip (6.0-20ubuntu1) ...
    azure-arm: Processing triggers for libc-bin (2.23-0ubuntu11) ...
    azure-arm: Processing triggers for man-db (2.7.5-1) ...
    azure-arm: Processing triggers for mime-support (3.59ubuntu1) ...
    azure-arm: Setting up libonig2:amd64 (5.9.6-1ubuntu0.1) ...
    azure-arm: Setting up jq (1.5+dfsg-1ubuntu0.1) ...
    azure-arm: Setting up unzip (6.0-20ubuntu1) ...
    azure-arm: Processing triggers for libc-bin (2.23-0ubuntu11) ...
    azure-arm: Reading package lists...
    azure-arm: Building dependency tree...
    azure-arm: Reading state information...
    azure-arm: The following package was automatically installed and is no longer required:
    azure-arm:   grub-pc-bin
    azure-arm: Use 'sudo apt autoremove' to remove it.
    azure-arm: The following additional packages will be installed:
    azure-arm:   python-meld3 python-pkg-resources
    azure-arm: Suggested packages:
    azure-arm:   python-setuptools supervisor-doc
    azure-arm: The following NEW packages will be installed:
    azure-arm:   python-meld3 python-pkg-resources supervisor
    azure-arm: 0 upgraded, 3 newly installed, 0 to remove and 5 not upgraded.
    azure-arm: Need to get 392 kB of archives.
    azure-arm: After this operation, 2,004 kB of additional disk space will be used.
    azure-arm: Get:1 http://azure.archive.ubuntu.com/ubuntu xenial/main amd64 python-pkg-resources all 20.7.0-1 [108 kB]
    azure-arm: Get:2 http://azure.archive.ubuntu.com/ubuntu xenial/universe amd64 python-meld3 all 1.0.2-2 [30.9 kB]
    azure-arm: Get:3 http://azure.archive.ubuntu.com/ubuntu xenial-updates/universe amd64 supervisor all 3.2.0-2ubuntu0.2 [253 kB]
==> azure-arm: debconf: unable to initialize frontend: Dialog
==> azure-arm: debconf: (Dialog frontend will not work on a dumb terminal, an emacs shell buffer, or without a controlling terminal.)
==> azure-arm: debconf: falling back to frontend: Readline
==> azure-arm: debconf: unable to initialize frontend: Readline
==> azure-arm: debconf: (This frontend requires a controlling tty.)
==> azure-arm: debconf: falling back to frontend: Teletype
==> azure-arm: dpkg-preconfigure: unable to re-open stdin:
    azure-arm: Fetched 392 kB in 1s (333 kB/s)
    azure-arm: Selecting previously unselected package python-pkg-resources.
    azure-arm: (Reading database ... 118506 files and directories currently installed.)
    azure-arm: Preparing to unpack .../python-pkg-resources_20.7.0-1_all.deb ...
    azure-arm: Unpacking python-pkg-resources (20.7.0-1) ...
    azure-arm: Selecting previously unselected package python-meld3.
    azure-arm: Preparing to unpack .../python-meld3_1.0.2-2_all.deb ...
    azure-arm: Unpacking python-meld3 (1.0.2-2) ...
    azure-arm: Selecting previously unselected package supervisor.
    azure-arm: Preparing to unpack .../supervisor_3.2.0-2ubuntu0.2_all.deb ...
    azure-arm: Unpacking supervisor (3.2.0-2ubuntu0.2) ...
    azure-arm: Processing triggers for man-db (2.7.5-1) ...
    azure-arm: Processing triggers for ureadahead (0.100.0-19.1) ...
    azure-arm: Processing triggers for systemd (229-4ubuntu21.27) ...
    azure-arm: Setting up python-pkg-resources (20.7.0-1) ...
    azure-arm: Setting up python-meld3 (1.0.2-2) ...
    azure-arm: Setting up supervisor (3.2.0-2ubuntu0.2) ...
    azure-arm: Processing triggers for ureadahead (0.100.0-19.1) ...
    azure-arm: Processing triggers for systemd (229-4ubuntu21.27) ...
==> azure-arm: Synchronizing state of supervisor.service with SysV init with /lib/systemd/systemd-sysv-install...
==> azure-arm: Executing /lib/systemd/systemd-sysv-install enable supervisor
==> azure-arm: 2020-03-25 04:15:11 [INFO] [install-consul] Creating user named consul
==> azure-arm: sent invalidate(passwd) request, exiting
==> azure-arm: sent invalidate(group) request, exiting
==> azure-arm: sent invalidate(passwd) request, exiting
==> azure-arm: sent invalidate(group) request, exiting
==> azure-arm: 2020-03-25 04:15:12 [INFO] [install-consul] Creating install dirs for Consul at /opt/consul
==> azure-arm: 2020-03-25 04:15:12 [INFO] [install-consul] Changing ownership of /opt/consul to consul
==> azure-arm: 2020-03-25 04:15:12 [INFO] [install-consul] Downloading Consul 1.7.2 from https://releases.hashicorp.com/consul/1.7.2/consul_1.7.2_linux_amd64.zip to /tmp/consul_1.7.2_linux_amd64.zip
==> azure-arm:   % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
==> azure-arm:                                  Dload  Upload   Total   Spent    Left  Speed
==> azure-arm: 100 37.8M  100 37.8M    0     0   121M      0 --:--:-- --:--:-- --:--:--  121M
    azure-arm: Archive:  /tmp/consul_1.7.2_linux_amd64.zip
    azure-arm:   inflating: /tmp/consul
==> azure-arm: 2020-03-25 04:15:13 [INFO] [install-consul] Moving Consul binary to /opt/consul/bin/consul
==> azure-arm: 2020-03-25 04:15:13 [INFO] [install-consul] Adding symlink to /opt/consul/bin/consul in /usr/local/bin/consul
==> azure-arm: 2020-03-25 04:15:13 [INFO] [install-consul] Copying Consul run script to /opt/consul/bin/run-consul
==> azure-arm: 2020-03-25 04:15:13 [INFO] [install-consul] Consul install complete!
==> azure-arm: 2020-03-25 04:15:13 [INFO] [install-dnsmasq] Starting Dnsmasq install
==> azure-arm: 2020-03-25 04:15:13 [INFO] [install-dnsmasq] Installing Dnsmasq
    azure-arm: Hit:1 http://azure.archive.ubuntu.com/ubuntu xenial InRelease
    azure-arm: Hit:2 http://azure.archive.ubuntu.com/ubuntu xenial-updates InRelease
    azure-arm: Hit:3 http://azure.archive.ubuntu.com/ubuntu xenial-backports InRelease
    azure-arm: Hit:4 https://packages.microsoft.com/repos/azure-cli wheezy InRelease
    azure-arm: Hit:5 http://security.ubuntu.com/ubuntu xenial-security InRelease
    azure-arm: Reading package lists...
    azure-arm: Reading package lists...
    azure-arm: Building dependency tree...
    azure-arm: Reading state information...
    azure-arm: The following package was automatically installed and is no longer required:
    azure-arm:   grub-pc-bin
    azure-arm: Use 'sudo apt autoremove' to remove it.
    azure-arm: The following NEW packages will be installed:
    azure-arm:   dnsmasq
    azure-arm: 0 upgraded, 1 newly installed, 0 to remove and 5 not upgraded.
    azure-arm: Need to get 16.0 kB of archives.
    azure-arm: After this operation, 71.7 kB of additional disk space will be used.
    azure-arm: Get:1 http://azure.archive.ubuntu.com/ubuntu xenial-updates/universe amd64 dnsmasq all 2.75-1ubuntu0.16.04.5 [16.0 kB]
==> azure-arm: debconf: unable to initialize frontend: Dialog
==> azure-arm: debconf: (Dialog frontend will not work on a dumb terminal, an emacs shell buffer, or without a controlling terminal.)
==> azure-arm: debconf: falling back to frontend: Readline
==> azure-arm: debconf: unable to initialize frontend: Readline
==> azure-arm: debconf: (This frontend requires a controlling tty.)
==> azure-arm: debconf: falling back to frontend: Teletype
==> azure-arm: dpkg-preconfigure: unable to re-open stdin:
    azure-arm: Fetched 16.0 kB in 0s (1,334 kB/s)
    azure-arm: Selecting previously unselected package dnsmasq.
    azure-arm: (Reading database ... 118664 files and directories currently installed.)
    azure-arm: Preparing to unpack .../dnsmasq_2.75-1ubuntu0.16.04.5_all.deb ...
    azure-arm: Unpacking dnsmasq (2.75-1ubuntu0.16.04.5) ...
    azure-arm: Processing triggers for ureadahead (0.100.0-19.1) ...
    azure-arm: Processing triggers for systemd (229-4ubuntu21.27) ...
    azure-arm: Setting up dnsmasq (2.75-1ubuntu0.16.04.5) ...
    azure-arm: Processing triggers for ureadahead (0.100.0-19.1) ...
    azure-arm: Processing triggers for systemd (229-4ubuntu21.27) ...
==> azure-arm: 2020-03-25 04:15:18 [INFO] [install-dnsmasq] Configuring Dnsmasq to forward lookups of the 'consul' domain to 127.0.0.1:8600 in /etc/dnsmasq.d/10-consul
    azure-arm: # Enable forward lookup of the 'consul' domain:
    azure-arm: server=/consul/127.0.0.1#8600
==> azure-arm: 2020-03-25 04:15:18 [INFO] [install-dnsmasq] Dnsmasq install complete!
    azure-arm:
    azure-arm: listen-address=127.0.0.1
    azure-arm: bind-interfaces
    azure-arm: WARNING! The waagent service will be stopped.
    azure-arm: WARNING! Cached DHCP leases will be deleted.
    azure-arm: WARNING! root password will be disabled. You will not be able to login as root.
    azure-arm: WARNING! /etc/resolvconf/resolv.conf.d/tail and /etc/resolvconf/resolv.conf.d/original will be deleted.
    azure-arm: WARNING! packer account and entire home directory will be deleted.
==> azure-arm: Querying the machine's properties ...
==> azure-arm:  -> ResourceGroupName : 'packer-Resource-Group-fmtsv4uco2'
==> azure-arm:  -> ComputeName       : 'pkrvmfmtsv4uco2'
==> azure-arm:  -> Managed OS Disk   : '/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/PACKER-RESOURCE-GROUP-FMTSV4UCO2/providers/Microsoft.Compute/disks/pkrosfmtsv4uco2'
==> azure-arm: Querying the machine's additional disks properties ...
==> azure-arm:  -> ResourceGroupName : 'packer-Resource-Group-fmtsv4uco2'
==> azure-arm:  -> ComputeName       : 'pkrvmfmtsv4uco2'
==> azure-arm: Powering off machine ...
==> azure-arm:  -> ResourceGroupName : 'packer-Resource-Group-fmtsv4uco2'
==> azure-arm:  -> ComputeName       : 'pkrvmfmtsv4uco2'
==> azure-arm: Capturing image ...
==> azure-arm:  -> Compute ResourceGroupName : 'packer-Resource-Group-fmtsv4uco2'
==> azure-arm:  -> Compute Name              : 'pkrvmfmtsv4uco2'
==> azure-arm:  -> Compute Location          : 'japaneast'
==> azure-arm:  -> Image ResourceGroupName   : 'consul'
==> azure-arm:  -> Image Name                : 'consul-ubuntu-2020-03-25-040954'
==> azure-arm:  -> Image Location            : 'japaneast'
==> azure-arm: Deleting resource group ...
==> azure-arm:  -> ResourceGroupName : 'packer-Resource-Group-fmtsv4uco2'
==> azure-arm: 
==> azure-arm: The resource group was created by Packer, deleting ...
==> azure-arm: Deleting the temporary OS disk ...
==> azure-arm:  -> OS Disk : skipping, managed disk was used...
==> azure-arm: Deleting the temporary Additional disk ...
==> azure-arm:  -> Additional Disk : skipping, managed disk was used...
==> azure-arm: Removing the created Deployment object: 'pkrdpfmtsv4uco2'
==> azure-arm: ERROR: -> ResourceGroupNotFound : Resource group 'packer-Resource-Group-fmtsv4uco2' could not be found.
==> azure-arm:
Build 'azure-arm' finished.

==> Builds finished. The artifacts of successful builds are:
--> azure-arm: Azure.ResourceManagement.VMImage:

OSType: Linux
ManagedImageResourceGroupName: consul
ManagedImageName: consul-ubuntu-2020-03-25-040954
ManagedImageId: /subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Compute/images/consul-ubuntu-2020-03-25-040954
ManagedImageLocation: japaneast


查看生成的image文件：
[r-user@test-vm ~]$ az image show --resource-group consul --name consul-ubuntu-2020-03-23-034216
{
  "hyperVgeneration": "V1",
  "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Compute/images/consul-ubuntu-2020-03-23-034216",    
  "location": "japaneast",
  "name": "consul-ubuntu-2020-03-23-034216",
  "provisioningState": "Succeeded",
  "resourceGroup": "consul",
  "sourceVirtualMachine": {
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/packer-Resource-Group-7unjzqbx3r/providers/Microsoft.Compute/virtualMachines/pkrvm7unjzqbx3r",
    "resourceGroup": "packer-Resource-Group-7unjzqbx3r"
  },
  "storageProfile": {
    "dataDisks": [],
    "osDisk": {
      "blobUri": null,
      "caching": "ReadWrite",
      "diskEncryptionSet": null,
      "diskSizeGb": 30,
      "managedDisk": {
        "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/PACKER-RESOURCE-GROUP-7UNJZQBX3R/providers/Microsoft.Compute/disks/pkros7unjzqbx3r",
        "resourceGroup": "PACKER-RESOURCE-GROUP-7UNJZQBX3R"
      },
      "osState": "Generalized",
      "osType": "Linux",
      "snapshot": null,
      "storageAccountType": "Standard_LRS"
    },
    "zoneResilient": false
  },
  "tags": null,
  "type": "Microsoft.Compute/images"
}


[r-user@test-vm ~]$ az image list
[
  {
    "hyperVgeneration": "V1",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/CONSUL/providers/Microsoft.Compute/images/consul-ubuntu-2020-03-23-034216",
    "location": "japaneast",
    "name": "consul-ubuntu-2020-03-23-034216",
    "provisioningState": "Succeeded",
    "resourceGroup": "CONSUL",
    "sourceVirtualMachine": {
      "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/packer-Resource-Group-7unjzqbx3r/providers/Microsoft.Compute/virtualMachines/pkrvm7unjzqbx3r",
      "resourceGroup": "packer-Resource-Group-7unjzqbx3r"
    },
    "storageProfile": {
      "dataDisks": [],
      "osDisk": {
        "blobUri": null,
        "caching": "ReadWrite",
        "diskEncryptionSet": null,
        "diskSizeGb": 30,
        "managedDisk": {
          "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/PACKER-RESOURCE-GROUP-7UNJZQBX3R/providers/Microsoft.Compute/disks/pkros7unjzqbx3r",
          "resourceGroup": "PACKER-RESOURCE-GROUP-7UNJZQBX3R"
        },
        "osState": "Generalized",
        "osType": "Linux",
        "snapshot": null,
        "storageAccountType": "Standard_LRS"
      },
      "zoneResilient": false
    },
    "tags": null,
    "type": "Microsoft.Compute/images"
  },
  {
    "hyperVgeneration": "V1",
    "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/CONSUL/providers/Microsoft.Compute/images/consul-ubuntu-2020-03-25-040954",
    "location": "japaneast",
    "name": "consul-ubuntu-2020-03-25-040954",
    "provisioningState": "Succeeded",
    "resourceGroup": "CONSUL",
    "sourceVirtualMachine": {
      "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/packer-Resource-Group-fmtsv4uco2/providers/Microsoft.Compute/virtualMachines/pkrvmfmtsv4uco2",
      "resourceGroup": "packer-Resource-Group-fmtsv4uco2"
    },
    "storageProfile": {
      "dataDisks": [],
      "osDisk": {
        "blobUri": null,
        "caching": "ReadWrite",
        "diskEncryptionSet": null,
        "diskSizeGb": 30,
        "managedDisk": {
          "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/PACKER-RESOURCE-GROUP-FMTSV4UCO2/providers/Microsoft.Compute/disks/pkrosfmtsv4uco2",
          "resourceGroup": "PACKER-RESOURCE-GROUP-FMTSV4UCO2"
        },
        "osState": "Generalized",
        "osType": "Linux",
        "snapshot": null,
        "storageAccountType": "Standard_LRS"
      },
      "zoneResilient": false
    },
    "tags": {
      "dept": "Engineering",
      "task": "Image deployment"
    },
    "type": "Microsoft.Compute/images"
  }
]


缺省的Standard_DS1_v2无法使用？？image会锁定VM的size吗？还是免费订阅的问题？先使用同样的size吧。

az vm create \
    --resource-group consul \
    --name myVM \
    --image consul-ubuntu-2020-03-23-034216 \
    --admin-username azureuser \
    --generate-ssh-keys \
    --size Standard_F2s_v2

[r-user@test-vm ~]$ az vm create \
>     --resource-group consul \
>     --name myVM \
>     --image consul-ubuntu-2020-03-23-034216 \
>     --admin-username azureuser \
>     --generate-ssh-keys \
>     --size Standard_F2s_v2
{
  "fqdns": "",
  "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Compute/virtualMachines/myVM",
  "location": "japaneast",
  "macAddress": "00-0D-3A-51-EB-DA",
  "powerState": "VM running",
  "privateIpAddress": "10.0.0.4",
  "publicIpAddress": "13.78.63.43",
  "resourceGroup": "consul",
  "zones": ""
}


[r-user@test-vm ~]$ az vm open-port --resource-group consul --name myVM --port 80
{
  "defaultSecurityRules": [
    {
      "access": "Allow",
      "description": "Allow inbound traffic from all VMs in VNET",
      "destinationAddressPrefix": "VirtualNetwork",
      "destinationAddressPrefixes": [],
      "destinationApplicationSecurityGroups": null,
      "destinationPortRange": "*",
      "destinationPortRanges": [],
      "direction": "Inbound",
      "etag": "W/\"ead746e0-88d7-4b27-994c-6506269e0fce\"",
      "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Network/networkSecurityGroups/myVMNSG/defaultSecurityRules/AllowVnetInBound",
      "name": "AllowVnetInBound",
      "priority": 65000,
      "protocol": "*",
      "provisioningState": "Succeeded",
      "resourceGroup": "consul",
      "sourceAddressPrefix": "VirtualNetwork",
      "sourceAddressPrefixes": [],
      "sourceApplicationSecurityGroups": null,
      "sourcePortRange": "*",
      "sourcePortRanges": [],
      "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
    },
    {
      "access": "Allow",
      "description": "Allow inbound traffic from azure load balancer",
      "destinationAddressPrefix": "*",
      "destinationAddressPrefixes": [],
      "destinationApplicationSecurityGroups": null,
      "destinationPortRange": "*",
      "destinationPortRanges": [],
      "direction": "Inbound",
      "etag": "W/\"ead746e0-88d7-4b27-994c-6506269e0fce\"",
      "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Network/networkSecurityGroups/myVMNSG/defaultSecurityRules/AllowAzureLoadBalancerInBound",        
      "name": "AllowAzureLoadBalancerInBound",
      "priority": 65001,
      "protocol": "*",
      "provisioningState": "Succeeded",
      "resourceGroup": "consul",
      "sourceAddressPrefix": "AzureLoadBalancer",
      "sourceAddressPrefixes": [],
      "sourceApplicationSecurityGroups": null,
      "sourcePortRange": "*",
      "sourcePortRanges": [],
      "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
    },
    {
      "access": "Deny",
      "description": "Deny all inbound traffic",
      "destinationAddressPrefix": "*",
      "destinationAddressPrefixes": [],
      "destinationApplicationSecurityGroups": null,
      "destinationPortRange": "*",
      "destinationPortRanges": [],
      "direction": "Inbound",
      "etag": "W/\"ead746e0-88d7-4b27-994c-6506269e0fce\"",
      "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Network/networkSecurityGroups/myVMNSG/defaultSecurityRules/DenyAllInBound",
      "name": "DenyAllInBound",
      "priority": 65500,
      "protocol": "*",
      "provisioningState": "Succeeded",
      "resourceGroup": "consul",
      "sourceAddressPrefix": "*",
      "sourceAddressPrefixes": [],
      "sourceApplicationSecurityGroups": null,
      "sourcePortRange": "*",
      "sourcePortRanges": [],
      "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
    },
    {
      "access": "Allow",
      "description": "Allow outbound traffic from all VMs to all VMs in VNET",
      "destinationAddressPrefix": "VirtualNetwork",
      "destinationAddressPrefixes": [],
      "destinationApplicationSecurityGroups": null,
      "destinationPortRange": "*",
      "destinationPortRanges": [],
      "direction": "Outbound",
      "etag": "W/\"ead746e0-88d7-4b27-994c-6506269e0fce\"",
      "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Network/networkSecurityGroups/myVMNSG/defaultSecurityRules/AllowVnetOutBound",
      "name": "AllowVnetOutBound",
      "priority": 65000,
      "protocol": "*",
      "provisioningState": "Succeeded",
      "resourceGroup": "consul",
      "sourceAddressPrefix": "VirtualNetwork",
      "sourceAddressPrefixes": [],
      "sourceApplicationSecurityGroups": null,
      "sourcePortRange": "*",
      "sourcePortRanges": [],
      "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
    },
    {
      "access": "Allow",
      "description": "Allow outbound traffic from all VMs to Internet",
      "destinationAddressPrefix": "Internet",
      "destinationAddressPrefixes": [],
      "destinationApplicationSecurityGroups": null,
      "destinationPortRange": "*",
      "destinationPortRanges": [],
      "direction": "Outbound",
      "etag": "W/\"ead746e0-88d7-4b27-994c-6506269e0fce\"",
      "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Network/networkSecurityGroups/myVMNSG/defaultSecurityRules/AllowInternetOutBound",
      "name": "AllowInternetOutBound",
      "priority": 65001,
      "protocol": "*",
      "provisioningState": "Succeeded",
      "resourceGroup": "consul",
      "sourceAddressPrefix": "*",
      "sourceAddressPrefixes": [],
      "sourceApplicationSecurityGroups": null,
      "sourcePortRange": "*",
      "sourcePortRanges": [],
      "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
    },
    {
      "access": "Deny",
      "description": "Deny all outbound traffic",
      "destinationAddressPrefix": "*",
      "destinationAddressPrefixes": [],
      "destinationApplicationSecurityGroups": null,
      "destinationPortRange": "*",
      "destinationPortRanges": [],
      "direction": "Outbound",
      "etag": "W/\"ead746e0-88d7-4b27-994c-6506269e0fce\"",
      "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Network/networkSecurityGroups/myVMNSG/defaultSecurityRules/DenyAllOutBound",
      "name": "DenyAllOutBound",
      "priority": 65500,
      "protocol": "*",
      "provisioningState": "Succeeded",
      "resourceGroup": "consul",
      "sourceAddressPrefix": "*",
      "sourceAddressPrefixes": [],
      "sourceApplicationSecurityGroups": null,
      "sourcePortRange": "*",
      "sourcePortRanges": [],
      "type": "Microsoft.Network/networkSecurityGroups/defaultSecurityRules"
    }
  ],
  "etag": "W/\"ead746e0-88d7-4b27-994c-6506269e0fce\"",
  "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Network/networkSecurityGroups/myVMNSG",
  "location": "japaneast",
  "name": "myVMNSG",
  "networkInterfaces": [
    {
      "dnsSettings": null,
      "enableAcceleratedNetworking": null,
      "enableIpForwarding": null,
      "etag": null,
      "hostedWorkloads": null,
      "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Network/networkInterfaces/myVMVMNic",
      "ipConfigurations": null,
      "location": null,
      "macAddress": null,
      "name": null,
      "networkSecurityGroup": null,
      "primary": null,
      "privateEndpoint": null,
      "provisioningState": null,
      "resourceGroup": "consul",
      "resourceGuid": null,
      "tags": null,
      "tapConfigurations": null,
      "type": null,
      "virtualMachine": null
    }
  ],
  "provisioningState": "Succeeded",
  "resourceGroup": "consul",
  "resourceGuid": "cdf2a5e6-0c20-4564-8e96-6caf2531b05d",
  "securityRules": [
    {
      "access": "Allow",
      "description": null,
      "destinationAddressPrefix": "*",
      "destinationAddressPrefixes": [],
      "destinationApplicationSecurityGroups": null,
      "destinationPortRange": "22",
      "destinationPortRanges": [],
      "direction": "Inbound",
      "etag": "W/\"ead746e0-88d7-4b27-994c-6506269e0fce\"",
      "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Network/networkSecurityGroups/myVMNSG/securityRules/default-allow-ssh",
      "name": "default-allow-ssh",
      "priority": 1000,
      "protocol": "Tcp",
      "provisioningState": "Succeeded",
      "resourceGroup": "consul",
      "sourceAddressPrefix": "*",
      "sourceAddressPrefixes": [],
      "sourceApplicationSecurityGroups": null,
      "sourcePortRange": "*",
      "sourcePortRanges": [],
      "type": "Microsoft.Network/networkSecurityGroups/securityRules"
    },
    {
      "access": "Allow",
      "description": null,
      "destinationAddressPrefix": "*",
      "destinationAddressPrefixes": [],
      "destinationApplicationSecurityGroups": null,
      "destinationPortRange": "80",
      "destinationPortRanges": [],
      "direction": "Inbound",
      "etag": "W/\"ead746e0-88d7-4b27-994c-6506269e0fce\"",
      "id": "/subscriptions/6906f1b4-5e2d-4acf-bde6-db6d729ea826/resourceGroups/consul/providers/Microsoft.Network/networkSecurityGroups/myVMNSG/securityRules/open-port-80",
      "name": "open-port-80",
      "priority": 900,
      "protocol": "*",
      "provisioningState": "Succeeded",
      "resourceGroup": "consul",
      "sourceAddressPrefix": "*",
      "sourceAddressPrefixes": [],
      "sourceApplicationSecurityGroups": null,
      "sourcePortRange": "*",
      "sourcePortRanges": [],
      "type": "Microsoft.Network/networkSecurityGroups/securityRules"
    }
  ],
  "subnets": null,
  "tags": {},
  "type": "Microsoft.Network/networkSecurityGroups"
}


[r-user@test-vm ~]$ ssh azureuser@52.156.56.94
Welcome to Ubuntu 16.04.6 LTS (GNU/Linux 4.15.0-1071-azure x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

 * Latest Kubernetes 1.18 beta is now available for your laptop, NUC, cloud
   instance or Raspberry Pi, with automatic updates to the final GA release.

     sudo snap install microk8s --channel=1.18/beta --classic

 * Multipass 1.1 adds proxy support for developers behind enterprise
   firewalls. Rapid prototyping for cloud operations just got easier.

     https://multipass.run/

0 packages can be updated.
0 updates are security updates.


5 updates could not be installed automatically. For more details,
see /var/log/unattended-upgrades/unattended-upgrades.log


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

azureuser@myVM:~$ uname -a
Linux myVM 4.15.0-1071-azure #76-Ubuntu SMP Wed Feb 12 03:02:44 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
azureuser@myVM:~$ consul -v
Consul v1.7.2
Protocol 2 spoken by default, understands 2 to 3 (agent will automatically use protocol >2 when speaking to compatible agents)


UbuntuでGPG（GnuPG）公開鍵登録、認証
azureuser@myVM:~$ gpg --keyserver packages.microsoft.com --recv-keys EB3E94ADBE1229CF
gpg: directory `/home/azureuser/.gnupg' created
gpg: new configuration file `/home/azureuser/.gnupg/gpg.conf' created
gpg: WARNING: options in `/home/azureuser/.gnupg/gpg.conf' are not yet active during this run
gpg: keyring `/home/azureuser/.gnupg/secring.gpg' created
gpg: keyring `/home/azureuser/.gnupg/pubring.gpg' created
gpg: requesting key BE1229CF from hkp server packages.microsoft.com
gpg: /home/azureuser/.gnupg/trustdb.gpg: trustdb created
gpg: key BE1229CF: public key "Microsoft (Release signing) <gpgsecurity@microsoft.com>" imported
gpg: Total number processed: 1
gpg:               imported: 1  (RSA: 1)

azureuser@myVM:~$ sudo apt-key adv --keyserver packages.microsoft.com --recv-keys EB3E94ADBE1229CF
Executing: /tmp/tmp.BOl4N8kmJ4/gpg.1.sh --keyserver
packages.microsoft.com
--recv-keys
EB3E94ADBE1229CF
gpg: requesting key BE1229CF from hkp server packages.microsoft.com
gpg: key BE1229CF: "Microsoft (Release signing) <gpgsecurity@microsoft.com>" not changed
gpg: Total number processed: 1
gpg:              unchanged: 1

azureuser@myVM:~$ apt-key list
/etc/apt/trusted.gpg
--------------------
pub   1024D/437D05B5 2004-09-12
uid                  Ubuntu Archive Automatic Signing Key <ftpmaster@ubuntu.com>
sub   2048g/79164387 2004-09-12

pub   4096R/C0B21F32 2012-05-11
uid                  Ubuntu Archive Automatic Signing Key (2012) <ftpmaster@ubuntu.com>

pub   4096R/EFE21092 2012-05-11
uid                  Ubuntu CD Image Automatic Signing Key (2012) <cdimage@ubuntu.com>

pub   1024D/FBB75451 2004-12-30
uid                  Ubuntu CD Image Automatic Signing Key <cdimage@ubuntu.com>

pub   2048R/BE1229CF 2015-10-28
uid                  Microsoft (Release signing) <gpgsecurity@microsoft.com>










★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★

★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★
★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★★~☆·☆.~*∴*~★*∴ *·∴~*★*∴*★~☆·☆.~*∴*~★



https://www.vaultproject.io/api-docs/system/audit/
https://www.vaultproject.io/api/system/audit-hash.html
https://www.vaultproject.io/api/system/config-auditing.html

Also remind that the config above can be overriden at the mount level (which is what I do, for some non-critical mounts)
https://www.vaultproject.io/api/system/mounts.html#parameters

you can tell Vault to write certain information into the audit log in clear text. For example:
vault write /sys/auth/token/tune audit_non_hmac_request_keys=display_name,policies,type
vault write /sys/auth/token/tune audit_non_hmac_response_keys=error

You can do the same for your authentication provider and then read the audit log for example with jq: grep <client IP|accessor|time|or whatever youre searching for> vault.log | jq . | less -S
Of course you shouldn't unhash everything in the audit log, otherwise you'll end up with secrets written into your log.


???
从另外一台主机执行：
[r-user@test-vm ~]$ VAULT_ADDR="http://172.18.1.104:8200" vault status
Error checking seal status: Get http://172.18.1.104:8200/v1/sys/seal-status: dial tcp 172.18.1.104:8200: i/o timeout
